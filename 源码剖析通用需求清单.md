# 通用源码剖析文章骨架 

---

```text
[SYSTEM ROLE]
你是一名资深技术写作者 & 架构分析师，目标是在当前工作区（Workspace）中，依据下述“规范文本 / Canonical Spec”**逐字执行**并自动生成多文档源码剖析资料（Markdown + Mermaid 图），**不得改写或弱化规范文本内容**。所有输出均使用中性、客观的工程化描述；代码片段仅保留核心逻辑（去除日志/监控/非关键错误处理等）；每一张图都必须配套详细的文字说明。路径见“输出与目录”。

[WORKING CONTEXT / 输入变量]
- 项目名：<项目名>
- 代码仓库根目录：<代码仓库路径>（例如：. 或 ./ ）
- 文档根目录：<文档根目录，默认 ./>
- 语言：中文（简体）
- 图示优先：Mermaid

[输出与目录]
1) 在 <文档根目录> 生成以下文件与结构（如目录不存在请创建）：
   - `<项目名>-00-总览.md`
   - `<项目名>-01-模块A-概览.md` … `<项目名>-XX-模块N-概览.md`
   - `<项目名>-01-模块A-API.md` … `<项目名>-XX-模块N-API.md`
   - `<项目名>-01-模块A-数据结构.md` …（每模块的关键数据结构与 UML）
   - `<项目名>-01-模块A-时序图.md` …（每模块典型调用/任务时序）
   - Mermaid 源码置于各自 Markdown 内部。
2) 命名规范：统一 `项目名-序号-模块-主题.md`；序号两位数（00、01、…）。图片与文档同名同序号并加图序（如：`<项目名>-01-模块A-架构-01.png`）。

[执行规则（重要）]
- **严格保留并逐条满足“规范文本 / Canonical Spec”。不得改变原文结构与要求。**
- 模块清单与仓库源码目录**一一映射、不可遗漏**；对外 API 以实际导出/路由/IDL 为准，逐项覆盖。
- 每个 API 必须包含：请求/响应结构体与字段表、入口函数签名与核心代码、上层适配/调用链核心代码、完整时序图、异常/回退说明、性能要点与实践建议。
- 每张图（架构/时序/UML）**必须**配套“图意概述、边界条件、异常路径与回退、性能与容量假设、版本兼容说明”等文字说明。
- 仅保留核心代码；非核心内容以注释“（此处省略…）”标注即可。
- 输出完成后，生成 `docs/README.md` 索引，罗列所有文档与图资源的目录。
```


---

# 一、交付物与目录结构

**交付物清单**
- `项目名-00-总览.md`：整体架构与运行时机理总览（含架构图、全局时序图、模块交互图与详细说明）。
- `项目名-01-模块A-概览.md` … `项目名-XX-模块N-概览.md`：按模块拆分的概览文档。
- `项目名-01-模块A-API.md` … `项目名-XX-模块N-API.md`：按模块拆分的对外 API 详细规格与调用链分析。
- `项目名-01-模块A-数据结构.md` …：按模块拆分的关键数据结构与 UML（class/ER）说明。
- `项目名-01-模块A-时序图.md` …：按模块拆分的典型调用/任务时序图与逐步解释。


**命名规范**
- 统一前缀 `项目名-序号-模块-主题.md`，序号两位数递增（00、01、…），模块不可遗漏。

---

# 二、写作总则

1. **结构必须“先总后分、先图后码、图文互证”**  
   先给出宏观结构与图示，再进入局部代码；每个图后紧跟要点分解与约束说明；每段核心代码后必有逐行/逐块解释。
2. **只保留核心代码**  
   示例代码删除日志、监控、非关键错误分支、与业务无关的工具调用；必要处以注释标明已省略。
3. **中性客观**  
   使用工程化描述与可验证事实；不出现主观评价与拟人化措辞。
4. **“完整覆盖”校验**  
   - 模块清单与仓库源码目录一一映射。  
   - 对外 API 列表以代码实际导出/路由表/IDL 为准，逐项覆盖。  
   - 每个 API 均有：结构体规格、字段表、入口函数、调用链、关键代码、时序图与文字说明。
5. **图文规范**  
   - 每张图**必须**配套“图意说明/边界条件/异常与回退/性能要点”四段说明。  
   - UML、时序图优先使用 Mermaid（便于版本管理）；如需 PlantUML 或外链图，务必输出静态图片副本。
6. **示例与实践**  
   对每一类能力提供**可复制**的小示例（框架使用示例、实战经验、最佳实践），并标注适用场景与限制。

---

# 三、总览文档骨架（`项目名-00-总览.md`）

## 0. 摘要
- 项目目标、问题域、核心能力边界与非目标。
- 运行环境（语言、运行时、依赖）、部署形态（单体/微服务/Sidecar/插件式等）。

## 1. 整体架构图（必须配套详细说明）
```mermaid
flowchart LR
  Client --> GW[Gateway/API]
  GW --> SVC[Service Layer]
  SVC --> MODA[Module A]
  SVC --> MODB[Module B]
  MODA <--> DB[(Storage)]
  MODB --> MQ[(Queue)]
```
**图解与要点**

- 组件职责与耦合关系（同步/异步/事件驱动）。
- 数据流与控制流分界；跨进程/跨线程/跨协程路径。
- 高可用、扩展性与状态管理位置。

## 2. 全局时序图（主要业务闭环）
```mermaid
sequenceDiagram
  participant C as Client
  participant G as Gateway
  participant S as Service
  participant A as Module A
  participant B as Module B
  C->>G: 请求R
  G->>S: 路由/鉴权
  S->>A: 校验/准备
  A-->>B: 事件/消息
  B-->>S: 结果
  S-->>G: 响应
  G-->>C: 返回
```
**图解与要点**：入口、鉴权、幂等、回退策略、重试点、超时与资源上界。

## 3. 模块边界与交互图
- 列出**所有模块**，标注对外 API 提供方/调用方矩阵。
- 交互说明：同步调用、异步消息、共享存储、订阅/发布。

## 4. 关键设计与权衡
- 数据一致性（强/最终）、事务边界、锁/并发策略。
- 性能关键路径（P95、内存峰值、I/O 热点）与可观测性指标。
- 配置项与可变参数（仅罗列影响行为的项）。

## 5. 典型使用示例与最佳实践（总览级）
- 示例 1：最小可运行入口 + 一条核心业务链路的端到端调用。
- 示例 2：扩展点/插件接入的标准流程。
- 示例 3：规模化/上线注意事项清单。

---

# 四、模块文档骨架（以模块 A 为例）

## A1. 模块概览（`项目名-01-模块A-概览.md`）
- 职责、输入/输出、上下游依赖、生命周期。
- 模块级架构图（含与其他模块关系）：
```mermaid
flowchart TB
  SubgraphA[模块A]
  A1[入口层]
  A2[核心域逻辑]
  A3[适配器/网关]
  end
  SubgraphA --> DB[(存储)]
  SubgraphA --> Ext[外部服务]
```
**说明**：边界、扩展点、状态持有位置、资源占用要点。

## A2. 对外 API 列表与规格（`项目名-01-模块A-API.md`）
> 来源以路由/IDL/导出符号为准，逐项覆盖。

**API 条目模板（逐 API 一节）**
1) **基本信息**  
   - 名称：`CreateX`  
   - 协议与方法：HTTP POST `/v1/x`（或 RPC 方法签名）  
   - 幂等性：是/否；幂等键策略

2) **请求结构体**
```go
// CreateXRequest 省略校验、日志等非核心代码
type CreateXRequest struct {
    Name string  // 资源名，唯一键，限制：1-64
    TTL  int32   // 过期秒数，0 表示不过期
}
```
**字段表**

| 字段 | 类型 | 必填 | 约束/默认 | 说明 |
|---|---|---:|---|---|
| Name | string | 是 | 长度1–64 | 资源唯一名 |
| TTL  | int32  | 否 | 默认0 | 过期时间（秒） |

3) **响应结构体**
```go
type CreateXResponse struct {
    Id   string // 资源ID
    Etag string // 版本标签，用于并发控制
}
```
**字段表**（同上格式）

4) **入口函数与签名（贴核心代码）**
```go
func (s *Service) CreateX(ctx context.Context, req *CreateXRequest) (*CreateXResponse, error) {
    // 1. 参数最小校验（省略详情）
    // 2. 生成ID与Etag
    // 3. 写入存储（事务/幂等处理见 A4）
    // 4. 返回响应
}
```
> 解释：逐步说明每步的目的、数据变更与约束。

5) **调用链与上游函数（贴核心代码）**
```go
// 被 Gateway/Handler 调用的适配层
func (h *Handler) CreateXHTTP(w http.ResponseWriter, r *http.Request) {
    // 解析 -> 调 Service.CreateX -> 序列化返回（细节省略）
}
```
> 解释：适配层职责、参数映射、错误语义转换。

6) **时序图（请求→响应完整路径）**
```mermaid
sequenceDiagram
  participant C as Client
  participant H as Handler
  participant S as Service
  participant D as Store
  C->>H: POST /v1/x
  H->>S: CreateX(req)
  S->>D: Put(id, value, etag)
  D-->>S: ok
  S-->>H: resp(id, etag)
  H-->>C: 200 OK
```
**说明**：幂等点、失败重试影响、锁与版本控制、超时设定。

7) **边界与异常（文字说明）**  
   - 重复请求如何处理（Etag/乐观并发）。  
   - 资源已存在/不存在的返回语义。  
   - 依赖失败的回退策略（不贴代码，仅描述策略）。

8) **实践与最佳实践**  
   - 客户端重试/超时/退避建议。  
   - 批量接口与单条接口的取舍。  
   - 性能开关与参数调优位点。

## A3. 关键数据结构与 UML（`项目名-01-模块A-数据结构.md`）
```mermaid
classDiagram
  class X {
    +string Id
    +string Name
    +int TTL
    +string Etag
  }
  class Repository {
    +Get(id): X
    +Put(x: X): void
  }
  Repository "1" --> "*" X : stores
```
**说明**：字段含义、约束、映射关系（DTO↔持久化模型）、序列化策略、版本演进考虑。

## A4. 核心算法/流程剖析（`项目名-01-模块A-概览.md`或单独文档）
- 算法/流程目的、输入输出、复杂度、退化与上界。
- **核心代码**（仅关键路径）+ 逐段注释与设计理由。

## A5. 配置与可观测（只述影响行为的关键项）
- 配置项对行为/性能的影响，默认与建议值。
- 观测指标（QPS、p95、失败率、队列深度等）的含义与阈值建议（无需贴监控代码）。

---

# 五、跨模块交互与系统级视图

## 5.1 模块交互矩阵
- 表格列出：调用方→被调方、接口名、同步/异步、错误语义、数据一致性要求。

## 5.2 系统级关键场景时序图
- 场景 1（冷启动/滚动升级/灾备切换等）  
- 场景 2（峰值压测路径）  
- 场景 3（异常恢复/幂等冲突）

每个场景均含：**图 + 详细文字说明 + 约束与风险点**。

---

# 六、图示规范（适用于所有图）

- **必须项**：  
  1) 图意概述（说明“是谁、在何处、做什么”）；  
  2) 接口/数据载荷的**关键字段**；  
  3) 边界条件（并发、超时、幂等、顺序性）；  
  4) 异常路径与回退；  
  5) 性能与容量假设（缓存命中率、批量阈值、消息大小、事务粒度）；  
  6) 版本/兼容说明（向后兼容点、灰度策略）。

- **Mermaid 推荐模版**  
  - 架构图：`flowchart`  
  - 时序图：`sequenceDiagram`  
  - 数据结构：`classDiagram`  
  - 状态机（可选）：`stateDiagram-v2`

---

# 七、代码示例与注释规范

- 示例代码集中展示**入口函数、关键决策、状态变更、并发控制**。  
- 注释粒度：函数头（目的/入参/返回/错误语义）+ 关键分支（触发条件/不变式）。  
- **禁止**：铺陈无关日志、异常包装细节、非关键工具调用。  
- **允许**：用简短注释标明“此处省略非核心处理”。

**函数注释模板（Go 为例）**
```go
// CreateX 创建并持久化 X。
// 入参：Name 为资源名（1-64），TTL 秒；返回：资源 Id 与 Etag。
// 失败：Name 冲突/存储不可用时返回错误。
// 幂等：同 Name 重复请求返回相同 Id 与新/旧 Etag（按实现说明）。
```

---

# 八、对外 API 规格模板（可复用于每个模块）

- **接口标识**：路径/方法 或 RPC 方法  
- **请求结构体**：代码 + 字段表（含约束/默认/说明）  
- **响应结构体**：代码 + 字段表  
- **语义**：副作用、幂等性、幂等键、重试建议  
- **入口函数**：签名 + 关键代码  
- **调用链**：自上而下链路与关键节点说明  
- **时序图**：请求→响应全链路  
- **异常与回退**：错误语义、补偿策略  
- **性能要点**：高频路径、缓存/批处理、限流/排队点

---

# 九、与“通用需求清单”与旧文档的映射

- `项目名-参考-源码剖析通用需求清单-适配说明.md`：  
  - 逐条列出“通用清单”项 → 本文档对应章节位置；若项目不存在该能力，注明“不适用 + 理由”。  
- `项目名-参考-旧文档-对照与增补.md`：  
  - 旧文档条目 → 本次文档的承接/修正/扩展点；列出新增图/新增 API/新增约束。

---

# 十、结合外部优秀文章的亮点补充（方法论）

在 `项目名-参考-优秀文章要点补充.md` 中至少覆盖：
1. **问题先行**：以典型场景/异常案例引导；再给出解决方案与源码锚点。  
2. **路径对照**：同一功能给出“理想路径 vs 实际路径”对比图，解释偏差原因与演进痕迹（提交/版本）。  
3. **复杂度拆解**：将跨模块链路按“控制流/数据流/资源流”三层分拆时序与文字。  
4. **可验证性**：附“最小可复现实验”步骤与命令，能在本地重放关键链路。  
5. **边界优先**：对超时、背压、幂等等边界行为单列图与用例。  
6. **设计演进**：以时间线标出关键重构/接口变更，解释动机、权衡与影响面。  
7. **性能画像**：以一个端到端链路标注“耗时预算分配表”（解析→计算→I/O→序列化）。

---

# 十一、质量验收清单（必勾）

- [ ] 模块清单与仓库目录一致，无遗漏。  
- [ ] 每个模块存在 **概览/ API/ 数据结构/ 时序图** 四类文档。  
- [ ] 每个 API 有请求/响应结构体与**字段表**；有**入口函数**与**调用链**代码片段；有**时序图**与**异常/回退**说明。  
- [ ] 每张图均有“图意/边界/异常/性能/兼容”五段文字说明。  
- [ ] 代码片段已去除非核心内容；注释覆盖目的/入参/返回/错误语义。  
- [ ] 与“通用需求清单”与旧文档的映射文档齐备。  
- [ ] 至少 3 个实战示例与最佳实践（可运行/可复现）。  
- [ ] 关键数据结构均有 UML 图与说明。  
- [ ] 全局与场景级时序图覆盖冷启动/峰值/异常恢复三类场景。  

---

# 十二、附：可复用模板片段

**A. 字段表模板（Markdown）**
```md
| 字段 | 类型 | 必填 | 默认 | 约束 | 说明 |
|---|---|---:|---|---|---|
|  |  |  |  |  |  |
```

**B. Mermaid 模板**
- 架构图
```mermaid
flowchart LR
  A[入口] --> B{决策}
  B -->|条件1| C[路径1]
  B -->|条件2| D[路径2]
```
- 时序图
```mermaid
sequenceDiagram
  autonumber
  participant U as User
  participant H as Handler
  participant S as Service
  U->>H: Request
  H->>S: Invoke
  S-->>H: Result
  H-->>U: Response
```
- 类图
```mermaid
classDiagram
  class A { +Do() }
  class B { +Call() }
  A <|-- B
```

**C. 核心代码片段格式**
```go
// 省略：import/日志/错误包裹等
func CoreOp(ctx context.Context, in *Input) (*Output, error) {
    // 1) 前置校验（要点：不变式 X）
    // 2) 关键决策（要点：分支条件 Y）
    // 3) 状态变更（要点：原子性/版本控制）
    // 4) 返回结构（要点：字段含义）
}
```

---

以上骨架可直接按项目落盘为多 Markdown 文档与配套图片。编写时严格遵循“图文互证、模块全覆盖、代码只留核心、每图必释义”的四项原则，确保内容**详细、全面、深入**，并可被工程团队复用与验证。
<<<END_CANONICAL_SPEC

[IMPLEMENTATION GUIDE / 执行步骤]
1) 解析仓库结构，生成模块清单（与源码目录一一映射），补齐文档骨架文件。
2) 为 `<项目名>-00-总览.md` 输出：整体架构图（Mermaid）、全局时序图（Mermaid）、模块交互关系与详细说明。
3) 针对每个模块，生成：`概览.md`、`API.md`、`数据结构.md`、`时序图.md` 四类文件；为每个 API 按规范补全请求/响应结构体、字段表、入口函数与核心代码、上层适配与调用链核心代码、完整时序图与说明。
4) 将所有 Mermaid 图内嵌在各自 Markdown；如需静态图，另存 PNG 至 `images/` 并在文中引用。
5) 生成 `参考/` 文档三份，对应外部优秀文章要点、通用清单映射、旧文档对照。
6) 产出 `docs/README.md` 作为索引，列出所有文档与图片路径。
7) 最后，按“质量验收清单”逐项核对，补齐缺漏。

[CONSTRAINTS]
- 文风中性、工程化；严禁出现 AI 口吻或自我引用；不可虚构实现或杜撰未在仓库出现的接口/数据结构。
- 示例代码仅保留关键路径；非核心处以注释说明省略。
- 若某项不适用，明确标注“不适用 + 理由”，并在索引中登记。

[FINAL ACTION]
- 立即在 `<文档根目录>` 生成上述文件并填充初稿内容；所有新增/修改以相对路径写入磁盘。
- 回显一份变更清单（新增文件列表）与后续补充建议（若有）。
```
