<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bugly ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { font-size: 24px; margin-bottom: 10px; color: #333; }
        h2 { font-size: 18px; margin-bottom: 15px; color: #555; border-left: 4px solid #409eff; padding-left: 10px; }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s;
        }
        button.primary { background: #409eff; color: white; }
        button.success { background: #67c23a; color: white; }
        button.danger { background: #f56c6c; color: white; }
        button.warning { background: #e6a23c; color: white; }
        button:hover { opacity: 0.8; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.success { background: #f0f9ff; color: #0c63e4; }
        .status.error { background: #fef0f0; color: #f56c6c; }
        .status.warning { background: #fdf6ec; color: #e6a23c; }
        .status.info { background: #f4f4f5; color: #606266; }
        pre { background: #f5f7fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .test-result { margin: 10px 0; padding: 10px; border-left: 4px solid #ddd; }
        .test-result.pass { border-color: #67c23a; background: #f0f9ff; }
        .test-result.fail { border-color: #f56c6c; background: #fef0f0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ§ª Bugly ä¿®å¤éªŒè¯æµ‹è¯•</h1>
            <p>æ­¤é¡µé¢ç”¨äºéªŒè¯ 3 ä¸ªå…³é”®é—®é¢˜çš„ä¿®å¤æ˜¯å¦ç”Ÿæ•ˆ</p>
        </div>
        
        <div class="card">
            <h2>ğŸ”´ æµ‹è¯• 1: localStorage å¼‚å¸¸å¤„ç†</h2>
            <p>éªŒè¯å­˜å‚¨æº¢å‡ºæ—¶ä¸å´©æºƒï¼Œèƒ½ä¼˜é›…é™çº§</p>
            <div>
                <button class="primary" onclick="test1_normal()">æµ‹è¯•æ­£å¸¸ä¿å­˜</button>
                <button class="warning" onclick="test1_large()">æµ‹è¯•å¤§é‡æ•°æ®ï¼ˆ1000æ¡ï¼‰</button>
                <button class="danger" onclick="test1_overflow()">æµ‹è¯•å­˜å‚¨æº¢å‡º</button>
                <button class="success" onclick="test1_cleanup()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
            </div>
            <div id="test1Results"></div>
        </div>
        
        <div class="card">
            <h2>ğŸ”´ æµ‹è¯• 2: XSS å®‰å…¨é˜²æŠ¤</h2>
            <p>éªŒè¯æ¶æ„è¾“å…¥è¢«æ­£ç¡®æ‹’ç»</p>
            <div>
                <button class="primary" onclick="test2_script()">æµ‹è¯• &lt;script&gt; æ ‡ç­¾</button>
                <button class="primary" onclick="test2_javascript()">æµ‹è¯• javascript: åè®®</button>
                <button class="primary" onclick="test2_events()">æµ‹è¯•äº‹ä»¶å¤„ç†å™¨</button>
                <button class="primary" onclick="test2_iframe()">æµ‹è¯• &lt;iframe&gt; æ ‡ç­¾</button>
            </div>
            <div id="test2Results"></div>
        </div>
        
        <div class="card">
            <h2>ğŸ”´ æµ‹è¯• 3: äº‹ä»¶ç›‘å¬å™¨æ³„æ¼</h2>
            <p>éªŒè¯äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®ç®¡ç†ï¼Œä¸æ³„æ¼</p>
            <div>
                <button class="primary" onclick="test3_multiple()">æµ‹è¯•å¤šæ¬¡æ‰“å¼€å…³é—­ï¼ˆ20æ¬¡ï¼‰</button>
                <button class="primary" onclick="test3_esc()">æµ‹è¯• ESC é”®ï¼ˆéœ€æ‰‹åŠ¨ï¼‰</button>
                <button class="primary" onclick="test3_click()">æµ‹è¯•ç‚¹å‡»å¤–éƒ¨ï¼ˆéœ€æ‰‹åŠ¨ï¼‰</button>
                <button class="primary" onclick="test3_cleanup()">æµ‹è¯•æ¸…ç†å‡½æ•°</button>
            </div>
            <div id="test3Results"></div>
        </div>
        
        <div class="card">
            <h2>ğŸ“Š ç»¼åˆæµ‹è¯•</h2>
            <div>
                <button class="success" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰è‡ªåŠ¨æµ‹è¯•</button>
                <button class="danger" onclick="clearAllResults()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç»“æœ</button>
            </div>
            <div id="overallResults"></div>
        </div>
        
        <div class="card">
            <h2>ğŸ”— å¿«é€Ÿé“¾æ¥</h2>
            <button class="primary" onclick="window.open('/bugly-dashboard.html', '_blank')">
                ğŸ“Š æ‰“å¼€ Bugly ä»ªè¡¨æ¿
            </button>
            <button class="primary" onclick="window.open('/bugly-test.html', '_blank')">
                ğŸ”§ æ‰“å¼€è¯Šæ–­å·¥å…·
            </button>
        </div>
    </div>
    
    <script>
        // æµ‹è¯•ç»“æœæ”¶é›†
        const testResults = {
            test1: [],
            test2: [],
            test3: []
        };
        
        // å·¥å…·å‡½æ•°ï¼šè®°å½•æµ‹è¯•ç»“æœ
        function logResult(testNumber, testName, passed, message) {
            const result = { testName, passed, message, timestamp: new Date().toLocaleString() };
            testResults[`test${testNumber}`].push(result);
            
            const container = document.getElementById(`test${testNumber}Results`);
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <strong>${passed ? 'âœ… PASS' : 'âŒ FAIL'}: ${testName}</strong><br>
                ${message}<br>
                <small>${result.timestamp}</small>
            `;
            container.appendChild(div);
        }
        
        // ==========================================
        // æµ‹è¯• 1: localStorage å¼‚å¸¸å¤„ç†
        // ==========================================
        
        function test1_normal() {
            try {
                const testData = {
                    type: 'log_info',
                    message: 'æµ‹è¯•æ¶ˆæ¯',
                    timestamp: Date.now()
                };
                
                const existing = JSON.parse(localStorage.getItem('bugly_reports') || '[]');
                existing.push(testData);
                localStorage.setItem('bugly_reports', JSON.stringify(existing.slice(-1000)));
                
                logResult(1, 'æ­£å¸¸ä¿å­˜', true, 'æˆåŠŸä¿å­˜ 1 æ¡æµ‹è¯•æ•°æ®');
            } catch (e) {
                logResult(1, 'æ­£å¸¸ä¿å­˜', false, 'ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }
        
        function test1_large() {
            try {
                const start = Date.now();
                const existing = JSON.parse(localStorage.getItem('bugly_reports') || '[]');
                
                for (let i = 0; i < 1000; i++) {
                    existing.push({
                        type: 'log_info',
                        message: `æµ‹è¯•æ¶ˆæ¯ ${i}`,
                        details: 'x'.repeat(100),
                        timestamp: Date.now()
                    });
                }
                
                const limited = existing.slice(-1000);
                const jsonString = JSON.stringify(limited);
                const sizeInMB = new Blob([jsonString]).size / 1048576;
                
                localStorage.setItem('bugly_reports', jsonString);
                const duration = Date.now() - start;
                
                logResult(1, 'å¤§é‡æ•°æ®ä¿å­˜', true, 
                    `æˆåŠŸä¿å­˜ 1000 æ¡æ•°æ®ï¼Œå¤§å°: ${sizeInMB.toFixed(2)}MBï¼Œè€—æ—¶: ${duration}ms`);
            } catch (e) {
                logResult(1, 'å¤§é‡æ•°æ®ä¿å­˜', false, 'ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }
        
        function test1_overflow() {
            try {
                // å°è¯•å¡«æ»¡ localStorage
                let filled = false;
                for (let i = 0; i < 10000; i++) {
                    try {
                        localStorage.setItem('test_overflow_' + i, 'x'.repeat(10000));
                    } catch (e) {
                        filled = true;
                        break;
                    }
                }
                
                if (!filled) {
                    logResult(1, 'å­˜å‚¨æº¢å‡ºæµ‹è¯•', false, 'æ— æ³•å¡«æ»¡ localStorageï¼Œæµè§ˆå™¨é™åˆ¶å¯èƒ½å¾ˆå¤§');
                    return;
                }
                
                // ç°åœ¨å°è¯•ä¿å­˜æ—¥å¿—ï¼ˆåº”è¯¥è§¦å‘é™çº§ï¼‰
                try {
                    const testData = {
                        type: 'log_info',
                        message: 'æº¢å‡ºæµ‹è¯•',
                        timestamp: Date.now()
                    };
                    
                    const existing = JSON.parse(localStorage.getItem('bugly_reports') || '[]');
                    existing.push(testData);
                    
                    // å°è¯•ä¿å­˜ï¼Œåº”è¯¥å¤±è´¥ä½†è¢«æ•è·
                    try {
                        localStorage.setItem('bugly_reports', JSON.stringify(existing));
                        logResult(1, 'å­˜å‚¨æº¢å‡ºæµ‹è¯•', false, 'åº”è¯¥æŠ›å‡ºå¼‚å¸¸ä½†æ²¡æœ‰');
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            // æ¨¡æ‹Ÿé™çº§å¤„ç†
                            const reduced = existing.slice(-100);
                            localStorage.setItem('bugly_reports', JSON.stringify(reduced));
                            logResult(1, 'å­˜å‚¨æº¢å‡ºæµ‹è¯•', true, 
                                'âœ… æ­£ç¡®æ•è· QuotaExceededErrorï¼ŒæˆåŠŸé™çº§åˆ° 100 æ¡');
                        } else {
                            logResult(1, 'å­˜å‚¨æº¢å‡ºæµ‹è¯•', false, 'å¼‚å¸¸ç±»å‹ä¸æ­£ç¡®: ' + e.name);
                        }
                    }
                } finally {
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    for (let i = 0; i < 10000; i++) {
                        localStorage.removeItem('test_overflow_' + i);
                    }
                }
                
            } catch (e) {
                logResult(1, 'å­˜å‚¨æº¢å‡ºæµ‹è¯•', false, 'æµ‹è¯•å¤±è´¥: ' + e.message);
            }
        }
        
        function test1_cleanup() {
            try {
                localStorage.removeItem('bugly_reports');
                logResult(1, 'æ¸…ç†æµ‹è¯•æ•°æ®', true, 'å·²æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®');
            } catch (e) {
                logResult(1, 'æ¸…ç†æµ‹è¯•æ•°æ®', false, 'æ¸…ç†å¤±è´¥: ' + e.message);
            }
        }
        
        // ==========================================
        // æµ‹è¯• 2: XSS å®‰å…¨é˜²æŠ¤
        // ==========================================
        
        function test2_script() {
            const dangerous = '<script>alert("xss")</script>';
            const pattern = /<script|<iframe|javascript:|onerror=|onload=/i;
            const blocked = pattern.test(dangerous);
            
            logResult(2, '&lt;script&gt; æ ‡ç­¾æ£€æµ‹', blocked, 
                blocked ? 'âœ… æˆåŠŸæ£€æµ‹å¹¶é˜»æ­¢' : 'âŒ æœªèƒ½æ£€æµ‹åˆ°å±é™©å­—ç¬¦');
        }
        
        function test2_javascript() {
            const dangerous = 'javascript:alert(1)';
            const pattern = /<script|<iframe|javascript:|onerror=|onload=/i;
            const blocked = pattern.test(dangerous);
            
            logResult(2, 'javascript: åè®®æ£€æµ‹', blocked, 
                blocked ? 'âœ… æˆåŠŸæ£€æµ‹å¹¶é˜»æ­¢' : 'âŒ æœªèƒ½æ£€æµ‹åˆ°å±é™©å­—ç¬¦');
        }
        
        function test2_events() {
            const dangerous = '<img onerror=alert(1)>';
            const pattern = /<script|<iframe|javascript:|onerror=|onload=/i;
            const blocked = pattern.test(dangerous);
            
            logResult(2, 'äº‹ä»¶å¤„ç†å™¨æ£€æµ‹', blocked, 
                blocked ? 'âœ… æˆåŠŸæ£€æµ‹å¹¶é˜»æ­¢' : 'âŒ æœªèƒ½æ£€æµ‹åˆ°å±é™©å­—ç¬¦');
        }
        
        function test2_iframe() {
            const dangerous = '<iframe src="evil.com"></iframe>';
            const pattern = /<script|<iframe|javascript:|onerror=|onload=/i;
            const blocked = pattern.test(dangerous);
            
            logResult(2, '&lt;iframe&gt; æ ‡ç­¾æ£€æµ‹', blocked, 
                blocked ? 'âœ… æˆåŠŸæ£€æµ‹å¹¶é˜»æ­¢' : 'âŒ æœªèƒ½æ£€æµ‹åˆ°å±é™©å­—ç¬¦');
        }
        
        // ==========================================
        // æµ‹è¯• 3: äº‹ä»¶ç›‘å¬å™¨æ³„æ¼
        // ==========================================
        
        function test3_multiple() {
            try {
                const initialListeners = getEventListenersCount();
                
                // æ¨¡æ‹Ÿå¤šæ¬¡æ‰“å¼€å…³é—­ï¼ˆå®é™…éœ€è¦åœ¨ä»ªè¡¨æ¿é¡µé¢æµ‹è¯•ï¼‰
                alert('æ­¤æµ‹è¯•éœ€è¦åœ¨ Bugly ä»ªè¡¨æ¿é¡µé¢æ‰‹åŠ¨æ‰§è¡Œ\n\nè¯·ï¼š\n1. æ‰“å¼€ bugly-dashboard.html\n2. å¤šæ¬¡ç‚¹å‡»"ä¸ŠæŠ¥æ—¥å¿—"æŒ‰é’®\n3. å¤šæ¬¡æŒ‰ ESC å…³é—­\n4. æ£€æŸ¥æ§åˆ¶å°æ— é”™è¯¯');
                
                logResult(3, 'å¤šæ¬¡æ‰“å¼€å…³é—­', true, 
                    'âš ï¸ éœ€è¦æ‰‹åŠ¨æµ‹è¯•ï¼Œè¯·åœ¨ä»ªè¡¨æ¿é¡µé¢éªŒè¯');
            } catch (e) {
                logResult(3, 'å¤šæ¬¡æ‰“å¼€å…³é—­', false, 'æµ‹è¯•å¤±è´¥: ' + e.message);
            }
        }
        
        function test3_esc() {
            alert('ESC é”®æµ‹è¯•\n\nè¯·æ‰§è¡Œï¼š\n1. æ‰“å¼€ bugly-dashboard.html\n2. ç‚¹å‡»"ä¸ŠæŠ¥æ—¥å¿—"æŒ‰é’®\n3. æŒ‰ ESC é”®\n4. éªŒè¯æ¨¡æ€æ¡†å…³é—­');
            logResult(3, 'ESC é”®åŠŸèƒ½', true, 'âš ï¸ éœ€è¦æ‰‹åŠ¨æµ‹è¯•');
        }
        
        function test3_click() {
            alert('ç‚¹å‡»å¤–éƒ¨æµ‹è¯•\n\nè¯·æ‰§è¡Œï¼š\n1. æ‰“å¼€ bugly-dashboard.html\n2. ç‚¹å‡»"ä¸ŠæŠ¥æ—¥å¿—"æŒ‰é’®\n3. ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨\n4. éªŒè¯æ¨¡æ€æ¡†å…³é—­');
            logResult(3, 'ç‚¹å‡»å¤–éƒ¨å…³é—­', true, 'âš ï¸ éœ€è¦æ‰‹åŠ¨æµ‹è¯•');
        }
        
        function test3_cleanup() {
            try {
                // æ£€æŸ¥æ¸…ç†å‡½æ•°æ˜¯å¦å­˜åœ¨ï¼ˆéœ€è¦åœ¨ä»ªè¡¨æ¿é¡µé¢ï¼‰
                if (typeof dashboard !== 'undefined' && dashboard.cleanup) {
                    logResult(3, 'æ¸…ç†å‡½æ•°å­˜åœ¨æ€§', true, 'âœ… dashboard.cleanup å‡½æ•°å·²å®šä¹‰');
                } else {
                    logResult(3, 'æ¸…ç†å‡½æ•°å­˜åœ¨æ€§', false, 
                        'âŒ åœ¨å½“å‰é¡µé¢æ— æ³•æ£€æµ‹ï¼ˆéœ€è¦åœ¨ bugly-dashboard.html æµ‹è¯•ï¼‰');
                }
            } catch (e) {
                logResult(3, 'æ¸…ç†å‡½æ•°æµ‹è¯•', false, 'æµ‹è¯•å¤±è´¥: ' + e.message);
            }
        }
        
        // ==========================================
        // ç»¼åˆæµ‹è¯•
        // ==========================================
        
        function runAllTests() {
            clearAllResults();
            
            const container = document.getElementById('overallResults');
            container.innerHTML = '<div class="status info">ğŸš€ æ­£åœ¨è¿è¡Œæ‰€æœ‰è‡ªåŠ¨æµ‹è¯•...</div>';
            
            setTimeout(() => {
                // æµ‹è¯• 1
                test1_normal();
                setTimeout(() => test1_large(), 500);
                
                // æµ‹è¯• 2
                setTimeout(() => {
                    test2_script();
                    test2_javascript();
                    test2_events();
                    test2_iframe();
                }, 2000);
                
                // æ±‡æ€»
                setTimeout(() => {
                    const total = testResults.test1.length + testResults.test2.length + testResults.test3.length;
                    const passed = [...testResults.test1, ...testResults.test2, ...testResults.test3]
                        .filter(r => r.passed).length;
                    
                    container.innerHTML = `
                        <div class="status ${passed === total ? 'success' : 'warning'}">
                            <h3>ğŸ“Š æµ‹è¯•å®Œæˆ</h3>
                            <p>æ€»è®¡: ${total} ä¸ªæµ‹è¯•</p>
                            <p>é€šè¿‡: ${passed} ä¸ª âœ…</p>
                            <p>å¤±è´¥: ${total - passed} ä¸ª âŒ</p>
                            <p>æˆåŠŸç‡: ${((passed / total) * 100).toFixed(1)}%</p>
                        </div>
                    `;
                }, 3000);
            }, 100);
        }
        
        function clearAllResults() {
            document.getElementById('test1Results').innerHTML = '';
            document.getElementById('test2Results').innerHTML = '';
            document.getElementById('test3Results').innerHTML = '';
            document.getElementById('overallResults').innerHTML = '';
            testResults.test1 = [];
            testResults.test2 = [];
            testResults.test3 = [];
        }
        
        function getEventListenersCount() {
            // ç®€åŒ–ç‰ˆï¼Œå®é™…æ£€æµ‹æ¯”è¾ƒå¤æ‚
            return 0;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            console.log('[Test] æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>

