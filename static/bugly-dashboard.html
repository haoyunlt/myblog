<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bugly 错误报告仪表板</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-card.error { border-left: 4px solid #f56c6c; }
        .stat-card.warning { border-left: 4px solid #e6a23c; }
        .stat-card.info { border-left: 4px solid #409eff; }
        .stat-card.success { border-left: 4px solid #67c23a; }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button.primary {
            background: #409eff;
            color: white;
        }
        
        button.primary:hover {
            background: #66b1ff;
        }
        
        button.danger {
            background: #f56c6c;
            color: white;
        }
        
        button.danger:hover {
            background: #f78989;
        }
        
        button.success {
            background: #67c23a;
            color: white;
        }
        
        button.success:hover {
            background: #85ce61;
        }
        
        .filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .reports {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .report-item {
            border-bottom: 1px solid #ebeef5;
            padding: 15px 0;
        }
        
        .report-item:last-child {
            border-bottom: none;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .report-header:hover {
            opacity: 0.8;
        }
        
        .report-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .type-javascript_error { background: #fef0f0; color: #f56c6c; }
        .type-resource_error { background: #fdf6ec; color: #e6a23c; }
        .type-promise_rejection { background: #fef0f0; color: #f56c6c; }
        .type-performance_long_task { background: #f4f4f5; color: #909399; }
        .type-performance_memory_warning { background: #fdf6ec; color: #e6a23c; }
        .type-custom_error { background: #ecf5ff; color: #409eff; }
        .type-log_debug { background: #f4f4f5; color: #909399; }
        .type-log_info { background: #ecf5ff; color: #409eff; }
        .type-log_warn { background: #fdf6ec; color: #e6a23c; }
        .type-log_error { background: #fef0f0; color: #f56c6c; }
        
        /* 标签徽章样式 */
        .tag-badge {
            display: inline-block;
            background: #ecf5ff;
            color: #409eff;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 5px;
            font-size: 12px;
        }
        
        /* Toast 消息样式 */
        .toast-message {
            position: fixed;
            right: 20px;
            padding: 15px 20px;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toast-success { background: #67c23a; }
        .toast-error { background: #f56c6c; }
        .toast-warning { background: #e6a23c; }
        .toast-info { background: #409eff; }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 90%;
            animation: slideIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ebeef5;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #909399;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 28px;
            text-align: center;
        }
        
        .close-btn:hover {
            color: #f56c6c;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #606266;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #409eff;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #ebeef5;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .badge.new {
            background: #f56c6c;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .report-message {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        
        .report-time {
            font-size: 12px;
            color: #909399;
        }
        
        .report-details {
            background: #f5f7fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.8;
            display: none;
        }
        
        .report-details.show {
            display: block;
        }
        
        .report-details pre {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>📊 Bugly 错误报告仪表板</h1>
            <p>实时监控移动端错误和性能问题</p>
        </header>
        
        <div class="stats">
            <div class="stat-card error">
                <h3>JavaScript 错误</h3>
                <div class="value" id="errorCount">0</div>
            </div>
            <div class="stat-card warning">
                <h3>资源加载错误</h3>
                <div class="value" id="resourceErrorCount">0</div>
            </div>
            <div class="stat-card info">
                <h3>日志记录</h3>
                <div class="value" id="logCount">0</div>
            </div>
            <div class="stat-card success">
                <h3>总报告数</h3>
                <div class="value" id="totalCount">0</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="primary" onclick="dashboard.refresh()">🔄 刷新</button>
            <button class="success" onclick="dashboard.showLogModal()">📝 上报日志</button>
            <button class="success" onclick="dashboard.export()">📥 导出JSON</button>
            <button class="danger" onclick="dashboard.clear()">🗑️ 清除所有</button>
            
            <div class="filter" style="margin-left: auto;">
                <label>类型过滤:</label>
                <select id="typeFilter" onchange="dashboard.filter()">
                    <option value="">全部</option>
                    <option value="javascript_error">JavaScript错误</option>
                    <option value="resource_error">资源错误</option>
                    <option value="promise_rejection">Promise拒绝</option>
                    <option value="performance_long_task">性能问题</option>
                    <option value="performance_memory_warning">内存警告</option>
                    <option value="custom_error">自定义错误</option>
                    <option value="log_debug">日志-调试</option>
                    <option value="log_info">日志-信息</option>
                    <option value="log_warn">日志-警告</option>
                    <option value="log_error">日志-错误</option>
                </select>
                
                <input type="text" id="searchInput" placeholder="搜索消息..." oninput="dashboard.search()">
            </div>
        </div>
        
        <div class="reports" id="reportsContainer">
            <!-- 报告将在这里动态生成 -->
        </div>
    </div>
    
    <!-- 日志上报模态框 -->
    <div id="logModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📝 上报日志</h2>
                <button class="close-btn" onclick="dashboard.closeLogModal()">&times;</button>
            </div>
            
            <form id="logForm" onsubmit="dashboard.submitLog(event)">
                <div class="form-group">
                    <label for="logLevel">日志级别 *</label>
                    <select id="logLevel" required>
                        <option value="debug">🔍 调试 (Debug)</option>
                        <option value="info" selected>ℹ️ 信息 (Info)</option>
                        <option value="warn">⚠️ 警告 (Warn)</option>
                        <option value="error">❌ 错误 (Error)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="logMessage">日志消息 *</label>
                    <input type="text" id="logMessage" placeholder="请输入日志消息..." required maxlength="200">
                </div>
                
                <div class="form-group">
                    <label for="logDetails">详细信息</label>
                    <textarea id="logDetails" placeholder="可选：输入更多详细信息..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="logTags">标签</label>
                    <input type="text" id="logTags" placeholder="可选：输入标签，用逗号分隔，如: 用户操作,支付流程">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="danger" onclick="dashboard.closeLogModal()">取消</button>
                    <button type="submit" class="success">✅ 提交日志</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const dashboard = {
            reports: [],
            filteredReports: [],
            
            init() {
                this.loadReports();
                this.render();
                
                // 定期刷新
                setInterval(() => this.refresh(), 5000);
            },
            
            loadReports() {
                try {
                    const data = localStorage.getItem('bugly_reports');
                    this.reports = data ? JSON.parse(data) : [];
                    this.filteredReports = [...this.reports];
                    this.updateStats();
                } catch (e) {
                    console.error('加载报告失败', e);
                    this.reports = [];
                    this.filteredReports = [];
                }
            },
            
            updateStats() {
                const stats = {
                    total: this.reports.length,
                    javascript_error: 0,
                    resource_error: 0,
                    promise_rejection: 0,
                    logs: 0
                };
                
                this.reports.forEach(report => {
                    if (stats[report.type] !== undefined) {
                        stats[report.type]++;
                    }
                    // 统计所有日志类型
                    if (report.type && report.type.startsWith('log_')) {
                        stats.logs++;
                    }
                });
                
                document.getElementById('totalCount').textContent = stats.total;
                document.getElementById('errorCount').textContent = stats.javascript_error;
                document.getElementById('resourceErrorCount').textContent = stats.resource_error;
                document.getElementById('logCount').textContent = stats.logs;
            },
            
            render() {
                const container = document.getElementById('reportsContainer');
                
                if (this.filteredReports.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                            <h3>暂无错误报告</h3>
                            <p>系统运行正常，没有检测到错误</p>
                        </div>
                    `;
                    return;
                }
                
                const html = this.filteredReports.map((report, index) => {
                    const time = new Date(report.timestamp).toLocaleString('zh-CN');
                    const deviceInfo = report.device || {};
                    
                    return `
                        <div class="report-item">
                            <div class="report-header" onclick="dashboard.toggleDetails(${index})">
                                <div>
                                    <span class="report-type type-${report.type}">${this.formatType(report.type)}</span>
                                    <div class="report-message">${this.escapeHtml(report.message)}</div>
                                </div>
                                <div class="report-time">${time}</div>
                            </div>
                            
                            <div class="report-details" id="details-${index}">
                                <div><strong>类型:</strong> ${report.errorType || report.type}</div>
                                <div><strong>会话ID:</strong> ${report.sessionId || 'N/A'}</div>
                                <div><strong>URL:</strong> ${report.url || 'N/A'}</div>
                                ${report.filename ? `<div><strong>文件:</strong> ${report.filename}:${report.lineno}:${report.colno}</div>` : ''}
                                ${report.resourceType ? `<div><strong>资源类型:</strong> ${report.resourceType}</div>` : ''}
                                ${report.resourceUrl ? `<div><strong>资源URL:</strong> ${report.resourceUrl}</div>` : ''}
                                ${report.duration ? `<div><strong>持续时间:</strong> ${report.duration.toFixed(2)}ms</div>` : ''}
                                ${report.usedMB ? `<div><strong>内存使用:</strong> ${report.usedMB}MB / ${report.limitMB}MB</div>` : ''}
                                ${report.level ? `<div><strong>日志级别:</strong> ${report.level.toUpperCase()}</div>` : ''}
                                ${report.source ? `<div><strong>来源:</strong> ${report.source === 'manual_report' ? '手动上报' : report.source}</div>` : ''}
                                ${report.tags && report.tags.length > 0 ? `<div><strong>标签:</strong> ${report.tags.map(t => '<span class="tag-badge">' + this.escapeHtml(t) + '</span>').join('')}</div>` : ''}
                                ${report.details ? `<div style="margin-top:10px;"><strong>详细信息:</strong><pre style="white-space:pre-wrap;word-break:break-word;">${this.escapeHtml(report.details)}</pre></div>` : ''}
                                <div><strong>重复次数:</strong> ${report.repeatCount || 1}</div>
                                
                                ${deviceInfo.userAgent ? `
                                    <div style="margin-top: 15px;"><strong>设备信息:</strong></div>
                                    <div>浏览器: ${deviceInfo.userAgent}</div>
                                    <div>屏幕: ${deviceInfo.screenWidth}x${deviceInfo.screenHeight} (${deviceInfo.pixelRatio}x)</div>
                                    <div>窗口: ${deviceInfo.windowWidth}x${deviceInfo.windowHeight}</div>
                                    ${deviceInfo.memory ? `<div>内存: ${Math.round(deviceInfo.memory.usedJSHeapSize / 1048576)}MB / ${Math.round(deviceInfo.memory.jsHeapSizeLimit / 1048576)}MB</div>` : ''}
                                ` : ''}
                                
                                ${report.stack ? `
                                    <div style="margin-top: 15px;"><strong>堆栈跟踪:</strong></div>
                                    <pre>${this.escapeHtml(report.stack)}</pre>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
            },
            
            toggleDetails(index) {
                const details = document.getElementById(`details-${index}`);
                details.classList.toggle('show');
            },
            
            formatType(type) {
                const map = {
                    'javascript_error': 'JS错误',
                    'resource_error': '资源错误',
                    'promise_rejection': 'Promise拒绝',
                    'performance_long_task': '长任务',
                    'performance_memory_warning': '内存警告',
                    'custom_error': '自定义错误',
                    'log_debug': '日志-调试',
                    'log_info': '日志-信息',
                    'log_warn': '日志-警告',
                    'log_error': '日志-错误'
                };
                return map[type] || type;
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            filter() {
                const typeFilter = document.getElementById('typeFilter').value;
                const searchInput = document.getElementById('searchInput').value.toLowerCase();
                
                this.filteredReports = this.reports.filter(report => {
                    const matchType = !typeFilter || report.type === typeFilter;
                    const matchSearch = !searchInput || report.message.toLowerCase().includes(searchInput);
                    return matchType && matchSearch;
                });
                
                this.render();
            },
            
            search() {
                this.filter();
            },
            
            refresh() {
                this.loadReports();
                this.render();
            },
            
            export() {
                const data = JSON.stringify(this.reports, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bugly-reports-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            
            clear() {
                if (confirm('确定要清除所有错误报告吗？此操作不可恢复。')) {
                    localStorage.removeItem('bugly_reports');
                    this.reports = [];
                    this.filteredReports = [];
                    this.updateStats();
                    this.render();
                }
            },
            
            // 显示日志上报模态框
            showLogModal() {
                const modal = document.getElementById('logModal');
                modal.classList.add('show');
                
                // 自动聚焦到消息输入框
                setTimeout(() => {
                    document.getElementById('logMessage').focus();
                }, 100);
            },
            
            // 关闭日志上报模态框
            closeLogModal() {
                const modal = document.getElementById('logModal');
                modal.classList.remove('show');
                
                // 重置表单
                document.getElementById('logForm').reset();
            },
            
            // 提交日志
            submitLog(event) {
                event.preventDefault();
                
                try {
                    const level = document.getElementById('logLevel').value;
                    const message = document.getElementById('logMessage').value.trim();
                    const details = document.getElementById('logDetails').value.trim();
                    const tagsInput = document.getElementById('logTags').value.trim();
                    
                    // 输入验证
                    if (!message || message.length === 0) {
                        this.showToast('❌ 消息不能为空', 'error');
                        return;
                    }
                    
                    if (message.length > 200) {
                        this.showToast('❌ 消息长度不能超过 200 字符', 'error');
                        return;
                    }
                    
                    // 检查危险字符
                    const dangerousPattern = /<script|<iframe|javascript:|onerror=|onload=/i;
                    if (dangerousPattern.test(message) || dangerousPattern.test(details)) {
                        this.showToast('❌ 输入包含不允许的字符', 'error');
                        return;
                    }
                    
                    // 解析标签
                    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
                    
                    if (tags.length > 10) {
                        this.showToast('❌ 标签数量不能超过 10 个', 'error');
                        return;
                    }
                    
                    // 验证标签
                    for (const tag of tags) {
                        if (tag.length > 20) {
                            this.showToast(`❌ 标签 "${tag}" 过长（最多20字符）`, 'error');
                            return;
                        }
                        if (dangerousPattern.test(tag)) {
                            this.showToast(`❌ 标签 "${tag}" 包含不允许的字符`, 'error');
                            return;
                        }
                    }
                    
                    // 构建日志报告
                    const logReport = {
                        type: `log_${level}`,
                        message: message,
                        details: details || undefined,
                        tags: tags.length > 0 ? tags : undefined,
                        level: level,
                        timestamp: Date.now(),
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        sessionId: 'manual_' + Date.now(),
                        source: 'manual_report'
                    };
                    
                    // 安全保存到本地存储
                    const saveResult = this.saveToLocalStorageSafe(logReport);
                    
                    if (!saveResult.success) {
                        this.showToast('❌ ' + saveResult.error, 'error');
                        return;
                    }
                    
                    if (saveResult.warning) {
                        this.showToast('⚠️ ' + saveResult.warning, 'warning');
                    }
                    
                    // 显示成功提示
                    this.showToast('✅ 日志已成功上报！', 'success');
                    
                    // 关闭模态框
                    this.closeLogModal();
                    
                    // 刷新显示
                    this.refresh();
                    
                    console.log('[Dashboard] 日志已上报:', logReport);
                    
                } catch (e) {
                    console.error('[Dashboard] 提交日志失败:', e);
                    this.showToast('❌ 日志上报失败: ' + e.message, 'error');
                }
            },
            
            // 安全保存到 localStorage（带异常处理）
            saveToLocalStorageSafe(logReport) {
                try {
                    const existing = JSON.parse(localStorage.getItem('bugly_reports') || '[]');
                    existing.push(logReport);
                    
                    // 限制最多保存1000条
                    let limited = existing.slice(-1000);
                    const jsonString = JSON.stringify(limited);
                    
                    // 检查大小（localStorage 限制通常为 5-10MB）
                    const sizeInMB = new Blob([jsonString]).size / 1048576;
                    
                    if (sizeInMB > 4) {
                        // 如果超过 4MB，减少保留数量
                        limited = existing.slice(-500);
                        console.warn('[Dashboard] 存储空间不足，减少保留数量到 500 条');
                        
                        try {
                            localStorage.setItem('bugly_reports', JSON.stringify(limited));
                            return { 
                                success: true, 
                                warning: '存储空间不足，已自动清理旧数据（保留最近500条）'
                            };
                        } catch (e) {
                            // 如果还是失败，进一步减少
                            limited = existing.slice(-100);
                            localStorage.setItem('bugly_reports', JSON.stringify(limited));
                            return { 
                                success: true, 
                                warning: '存储空间严重不足，已自动清理旧数据（仅保留最近100条）'
                            };
                        }
                    }
                    
                    localStorage.setItem('bugly_reports', jsonString);
                    return { success: true };
                    
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        console.error('[Dashboard] 存储空间已满');
                        
                        try {
                            // 尝试只保留最近 100 条
                            const existing = JSON.parse(localStorage.getItem('bugly_reports') || '[]');
                            existing.push(logReport);
                            const reduced = existing.slice(-100);
                            localStorage.setItem('bugly_reports', JSON.stringify(reduced));
                            
                            return { 
                                success: true, 
                                warning: '存储空间已满，已清理旧数据（仅保留最近100条）'
                            };
                        } catch (e2) {
                            console.error('[Dashboard] 无法保存数据，存储空间严重不足');
                            return { 
                                success: false, 
                                error: '存储空间严重不足，无法保存日志。请清除旧数据后重试。'
                            };
                        }
                    }
                    
                    console.error('[Dashboard] 保存数据失败:', e);
                    return { 
                        success: false, 
                        error: '保存失败: ' + e.message
                    };
                }
            },
            
            // 显示提示消息（优化版，防止堆积）
            showToast(message, type = 'info') {
                // 初始化 toast 容器
                if (!this.toasts) {
                    this.toasts = [];
                }
                
                // 限制同时显示的 toast 数量（最多3个）
                if (this.toasts.length >= 3) {
                    const oldestToast = this.toasts.shift();
                    if (oldestToast && oldestToast.parentNode) {
                        oldestToast.parentNode.removeChild(oldestToast);
                    }
                }
                
                // 创建提示元素
                const toast = document.createElement('div');
                toast.className = `toast-message toast-${type}`;
                
                // 计算位置（根据已有 toast 数量）
                const topPosition = 20 + this.toasts.length * 70;
                
                toast.style.cssText = `
                    top: ${topPosition}px;
                    animation: slideInRight 0.3s ease-out;
                `;
                toast.textContent = message;
                
                // 添加到数组
                this.toasts.push(toast);
                
                // 添加到页面
                document.body.appendChild(toast);
                
                // 点击关闭
                const removeToast = () => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.parentNode.removeChild(toast);
                            }
                            // 从数组中移除
                            const index = this.toasts.indexOf(toast);
                            if (index > -1) {
                                this.toasts.splice(index, 1);
                            }
                            // 重新定位剩余的 toast
                            this.repositionToasts();
                        }, 300);
                    }
                };
                
                toast.addEventListener('click', removeToast);
                
                // 3秒后自动移除
                setTimeout(removeToast, 3000);
            },
            
            // 重新定位所有 Toast
            repositionToasts() {
                if (!this.toasts) return;
                
                this.toasts.forEach((toast, index) => {
                    toast.style.top = `${20 + index * 70}px`;
                });
            }
        };
        
        // 事件处理器（使用 addEventListener，避免覆盖其他处理器）
        dashboard._modalClickHandler = function(event) {
            const modal = document.getElementById('logModal');
            if (event.target === modal) {
                dashboard.closeLogModal();
            }
        };
        
        dashboard._keydownHandler = function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('logModal');
                if (modal && modal.classList.contains('show')) {
                    dashboard.closeLogModal();
                }
            }
        };
        
        // 添加事件监听器
        window.addEventListener('click', dashboard._modalClickHandler);
        document.addEventListener('keydown', dashboard._keydownHandler);
        
        // 清理函数（页面卸载时调用）
        dashboard.cleanup = function() {
            window.removeEventListener('click', this._modalClickHandler);
            document.removeEventListener('keydown', this._keydownHandler);
            console.log('[Dashboard] 事件监听器已清理');
        };
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            if (dashboard.cleanup) {
                dashboard.cleanup();
            }
        });
        
        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // 初始化
        dashboard.init();
    </script>
</body>
</html>

