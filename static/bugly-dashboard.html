<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bugly é”™è¯¯æŠ¥å‘Šä»ªè¡¨æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-card.error { border-left: 4px solid #f56c6c; }
        .stat-card.warning { border-left: 4px solid #e6a23c; }
        .stat-card.info { border-left: 4px solid #409eff; }
        .stat-card.success { border-left: 4px solid #67c23a; }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button.primary {
            background: #409eff;
            color: white;
        }
        
        button.primary:hover {
            background: #66b1ff;
        }
        
        button.danger {
            background: #f56c6c;
            color: white;
        }
        
        button.danger:hover {
            background: #f78989;
        }
        
        button.success {
            background: #67c23a;
            color: white;
        }
        
        button.success:hover {
            background: #85ce61;
        }
        
        .filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .reports {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .report-item {
            border-bottom: 1px solid #ebeef5;
            padding: 15px 0;
        }
        
        .report-item:last-child {
            border-bottom: none;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .report-header:hover {
            opacity: 0.8;
        }
        
        .report-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .type-javascript_error { background: #fef0f0; color: #f56c6c; }
        .type-resource_error { background: #fdf6ec; color: #e6a23c; }
        .type-promise_rejection { background: #fef0f0; color: #f56c6c; }
        .type-performance_long_task { background: #f4f4f5; color: #909399; }
        .type-performance_memory_warning { background: #fdf6ec; color: #e6a23c; }
        .type-custom_error { background: #ecf5ff; color: #409eff; }
        .type-log_debug { background: #f4f4f5; color: #909399; }
        .type-log_info { background: #ecf5ff; color: #409eff; }
        .type-log_warn { background: #fdf6ec; color: #e6a23c; }
        .type-log_error { background: #fef0f0; color: #f56c6c; }
        
        /* æ ‡ç­¾å¾½ç« æ ·å¼ */
        .tag-badge {
            display: inline-block;
            background: #ecf5ff;
            color: #409eff;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 5px;
            font-size: 12px;
        }
        
        /* Toast æ¶ˆæ¯æ ·å¼ */
        .toast-message {
            position: fixed;
            right: 20px;
            padding: 15px 20px;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toast-success { background: #67c23a; }
        .toast-error { background: #f56c6c; }
        .toast-warning { background: #e6a23c; }
        .toast-info { background: #409eff; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 90%;
            animation: slideIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ebeef5;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #909399;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 28px;
            text-align: center;
        }
        
        .close-btn:hover {
            color: #f56c6c;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #606266;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #409eff;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #ebeef5;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .badge.new {
            background: #f56c6c;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .report-message {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        
        .report-time {
            font-size: 12px;
            color: #909399;
        }
        
        .report-details {
            background: #f5f7fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.8;
            display: none;
        }
        
        .report-details.show {
            display: block;
        }
        
        .report-details pre {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š Bugly é”™è¯¯æŠ¥å‘Šä»ªè¡¨æ¿</h1>
            <p>å®æ—¶ç›‘æ§ç§»åŠ¨ç«¯é”™è¯¯å’Œæ€§èƒ½é—®é¢˜</p>
        </header>
        
        <div class="stats">
            <div class="stat-card error">
                <h3>JavaScript é”™è¯¯</h3>
                <div class="value" id="errorCount">0</div>
            </div>
            <div class="stat-card warning">
                <h3>èµ„æºåŠ è½½é”™è¯¯</h3>
                <div class="value" id="resourceErrorCount">0</div>
            </div>
            <div class="stat-card info">
                <h3>æ—¥å¿—è®°å½•</h3>
                <div class="value" id="logCount">0</div>
            </div>
            <div class="stat-card success">
                <h3>æ€»æŠ¥å‘Šæ•°</h3>
                <div class="value" id="totalCount">0</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="primary" onclick="dashboard.refresh()">ğŸ”„ åˆ·æ–°</button>
            <button class="success" onclick="dashboard.showLogModal()">ğŸ“ ä¸ŠæŠ¥æ—¥å¿—</button>
            <button class="success" onclick="dashboard.export()">ğŸ“¥ å¯¼å‡ºJSON</button>
            <button class="danger" onclick="dashboard.clear()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
            
            <div class="filter" style="margin-left: auto;">
                <label>ç±»å‹è¿‡æ»¤:</label>
                <select id="typeFilter" onchange="dashboard.filter()">
                    <option value="">å…¨éƒ¨</option>
                    <option value="javascript_error">JavaScripté”™è¯¯</option>
                    <option value="resource_error">èµ„æºé”™è¯¯</option>
                    <option value="promise_rejection">Promiseæ‹’ç»</option>
                    <option value="performance_long_task">æ€§èƒ½é—®é¢˜</option>
                    <option value="performance_memory_warning">å†…å­˜è­¦å‘Š</option>
                    <option value="custom_error">è‡ªå®šä¹‰é”™è¯¯</option>
                    <option value="log_debug">æ—¥å¿—-è°ƒè¯•</option>
                    <option value="log_info">æ—¥å¿—-ä¿¡æ¯</option>
                    <option value="log_warn">æ—¥å¿—-è­¦å‘Š</option>
                    <option value="log_error">æ—¥å¿—-é”™è¯¯</option>
                </select>
                
                <input type="text" id="searchInput" placeholder="æœç´¢æ¶ˆæ¯..." oninput="dashboard.search()">
            </div>
        </div>
        
        <div class="reports" id="reportsContainer">
            <!-- æŠ¥å‘Šå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- æ—¥å¿—ä¸ŠæŠ¥æ¨¡æ€æ¡† -->
    <div id="logModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ ä¸ŠæŠ¥æ—¥å¿—</h2>
                <button class="close-btn" onclick="dashboard.closeLogModal()">&times;</button>
            </div>
            
            <form id="logForm" onsubmit="dashboard.submitLog(event)">
                <div class="form-group">
                    <label for="logLevel">æ—¥å¿—çº§åˆ« *</label>
                    <select id="logLevel" required>
                        <option value="debug">ğŸ” è°ƒè¯• (Debug)</option>
                        <option value="info" selected>â„¹ï¸ ä¿¡æ¯ (Info)</option>
                        <option value="warn">âš ï¸ è­¦å‘Š (Warn)</option>
                        <option value="error">âŒ é”™è¯¯ (Error)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="logMessage">æ—¥å¿—æ¶ˆæ¯ *</label>
                    <input type="text" id="logMessage" placeholder="è¯·è¾“å…¥æ—¥å¿—æ¶ˆæ¯..." required maxlength="200">
                </div>
                
                <div class="form-group">
                    <label for="logDetails">è¯¦ç»†ä¿¡æ¯</label>
                    <textarea id="logDetails" placeholder="å¯é€‰ï¼šè¾“å…¥æ›´å¤šè¯¦ç»†ä¿¡æ¯..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="logTags">æ ‡ç­¾</label>
                    <input type="text" id="logTags" placeholder="å¯é€‰ï¼šè¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¦‚: ç”¨æˆ·æ“ä½œ,æ”¯ä»˜æµç¨‹">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="danger" onclick="dashboard.closeLogModal()">å–æ¶ˆ</button>
                    <button type="submit" class="success">âœ… æäº¤æ—¥å¿—</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const dashboard = {
            reports: [],
            filteredReports: [],
            
            init() {
                this.loadReports();
                this.render();
                
                // å®šæœŸåˆ·æ–°
                setInterval(() => this.refresh(), 5000);
            },
            
            loadReports() {
                try {
                    const data = localStorage.getItem('bugly_reports');
                    this.reports = data ? JSON.parse(data) : [];
                    this.filteredReports = [...this.reports];
                    this.updateStats();
                } catch (e) {
                    console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥', e);
                    this.reports = [];
                    this.filteredReports = [];
                }
            },
            
            updateStats() {
                const stats = {
                    total: this.reports.length,
                    javascript_error: 0,
                    resource_error: 0,
                    promise_rejection: 0,
                    logs: 0
                };
                
                this.reports.forEach(report => {
                    if (stats[report.type] !== undefined) {
                        stats[report.type]++;
                    }
                    // ç»Ÿè®¡æ‰€æœ‰æ—¥å¿—ç±»å‹
                    if (report.type && report.type.startsWith('log_')) {
                        stats.logs++;
                    }
                });
                
                document.getElementById('totalCount').textContent = stats.total;
                document.getElementById('errorCount').textContent = stats.javascript_error;
                document.getElementById('resourceErrorCount').textContent = stats.resource_error;
                document.getElementById('logCount').textContent = stats.logs;
            },
            
            render() {
                const container = document.getElementById('reportsContainer');
                
                if (this.filteredReports.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                            <h3>æš‚æ— é”™è¯¯æŠ¥å‘Š</h3>
                            <p>ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæ²¡æœ‰æ£€æµ‹åˆ°é”™è¯¯</p>
                        </div>
                    `;
                    return;
                }
                
                const html = this.filteredReports.map((report, index) => {
                    const time = new Date(report.timestamp).toLocaleString('zh-CN');
                    const deviceInfo = report.device || {};
                    
                    return `
                        <div class="report-item">
                            <div class="report-header" onclick="dashboard.toggleDetails(${index})">
                                <div>
                                    <span class="report-type type-${report.type}">${this.formatType(report.type)}</span>
                                    <div class="report-message">${this.escapeHtml(report.message)}</div>
                                </div>
                                <div class="report-time">${time}</div>
                            </div>
                            
                            <div class="report-details" id="details-${index}">
                                <div><strong>ç±»å‹:</strong> ${report.errorType || report.type}</div>
                                <div><strong>ä¼šè¯ID:</strong> ${report.sessionId || 'N/A'}</div>
                                <div><strong>URL:</strong> ${report.url || 'N/A'}</div>
                                ${report.filename ? `<div><strong>æ–‡ä»¶:</strong> ${report.filename}:${report.lineno}:${report.colno}</div>` : ''}
                                ${report.resourceType ? `<div><strong>èµ„æºç±»å‹:</strong> ${report.resourceType}</div>` : ''}
                                ${report.resourceUrl ? `<div><strong>èµ„æºURL:</strong> ${report.resourceUrl}</div>` : ''}
                                ${report.duration ? `<div><strong>æŒç»­æ—¶é—´:</strong> ${report.duration.toFixed(2)}ms</div>` : ''}
                                ${report.usedMB ? `<div><strong>å†…å­˜ä½¿ç”¨:</strong> ${report.usedMB}MB / ${report.limitMB}MB</div>` : ''}
                                ${report.level ? `<div><strong>æ—¥å¿—çº§åˆ«:</strong> ${report.level.toUpperCase()}</div>` : ''}
                                ${report.source ? `<div><strong>æ¥æº:</strong> ${report.source === 'manual_report' ? 'æ‰‹åŠ¨ä¸ŠæŠ¥' : report.source}</div>` : ''}
                                ${report.tags && report.tags.length > 0 ? `<div><strong>æ ‡ç­¾:</strong> ${report.tags.map(t => '<span class="tag-badge">' + this.escapeHtml(t) + '</span>').join('')}</div>` : ''}
                                ${report.details ? `<div style="margin-top:10px;"><strong>è¯¦ç»†ä¿¡æ¯:</strong><pre style="white-space:pre-wrap;word-break:break-word;">${this.escapeHtml(report.details)}</pre></div>` : ''}
                                <div><strong>é‡å¤æ¬¡æ•°:</strong> ${report.repeatCount || 1}</div>
                                
                                ${deviceInfo.userAgent ? `
                                    <div style="margin-top: 15px;"><strong>è®¾å¤‡ä¿¡æ¯:</strong></div>
                                    <div>æµè§ˆå™¨: ${deviceInfo.userAgent}</div>
                                    <div>å±å¹•: ${deviceInfo.screenWidth}x${deviceInfo.screenHeight} (${deviceInfo.pixelRatio}x)</div>
                                    <div>çª—å£: ${deviceInfo.windowWidth}x${deviceInfo.windowHeight}</div>
                                    ${deviceInfo.memory ? `<div>å†…å­˜: ${Math.round(deviceInfo.memory.usedJSHeapSize / 1048576)}MB / ${Math.round(deviceInfo.memory.jsHeapSizeLimit / 1048576)}MB</div>` : ''}
                                ` : ''}
                                
                                ${report.stack ? `
                                    <div style="margin-top: 15px;"><strong>å †æ ˆè·Ÿè¸ª:</strong></div>
                                    <pre>${this.escapeHtml(report.stack)}</pre>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
            },
            
            toggleDetails(index) {
                const details = document.getElementById(`details-${index}`);
                details.classList.toggle('show');
            },
            
            formatType(type) {
                const map = {
                    'javascript_error': 'JSé”™è¯¯',
                    'resource_error': 'èµ„æºé”™è¯¯',
                    'promise_rejection': 'Promiseæ‹’ç»',
                    'performance_long_task': 'é•¿ä»»åŠ¡',
                    'performance_memory_warning': 'å†…å­˜è­¦å‘Š',
                    'custom_error': 'è‡ªå®šä¹‰é”™è¯¯',
                    'log_debug': 'æ—¥å¿—-è°ƒè¯•',
                    'log_info': 'æ—¥å¿—-ä¿¡æ¯',
                    'log_warn': 'æ—¥å¿—-è­¦å‘Š',
                    'log_error': 'æ—¥å¿—-é”™è¯¯'
                };
                return map[type] || type;
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            filter() {
                const typeFilter = document.getElementById('typeFilter').value;
                const searchInput = document.getElementById('searchInput').value.toLowerCase();
                
                this.filteredReports = this.reports.filter(report => {
                    const matchType = !typeFilter || report.type === typeFilter;
                    const matchSearch = !searchInput || report.message.toLowerCase().includes(searchInput);
                    return matchType && matchSearch;
                });
                
                this.render();
            },
            
            search() {
                this.filter();
            },
            
            refresh() {
                this.loadReports();
                this.render();
            },
            
            export() {
                const data = JSON.stringify(this.reports, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bugly-reports-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            
            clear() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰é”™è¯¯æŠ¥å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    localStorage.removeItem('bugly_reports');
                    this.reports = [];
                    this.filteredReports = [];
                    this.updateStats();
                    this.render();
                }
            },
            
            // æ˜¾ç¤ºæ—¥å¿—ä¸ŠæŠ¥æ¨¡æ€æ¡†
            showLogModal() {
                const modal = document.getElementById('logModal');
                modal.classList.add('show');
                
                // è‡ªåŠ¨èšç„¦åˆ°æ¶ˆæ¯è¾“å…¥æ¡†
                setTimeout(() => {
                    document.getElementById('logMessage').focus();
                }, 100);
            },
            
            // å…³é—­æ—¥å¿—ä¸ŠæŠ¥æ¨¡æ€æ¡†
            closeLogModal() {
                const modal = document.getElementById('logModal');
                modal.classList.remove('show');
                
                // é‡ç½®è¡¨å•
                document.getElementById('logForm').reset();
            },
            
            // æäº¤æ—¥å¿—
            submitLog(event) {
                event.preventDefault();
                
                try {
                    const level = document.getElementById('logLevel').value;
                    const message = document.getElementById('logMessage').value.trim();
                    const details = document.getElementById('logDetails').value.trim();
                    const tagsInput = document.getElementById('logTags').value.trim();
                    
                    // è¾“å…¥éªŒè¯
                    if (!message || message.length === 0) {
                        this.showToast('âŒ æ¶ˆæ¯ä¸èƒ½ä¸ºç©º', 'error');
                        return;
                    }
                    
                    if (message.length > 200) {
                        this.showToast('âŒ æ¶ˆæ¯é•¿åº¦ä¸èƒ½è¶…è¿‡ 200 å­—ç¬¦', 'error');
                        return;
                    }
                    
                    // æ£€æŸ¥å±é™©å­—ç¬¦
                    const dangerousPattern = /<script|<iframe|javascript:|onerror=|onload=/i;
                    if (dangerousPattern.test(message) || dangerousPattern.test(details)) {
                        this.showToast('âŒ è¾“å…¥åŒ…å«ä¸å…è®¸çš„å­—ç¬¦', 'error');
                        return;
                    }
                    
                    // è§£ææ ‡ç­¾
                    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
                    
                    if (tags.length > 10) {
                        this.showToast('âŒ æ ‡ç­¾æ•°é‡ä¸èƒ½è¶…è¿‡ 10 ä¸ª', 'error');
                        return;
                    }
                    
                    // éªŒè¯æ ‡ç­¾
                    for (const tag of tags) {
                        if (tag.length > 20) {
                            this.showToast(`âŒ æ ‡ç­¾ "${tag}" è¿‡é•¿ï¼ˆæœ€å¤š20å­—ç¬¦ï¼‰`, 'error');
                            return;
                        }
                        if (dangerousPattern.test(tag)) {
                            this.showToast(`âŒ æ ‡ç­¾ "${tag}" åŒ…å«ä¸å…è®¸çš„å­—ç¬¦`, 'error');
                            return;
                        }
                    }
                    
                    // æ„å»ºæ—¥å¿—æŠ¥å‘Š
                    const logReport = {
                        type: `log_${level}`,
                        message: message,
                        details: details || undefined,
                        tags: tags.length > 0 ? tags : undefined,
                        level: level,
                        timestamp: Date.now(),
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        sessionId: 'manual_' + Date.now(),
                        source: 'manual_report'
                    };
                    
                    // å®‰å…¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    const saveResult = this.saveToLocalStorageSafe(logReport);
                    
                    if (!saveResult.success) {
                        this.showToast('âŒ ' + saveResult.error, 'error');
                        return;
                    }
                    
                    if (saveResult.warning) {
                        this.showToast('âš ï¸ ' + saveResult.warning, 'warning');
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    this.showToast('âœ… æ—¥å¿—å·²æˆåŠŸä¸ŠæŠ¥ï¼', 'success');
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    this.closeLogModal();
                    
                    // åˆ·æ–°æ˜¾ç¤º
                    this.refresh();
                    
                    console.log('[Dashboard] æ—¥å¿—å·²ä¸ŠæŠ¥:', logReport);
                    
                } catch (e) {
                    console.error('[Dashboard] æäº¤æ—¥å¿—å¤±è´¥:', e);
                    this.showToast('âŒ æ—¥å¿—ä¸ŠæŠ¥å¤±è´¥: ' + e.message, 'error');
                }
            },
            
            // å®‰å…¨ä¿å­˜åˆ° localStorageï¼ˆå¸¦å¼‚å¸¸å¤„ç†ï¼‰
            saveToLocalStorageSafe(logReport) {
                try {
                    const existing = JSON.parse(localStorage.getItem('bugly_reports') || '[]');
                    existing.push(logReport);
                    
                    // é™åˆ¶æœ€å¤šä¿å­˜1000æ¡
                    let limited = existing.slice(-1000);
                    const jsonString = JSON.stringify(limited);
                    
                    // æ£€æŸ¥å¤§å°ï¼ˆlocalStorage é™åˆ¶é€šå¸¸ä¸º 5-10MBï¼‰
                    const sizeInMB = new Blob([jsonString]).size / 1048576;
                    
                    if (sizeInMB > 4) {
                        // å¦‚æœè¶…è¿‡ 4MBï¼Œå‡å°‘ä¿ç•™æ•°é‡
                        limited = existing.slice(-500);
                        console.warn('[Dashboard] å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå‡å°‘ä¿ç•™æ•°é‡åˆ° 500 æ¡');
                        
                        try {
                            localStorage.setItem('bugly_reports', JSON.stringify(limited));
                            return { 
                                success: true, 
                                warning: 'å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå·²è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘500æ¡ï¼‰'
                            };
                        } catch (e) {
                            // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œè¿›ä¸€æ­¥å‡å°‘
                            limited = existing.slice(-100);
                            localStorage.setItem('bugly_reports', JSON.stringify(limited));
                            return { 
                                success: true, 
                                warning: 'å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³ï¼Œå·²è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®ï¼ˆä»…ä¿ç•™æœ€è¿‘100æ¡ï¼‰'
                            };
                        }
                    }
                    
                    localStorage.setItem('bugly_reports', jsonString);
                    return { success: true };
                    
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        console.error('[Dashboard] å­˜å‚¨ç©ºé—´å·²æ»¡');
                        
                        try {
                            // å°è¯•åªä¿ç•™æœ€è¿‘ 100 æ¡
                            const existing = JSON.parse(localStorage.getItem('bugly_reports') || '[]');
                            existing.push(logReport);
                            const reduced = existing.slice(-100);
                            localStorage.setItem('bugly_reports', JSON.stringify(reduced));
                            
                            return { 
                                success: true, 
                                warning: 'å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œå·²æ¸…ç†æ—§æ•°æ®ï¼ˆä»…ä¿ç•™æœ€è¿‘100æ¡ï¼‰'
                            };
                        } catch (e2) {
                            console.error('[Dashboard] æ— æ³•ä¿å­˜æ•°æ®ï¼Œå­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³');
                            return { 
                                success: false, 
                                error: 'å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³ï¼Œæ— æ³•ä¿å­˜æ—¥å¿—ã€‚è¯·æ¸…é™¤æ—§æ•°æ®åé‡è¯•ã€‚'
                            };
                        }
                    }
                    
                    console.error('[Dashboard] ä¿å­˜æ•°æ®å¤±è´¥:', e);
                    return { 
                        success: false, 
                        error: 'ä¿å­˜å¤±è´¥: ' + e.message
                    };
                }
            },
            
            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯ï¼ˆä¼˜åŒ–ç‰ˆï¼Œé˜²æ­¢å †ç§¯ï¼‰
            showToast(message, type = 'info') {
                // åˆå§‹åŒ– toast å®¹å™¨
                if (!this.toasts) {
                    this.toasts = [];
                }
                
                // é™åˆ¶åŒæ—¶æ˜¾ç¤ºçš„ toast æ•°é‡ï¼ˆæœ€å¤š3ä¸ªï¼‰
                if (this.toasts.length >= 3) {
                    const oldestToast = this.toasts.shift();
                    if (oldestToast && oldestToast.parentNode) {
                        oldestToast.parentNode.removeChild(oldestToast);
                    }
                }
                
                // åˆ›å»ºæç¤ºå…ƒç´ 
                const toast = document.createElement('div');
                toast.className = `toast-message toast-${type}`;
                
                // è®¡ç®—ä½ç½®ï¼ˆæ ¹æ®å·²æœ‰ toast æ•°é‡ï¼‰
                const topPosition = 20 + this.toasts.length * 70;
                
                toast.style.cssText = `
                    top: ${topPosition}px;
                    animation: slideInRight 0.3s ease-out;
                `;
                toast.textContent = message;
                
                // æ·»åŠ åˆ°æ•°ç»„
                this.toasts.push(toast);
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(toast);
                
                // ç‚¹å‡»å…³é—­
                const removeToast = () => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.parentNode.removeChild(toast);
                            }
                            // ä»æ•°ç»„ä¸­ç§»é™¤
                            const index = this.toasts.indexOf(toast);
                            if (index > -1) {
                                this.toasts.splice(index, 1);
                            }
                            // é‡æ–°å®šä½å‰©ä½™çš„ toast
                            this.repositionToasts();
                        }, 300);
                    }
                };
                
                toast.addEventListener('click', removeToast);
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(removeToast, 3000);
            },
            
            // é‡æ–°å®šä½æ‰€æœ‰ Toast
            repositionToasts() {
                if (!this.toasts) return;
                
                this.toasts.forEach((toast, index) => {
                    toast.style.top = `${20 + index * 70}px`;
                });
            }
        };
        
        // äº‹ä»¶å¤„ç†å™¨ï¼ˆä½¿ç”¨ addEventListenerï¼Œé¿å…è¦†ç›–å…¶ä»–å¤„ç†å™¨ï¼‰
        dashboard._modalClickHandler = function(event) {
            const modal = document.getElementById('logModal');
            if (event.target === modal) {
                dashboard.closeLogModal();
            }
        };
        
        dashboard._keydownHandler = function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('logModal');
                if (modal && modal.classList.contains('show')) {
                    dashboard.closeLogModal();
                }
            }
        };
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        window.addEventListener('click', dashboard._modalClickHandler);
        document.addEventListener('keydown', dashboard._keydownHandler);
        
        // æ¸…ç†å‡½æ•°ï¼ˆé¡µé¢å¸è½½æ—¶è°ƒç”¨ï¼‰
        dashboard.cleanup = function() {
            window.removeEventListener('click', this._modalClickHandler);
            document.removeEventListener('keydown', this._keydownHandler);
            console.log('[Dashboard] äº‹ä»¶ç›‘å¬å™¨å·²æ¸…ç†');
        };
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (dashboard.cleanup) {
                dashboard.cleanup();
            }
        });
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // åˆå§‹åŒ–
        dashboard.init();
    </script>
</body>
</html>

