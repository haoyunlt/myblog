<!-- 移动端图片加载增强脚本 -->
<script>
(function() {
    'use strict';
    
    // 图片加载增强
    function enhanceImageLoading() {
        const images = document.querySelectorAll('img');
        
        images.forEach(function(img) {
            // 添加错误处理
            img.onerror = function() {
                console.warn('图片加载失败:', this.src);
                this.style.background = '#f0f0f0';
                this.style.color = '#666';
                this.style.padding = '1rem';
                this.style.textAlign = 'center';
                this.style.border = '1px dashed #ccc';
                this.alt = '图片加载失败: ' + (this.alt || this.src);
            };
            
            // SVG特殊处理
            if (img.src && img.src.endsWith('.svg')) {
                img.style.transform = 'translateZ(0)';
                img.style.webkitTransform = 'translateZ(0)';
                img.style.imageRendering = 'optimizeQuality';
            }
            
            // 懒加载图片处理
            if (img.loading === 'lazy' && 'IntersectionObserver' in window) {
                const observer = new IntersectionObserver(function(entries) {
                    entries.forEach(function(entry) {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                                img.classList.add('loaded');
                            }
                            observer.unobserve(img);
                        }
                    });
                });
                
                if (img.dataset.src) {
                    observer.observe(img);
                }
            }
        });
    }
    
    // WebP支持检测
    function checkWebPSupport() {
        const webP = new Image();
        webP.onload = webP.onerror = function () {
            if (webP.height === 2) {
                document.documentElement.classList.add('webp');
            } else {
                document.documentElement.classList.add('no-webp');
            }
        };
        webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
    }
    
    // DOM加载完成后执行
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            enhanceImageLoading();
            checkWebPSupport();
        });
    } else {
        enhanceImageLoading();
        checkWebPSupport();
    }
    
    // 处理动态添加的图片
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        const images = node.tagName === 'IMG' ? [node] : node.querySelectorAll('img');
                        images.forEach(function(img) {
                            enhanceImageLoading();
                        });
                    }
                });
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
})();
</script>
