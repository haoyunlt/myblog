<!-- 移动端图片加载增强脚本 v2.0 - 添加参数验证 -->
<script>
(function() {
    'use strict';
    
    // 获取参数验证器
    const validator = window.mobileValidator || {
        isImage: function(v, n, f) {
            if (!(v instanceof HTMLImageElement)) {
                console.error(`[${f}] 参数 ${n} 必须是 HTMLImageElement`, v);
                return false;
            }
            return true;
        },
        notNull: function(v, n, f) {
            if (v === null || v === undefined) {
                console.error(`[${f}] 参数 ${n} 不能为 null/undefined`, v);
                return false;
            }
            return true;
        }
    };
    
    // 图片加载增强
    function enhanceImageLoading(targetElement) {
        try {
            // 如果没有提供目标元素，使用document
            const container = targetElement || document;
            
            // 验证容器
            if (!container || (!container.querySelectorAll && container !== document)) {
                console.error('[Image-Fix] enhanceImageLoading: 无效的容器元素', container);
                return;
            }
            
            const images = container.querySelectorAll('img');
            
            if (images.length === 0) {
                console.debug('[Image-Fix] 没有找到需要增强的图片');
                return;
            }
            
            console.log(`[Image-Fix] 开始增强 ${images.length} 个图片`);
            
            images.forEach(function(img, index) {
                // 验证每个图片元素
                if (!validator.isImage(img, `img[${index}]`, 'enhanceImageLoading')) {
                    return; // 跳过无效图片
                }
                
                // 检查图片是否已经增强过
                if (img.dataset.enhanced) {
                    return; // 跳过已增强的图片
                }
                
                // 标记为已增强
                img.dataset.enhanced = 'true';
                
                // 添加错误处理
                img.onerror = function() {
                    console.warn('[Image-Fix] 图片加载失败:', {
                        src: this.src,
                        alt: this.alt,
                        index: index
                    });
                    
                    try {
                        this.style.background = '#f0f0f0';
                        this.style.color = '#666';
                        this.style.padding = '1rem';
                        this.style.textAlign = 'center';
                        this.style.border = '1px dashed #ccc';
                        this.alt = '图片加载失败: ' + (this.alt || this.src);
                    } catch (e) {
                        console.error('[Image-Fix] 设置错误样式失败', e);
                    }
                };
                
                // SVG特殊处理
                if (img.src && typeof img.src === 'string' && img.src.endsWith('.svg')) {
                    try {
                        img.style.transform = 'translateZ(0)';
                        img.style.webkitTransform = 'translateZ(0)';
                        img.style.imageRendering = 'optimizeQuality';
                    } catch (e) {
                        console.warn('[Image-Fix] SVG样式设置失败', e);
                    }
                }
            
                // 懒加载图片处理
                if (img.loading === 'lazy' && 'IntersectionObserver' in window) {
                    try {
                        const observer = new IntersectionObserver(function(entries) {
                            // 验证entries
                            if (!entries || !Array.isArray(entries)) {
                                console.error('[Image-Fix] IntersectionObserver entries 无效', entries);
                                return;
                            }
                            
                            entries.forEach(function(entry) {
                                // 验证entry
                                if (!entry || typeof entry !== 'object') {
                                    console.warn('[Image-Fix] 无效的 IntersectionObserver entry', entry);
                                    return;
                                }
                                
                                if (!entry.target) {
                                    console.warn('[Image-Fix] entry.target 不存在');
                                    return;
                                }
                                
                                if (entry.isIntersecting) {
                                    const targetImg = entry.target;
                                    
                                    // 验证目标是图片元素
                                    if (!(targetImg instanceof HTMLImageElement)) {
                                        console.warn('[Image-Fix] entry.target 不是图片元素', targetImg);
                                        return;
                                    }
                                    
                                    if (targetImg.dataset.src) {
                                        try {
                                            targetImg.src = targetImg.dataset.src;
                                            targetImg.removeAttribute('data-src');
                                            targetImg.classList.add('loaded');
                                            console.debug('[Image-Fix] 懒加载图片成功', targetImg.src);
                                        } catch (e) {
                                            console.error('[Image-Fix] 懒加载图片失败', e);
                                        }
                                    }
                                    
                                    try {
                                        observer.unobserve(targetImg);
                                    } catch (e) {
                                        console.warn('[Image-Fix] unobserve 失败', e);
                                    }
                                }
                            });
                        });
                        
                        if (img.dataset.src) {
                            observer.observe(img);
                        }
                    } catch (e) {
                        console.error('[Image-Fix] IntersectionObserver 创建失败', e);
                    }
                }
            });
            
            console.log(`[Image-Fix] 图片增强完成，成功增强 ${images.length} 个图片`);
            
        } catch (e) {
            console.error('[Image-Fix] enhanceImageLoading 执行失败', e);
        }
    }
    
    // WebP支持检测
    function checkWebPSupport() {
        const webP = new Image();
        webP.onload = webP.onerror = function () {
            if (webP.height === 2) {
                document.documentElement.classList.add('webp');
            } else {
                document.documentElement.classList.add('no-webp');
            }
        };
        webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
    }
    
    // DOM加载完成后执行
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            enhanceImageLoading();
            checkWebPSupport();
        });
    } else {
        enhanceImageLoading();
        checkWebPSupport();
    }
    
    // 处理动态添加的图片（仅桌面端，移动端跳过避免性能问题）
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                     window.innerWidth <= 768;
    
    if (!isMobile) {
        // 确保DOM加载完成后再启动Observer
        function startImageObserver() {
            // 检查document.body是否存在
            if (!document.body) {
                console.warn('[Image-Fix] document.body不存在，延迟启动Observer');
                // 如果body不存在，等待DOM加载
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', startImageObserver);
                }
                return;
            }
            
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                const images = node.tagName === 'IMG' ? [node] : node.querySelectorAll('img');
                                images.forEach(function(img) {
                                    enhanceImageLoading();
                                });
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            console.log('[Image-Fix] 图片动态监控已启动（桌面端）');
        }
        
        // 启动Observer
        startImageObserver();
    } else {
        console.log('[Image-Fix] 移动端跳过MutationObserver');
    }
})();
</script>
