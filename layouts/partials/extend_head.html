{{- /* 扩展头部 - 添加Mermaid支持和其他功能 */ -}}
{{- /* 利用PaperMod主题的extend_head机制 */ -}}

{{- /* Mermaid图表支持 - 自动检测和渲染 */ -}}
{{- $hasMermaid := false -}}
{{- if .Params.mermaid -}}
  {{- $hasMermaid = true -}}
{{- else if .Site.Params.mermaid -}}
  {{- $hasMermaid = true -}}
{{- else if .RawContent -}}
  {{- if findRE "```mermaid" .RawContent -}}
    {{- $hasMermaid = true -}}
  {{- end -}}
{{- end -}}

{{- if $hasMermaid -}}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
<script>
// 等待页面完全加载
window.addEventListener('load', function() {
    // 初始化Mermaid
    mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        flowchart: { useMaxWidth: true },
        sequence: { useMaxWidth: true },
        gantt: { useMaxWidth: true },
        pie: { useMaxWidth: true },
        state: { useMaxWidth: true },
        class: { useMaxWidth: true }
    });
    
    // 查找并转换所有mermaid代码块（包括fallback类型和错误识别的类型）
    const codeBlocks = document.querySelectorAll('pre code');
    
    // 过滤出真正的mermaid代码块 - 增强检测逻辑
    const mermaidBlocks = Array.from(codeBlocks).filter(function(codeElement) {
        const content = codeElement.textContent.trim();
        const classList = codeElement.classList;
        
        // 检查类名或内容特征
        const hasMermaidClass = classList.contains('language-mermaid');
        
        // 增强的内容特征检测
        const mermaidPatterns = [
            /^graph\s+(TB|TD|BT|RL|LR)/,  // flowchart patterns
            /^sequenceDiagram/,
            /^classDiagram/,
            /^stateDiagram/,
            /^pie\s+title/,
            /^gantt/,
            /^flowchart\s+(TB|TD|BT|RL|LR)/,
            /participant\s+\w+/,  // sequence diagram participants
            /class\s+\w+\s*\{/,   // class definitions
            /\w+\s*-->\s*\w+/,    // flowchart arrows
            /\w+\s*->>\s*\w+/,    // sequence arrows
            /\w+\s*<\|\-\-\s*\w+/, // inheritance arrows
            /subgraph\s+/,        // subgraphs
            /%%.*classDef/,       // mermaid comments with styles
            /fill:#[0-9a-fA-F]{6}/, // color definitions
        ];
        
        const hasValidMermaidContent = mermaidPatterns.some(pattern => pattern.test(content));
        
        const isFallbackWithMermaid = (classList.contains('language-fallback') || 
                                      classList.contains('language-gdscript3') || 
                                      classList.contains('language-gdscript')) && hasValidMermaidContent;
        
        const shouldProcess = hasMermaidClass || isFallbackWithMermaid;
        
        // 调试日志
        if (shouldProcess) {
            console.log(`发现Mermaid代码块 - 类名: ${Array.from(classList).join(', ')}, 内容开头: ${content.substring(0, 50)}...`);
        }
        
        return shouldProcess;
    });
    
    console.log('找到Mermaid代码块数量:', mermaidBlocks.length);
    mermaidBlocks.forEach((block, index) => {
        console.log(`Mermaid块 ${index + 1}:`, block.textContent.substring(0, 100) + '...');
    });
    
    mermaidBlocks.forEach(function(codeElement, index) {
        const pre = codeElement.closest('pre');
        const mermaidCode = codeElement.textContent.trim();
        
        // 创建mermaid容器
        const container = document.createElement('div');
        container.className = 'mermaid-container';
        container.style.textAlign = 'center';
        container.style.margin = '2rem 0';
        container.style.padding = '1rem';
        container.style.border = '1px solid #e5e7eb';
        container.style.borderRadius = '8px';
        
        // 创建缩放控制按钮
        const zoomControls = document.createElement('div');
        zoomControls.className = 'mermaid-zoom-controls';
        
        const zoomInBtn = document.createElement('button');
        zoomInBtn.className = 'mermaid-zoom-btn';
        zoomInBtn.innerHTML = '+';
        zoomInBtn.title = '放大';
        
        const zoomOutBtn = document.createElement('button');
        zoomOutBtn.className = 'mermaid-zoom-btn';
        zoomOutBtn.innerHTML = '−';
        zoomOutBtn.title = '缩小';
        
        const resetBtn = document.createElement('button');
        resetBtn.className = 'mermaid-zoom-btn';
        resetBtn.innerHTML = '⌂';
        resetBtn.title = '重置';
        
        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-zoom-btn';
        fullscreenBtn.innerHTML = '⛶';
        fullscreenBtn.title = '全屏';
        
        zoomControls.appendChild(zoomInBtn);
        zoomControls.appendChild(zoomOutBtn);
        zoomControls.appendChild(resetBtn);
        zoomControls.appendChild(fullscreenBtn);
        
        // 创建缩放包装器
        const zoomWrapper = document.createElement('div');
        zoomWrapper.className = 'mermaid-zoom-wrapper';
        
        const mermaidDiv = document.createElement('div');
        mermaidDiv.className = 'mermaid';
        mermaidDiv.textContent = mermaidCode;
        
        zoomWrapper.appendChild(mermaidDiv);
        container.appendChild(zoomControls);
        container.appendChild(zoomWrapper);
        
        // 添加缩放功能
        let currentScale = 1;
        const minScale = 0.5;
        const maxScale = 3;
        const scaleStep = 0.2;
        
        function updateScale(scale) {
            currentScale = Math.max(minScale, Math.min(maxScale, scale));
            zoomWrapper.style.transform = `scale(${currentScale})`;
        }
        
        zoomInBtn.addEventListener('click', () => updateScale(currentScale + scaleStep));
        zoomOutBtn.addEventListener('click', () => updateScale(currentScale - scaleStep));
        resetBtn.addEventListener('click', () => updateScale(1));
        
        // 全屏功能
        fullscreenBtn.addEventListener('click', () => {
            if (container.classList.contains('mermaid-fullscreen')) {
                container.classList.remove('mermaid-fullscreen');
                document.body.style.overflow = '';
                fullscreenBtn.innerHTML = '⛶';
                fullscreenBtn.title = '全屏';
            } else {
                container.classList.add('mermaid-fullscreen');
                document.body.style.overflow = 'hidden';
                fullscreenBtn.innerHTML = '✕';
                fullscreenBtn.title = '退出全屏';
            }
        });
        
        // 鼠标滚轮缩放 - 降低敏感度
        let wheelTimeout;
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            
            // 降低缩放敏感度
            if (wheelTimeout) return;
            wheelTimeout = setTimeout(() => wheelTimeout = null, 150);
            
            const delta = e.deltaY > 0 ? -scaleStep * 0.5 : scaleStep * 0.5;
            updateScale(currentScale + delta);
        });
        
        // 双击重置
        container.addEventListener('dblclick', () => updateScale(1));
        
        // 拖拽功能
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;
        
        container.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('mermaid-zoom-btn')) return;
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            container.style.cursor = 'grabbing';
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            zoomWrapper.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                container.style.cursor = 'grab';
            }
        });
        
        // 触摸拖拽支持
        let touchStartX, touchStartY;
        
        container.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                touchStartX = touch.clientX - translateX;
                touchStartY = touch.clientY - translateY;
            }
        });
        
        container.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1) {
                e.preventDefault();
                const touch = e.touches[0];
                translateX = touch.clientX - touchStartX;
                translateY = touch.clientY - touchStartY;
                zoomWrapper.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
            }
        });
        
        // 重置时也重置位置
        resetBtn.addEventListener('click', () => {
            updateScale(1);
            translateX = translateY = 0;
            zoomWrapper.style.transform = `scale(1)`;
        });
        
        // ESC键退出全屏
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && container.classList.contains('mermaid-fullscreen')) {
                container.classList.remove('mermaid-fullscreen');
                document.body.style.overflow = '';
                fullscreenBtn.innerHTML = '⛶';
                fullscreenBtn.title = '全屏';
            }
        });
        
        // 替换原来的pre元素
        pre.parentNode.replaceChild(container, pre);
    });
    
    // 渲染所有mermaid图表
    setTimeout(function() {
        const mermaidElements = document.querySelectorAll('.mermaid');
        
        if (mermaidElements.length > 0) {
            mermaid.run().then(function() {
                // 确保SVG响应式
                document.querySelectorAll('.mermaid svg').forEach(function(svg) {
                    svg.style.maxWidth = '100%';
                    svg.style.height = 'auto';
                    // 修复移动端Chrome SVG显示问题
                    svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                    svg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
                    svg.style.display = 'block';
                    svg.style.margin = '0 auto';
                });
            }).catch(function(error) {
                console.error('Mermaid渲染失败:', error);
            });
        }
    }, 100);
});
</script>
{{- end -}}

{{- /* 数学公式支持 (KaTeX) */ -}}
{{- if or .Params.math (and .Site.Params.math (ne .Params.math false)) -}}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError: false
    });
});
</script>
{{- end -}}

{{- /* 代码复制功能已禁用 */ -}}

{{- /* 目录交互功能 */ -}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toc = document.querySelector('.toc');
    if (!toc) return;

    // 获取所有标题和目录链接
    const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
    const tocLinks = toc.querySelectorAll('a');
    
    // 创建目录切换按钮（移动端）
    const tocToggle = document.createElement('button');
    tocToggle.className = 'toc-toggle';
    tocToggle.innerHTML = '📋 目录';
    tocToggle.setAttribute('aria-label', '切换目录显示');
    
    const tocContent = document.createElement('div');
    tocContent.className = 'toc-content';
    
    // 移动目录内容到新容器
    const tocTitle = toc.querySelector('.toc-title');
    const tocList = toc.querySelector('ul');
    if (tocTitle) tocContent.appendChild(tocTitle);
    if (tocList) tocContent.appendChild(tocList);
    
    toc.appendChild(tocToggle);
    toc.appendChild(tocContent);
    
     // 目录切换功能 - 默认展开
     tocToggle.addEventListener('click', function() {
         tocToggle.classList.toggle('collapsed');
         tocContent.classList.toggle('hidden');
     });

    // 平滑滚动到目标章节
    tocLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                // 计算滚动位置（考虑固定头部）
                const headerHeight = document.querySelector('header')?.offsetHeight || 0;
                const targetPosition = targetElement.offsetTop - headerHeight - 20;
                
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
                
                 // 移动端保持目录展开状态
                 // 顶部TOC不需要自动关闭
            }
        });
    });

    // 滚动时高亮当前章节
    let currentActiveLink = null;
    
    function updateActiveLink() {
        let currentHeading = null;
        const scrollPosition = window.scrollY + 100; // 偏移量
        
        // 找到当前可视区域的标题
        for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            if (heading.offsetTop <= scrollPosition) {
                currentHeading = heading;
                break;
            }
        }
        
        // 更新目录链接的活动状态
        tocLinks.forEach(function(link) {
            link.classList.remove('active');
        });
        
        if (currentHeading) {
            const targetLink = toc.querySelector(`a[href="#${currentHeading.id}"]`);
            if (targetLink && targetLink !== currentActiveLink) {
                targetLink.classList.add('active');
                currentActiveLink = targetLink;
                
                // 确保活动链接在可视区域内
                if (toc.classList.contains('toc-fixed')) {
                    const tocRect = toc.getBoundingClientRect();
                    const linkRect = targetLink.getBoundingClientRect();
                    
                    if (linkRect.top < tocRect.top || linkRect.bottom > tocRect.bottom) {
                        targetLink.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
            }
        }
    }
    
    // 节流函数
    function throttle(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // 监听滚动事件
    window.addEventListener('scroll', throttle(updateActiveLink, 100));
    
    // 初始化
    updateActiveLink();
    
     // 响应式处理 - 顶部TOC布局
     function handleResize() {
         if (window.innerWidth >= 1200) {
             // 桌面端：隐藏切换按钮，显示目录
             tocToggle.style.display = 'none';
             tocContent.classList.remove('hidden');
         } else {
             // 移动端：显示切换按钮，默认展开
             tocToggle.style.display = 'flex';
             // 保持默认展开状态，不自动隐藏
         }
     }
    
    window.addEventListener('resize', throttle(handleResize, 250));
    handleResize(); // 初始化
    
    // 键盘导航支持
    document.addEventListener('keydown', function(e) {
        if (e.altKey && e.key === 't') {
            e.preventDefault();
            tocToggle.click();
        }
    });
    
    // 目录编号功能
    const tocNumbered = toc.querySelector('.toc-numbered');
    if (tocNumbered) {
        // 为标题添加编号
        let h2Counter = 0;
        let h3Counter = 0;
        
        headings.forEach(function(heading) {
            if (heading.tagName === 'H2') {
                h2Counter++;
                h3Counter = 0;
                const number = document.createElement('span');
                number.className = 'heading-number';
                number.textContent = h2Counter + '. ';
                heading.insertBefore(number, heading.firstChild);
            } else if (heading.tagName === 'H3') {
                h3Counter++;
                const number = document.createElement('span');
                number.className = 'heading-number';
                number.textContent = h2Counter + '.' + h3Counter + ' ';
                heading.insertBefore(number, heading.firstChild);
            }
        });
    }

     // ===== PaperMod 专用炫酷特效增强 =====
     
     // PaperMod 导航栏智能隐藏/显示
     let lastScrollTop = 0;
     const header = document.querySelector('.header');
     
     if (header) {
         window.addEventListener('scroll', throttle(function() {
             const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
             
             if (scrollTop > lastScrollTop && scrollTop > 100) {
                 // 向下滚动 - 隐藏导航栏
                 header.style.transform = 'translateY(-100%)';
                 header.style.opacity = '0.9';
             } else {
                 // 向上滚动 - 显示导航栏
                 header.style.transform = 'translateY(0)';
                 header.style.opacity = '1';
             }
             
             lastScrollTop = scrollTop;
         }, 100));
     }
     
     // PaperMod 文章条目视差效果
     const papermodPostEntries = document.querySelectorAll('.post-entry');
     papermodPostEntries.forEach((entry, index) => {
         entry.addEventListener('mouseenter', function() {
             this.style.transform = 'translateY(-8px) rotateX(5deg) rotateY(2deg)';
             this.style.zIndex = '10';
         });
         
         entry.addEventListener('mouseleave', function() {
             this.style.transform = 'translateY(0) rotateX(0) rotateY(0)';
             this.style.zIndex = '1';
         });
     });
     
     // PaperMod Logo 交互动画
     const logo = document.querySelector('.logo');
     if (logo) {
         let clickCount = 0;
         logo.addEventListener('click', function(e) {
             clickCount++;
             if (clickCount >= 5) {
                 // 彩蛋：连续点击5次触发特殊动画
                 document.body.style.animation = 'papermod-wobble 2s ease-in-out';
                 setTimeout(() => {
                     document.body.style.animation = '';
                     clickCount = 0;
                 }, 2000);
             }
         });
     }
     
     // PaperMod 社交图标动画增强
     const papermodSocialIcons = document.querySelectorAll('.social-icons a');
     papermodSocialIcons.forEach((icon, index) => {
         icon.addEventListener('mouseenter', function() {
             // 为其他图标添加轻微动画
             papermodSocialIcons.forEach((otherIcon, otherIndex) => {
                 if (otherIndex !== index) {
                     otherIcon.style.transform = 'scale(0.9) translateY(2px)';
                     otherIcon.style.opacity = '0.7';
                 }
             });
         });
         
         icon.addEventListener('mouseleave', function() {
             papermodSocialIcons.forEach(otherIcon => {
                 otherIcon.style.transform = '';
                 otherIcon.style.opacity = '';
             });
         });
     });
     
     // PaperMod 分类卡片3D效果
     const papermodCategoryCards = document.querySelectorAll('.category-card');
     papermodCategoryCards.forEach(card => {
         card.addEventListener('mousemove', function(e) {
             const rect = this.getBoundingClientRect();
             const x = e.clientX - rect.left;
             const y = e.clientY - rect.top;
             
             const centerX = rect.width / 2;
             const centerY = rect.height / 2;
             
             const rotateX = (y - centerY) / 10;
             const rotateY = (centerX - x) / 10;
             
             this.style.transform = `translateY(-10px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
         });
         
         card.addEventListener('mouseleave', function() {
             this.style.transform = 'translateY(0) rotateX(0) rotateY(0)';
         });
     });
     
     // PaperMod 搜索框动画增强
     const papermodSearchBox = document.querySelector('#searchbox input, .search-input');
     if (papermodSearchBox) {
         let searchTimeout;
         
         papermodSearchBox.addEventListener('input', function() {
             clearTimeout(searchTimeout);
             this.style.borderColor = 'var(--accent-color)';
             this.style.boxShadow = '0 0 15px rgba(245, 158, 11, 0.3)';
             
             searchTimeout = setTimeout(() => {
                 this.style.borderColor = '';
                 this.style.boxShadow = '';
             }, 1000);
         });
         
         papermodSearchBox.addEventListener('focus', function() {
             this.parentElement.style.transform = 'scale(1.05)';
             this.parentElement.style.transition = 'transform 0.3s ease';
         });
         
         papermodSearchBox.addEventListener('blur', function() {
             this.parentElement.style.transform = '';
         });
     }
     
     // PaperMod 标签云动画
     const papermodTags = document.querySelectorAll('.terms-tags a, .post-tags a');
     papermodTags.forEach((tag, index) => {
         // 随机延迟动画
         tag.style.animationDelay = `${Math.random() * 0.5}s`;
         
         tag.addEventListener('mouseenter', function() {
             // 为相邻标签添加轻微动画
             const siblings = Array.from(this.parentElement.children);
             const currentIndex = siblings.indexOf(this);
             
             siblings.forEach((sibling, siblingIndex) => {
                 if (Math.abs(siblingIndex - currentIndex) <= 2 && sibling !== this) {
                     sibling.style.transform = 'scale(0.95) translateY(2px)';
                     sibling.style.opacity = '0.8';
                 }
             });
         });
         
         tag.addEventListener('mouseleave', function() {
             const siblings = Array.from(this.parentElement.children);
             siblings.forEach(sibling => {
                 sibling.style.transform = '';
                 sibling.style.opacity = '';
             });
         });
     });
     
     // PaperMod 分页按钮增强
     const papermodPaginationLinks = document.querySelectorAll('.pagi a');
     papermodPaginationLinks.forEach(link => {
         link.addEventListener('click', function(e) {
             // 添加点击波纹效果
             const ripple = document.createElement('span');
             ripple.style.cssText = `
                 position: absolute;
                 border-radius: 50%;
                 background: rgba(255, 255, 255, 0.6);
                 transform: scale(0);
                 animation: ripple 0.6s linear;
                 pointer-events: none;
             `;
             
             const rect = this.getBoundingClientRect();
             const size = Math.max(rect.width, rect.height);
             ripple.style.width = ripple.style.height = size + 'px';
             ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
             ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
             
             this.appendChild(ripple);
             
             setTimeout(() => {
                 ripple.remove();
             }, 600);
         });
     });
     
     // PaperMod 主题切换动画增强
     const papermodThemeToggle = document.querySelector('.theme-toggle, #theme-toggle');
     if (papermodThemeToggle) {
         papermodThemeToggle.addEventListener('click', function() {
             // 添加主题切换过渡动画
             document.body.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
             
             // 创建切换效果
             const overlay = document.createElement('div');
             overlay.style.cssText = `
                 position: fixed;
                 top: 0;
                 left: 0;
                 width: 100%;
                 height: 100%;
                 background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.1) 100%);
                 z-index: 9999;
                 pointer-events: none;
                 opacity: 0;
                 transition: opacity 0.3s ease;
             `;
             
             document.body.appendChild(overlay);
             
             setTimeout(() => {
                 overlay.style.opacity = '1';
             }, 10);
             
             setTimeout(() => {
                 overlay.style.opacity = '0';
                 setTimeout(() => {
                     overlay.remove();
                     document.body.style.transition = '';
                 }, 300);
             }, 200);
         });
     }
     
     // PaperMod 代码块增强动画
     const papermodCodeBlocks = document.querySelectorAll('pre, .highlight');
     papermodCodeBlocks.forEach(block => {
         block.addEventListener('mouseenter', function() {
             this.style.transform = 'translateY(-2px) scale(1.01)';
             this.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.2)';
         });
         
         block.addEventListener('mouseleave', function() {
             this.style.transform = '';
             this.style.boxShadow = '';
         });
     });
     
     // ===== 炫酷特效增强 =====
    
    // 滚动动画观察器
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('revealed');
            }
        });
    }, observerOptions);

    // 为元素添加滚动动画
    const elementsToAnimate = document.querySelectorAll('h2, h3, .post-entry, blockquote, pre, table, .toc');
    elementsToAnimate.forEach(el => {
        el.classList.add('scroll-reveal');
        observer.observe(el);
    });

    // 页面加载进度条
    function createLoadingBar() {
        const loadingBar = document.createElement('div');
        loadingBar.className = 'loading-bar';
        document.body.appendChild(loadingBar);
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                setTimeout(() => {
                    loadingBar.style.opacity = '0';
                    setTimeout(() => loadingBar.remove(), 300);
                }, 200);
            }
            loadingBar.style.width = progress + '%';
        }, 100);
    }

    // 如果页面还在加载，显示进度条
    if (document.readyState === 'loading') {
        createLoadingBar();
    }

    // 为特定元素添加鼠标悬停光效
    const glowElements = document.querySelectorAll('.post-entry, .toc, pre');
    glowElements.forEach(el => {
        el.classList.add('hover-glow');
    });

    // 平滑滚动增强
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // 主题切换动画增强
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            document.body.style.transition = 'all 0.3s ease';
            setTimeout(() => {
                document.body.style.transition = '';
            }, 300);
        });
    }

    // 为代码块添加复制按钮动画
    const codeBlocks = document.querySelectorAll('pre');
    codeBlocks.forEach(block => {
        const copyBtn = block.querySelector('.copy-button');
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                this.style.animation = 'pulse 0.3s ease';
                setTimeout(() => {
                    this.style.animation = '';
                }, 300);
            });
        }
    });

    // 打字机效果（为特定标题添加）
    const heroTitle = document.querySelector('.post-title');
    if (heroTitle && heroTitle.textContent.length < 50) {
        heroTitle.classList.add('typewriter');
    }

    // 性能优化：减少动画在低性能设备上的影响
    if (navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4) {
        document.documentElement.style.setProperty('--animation-duration', '0.1s');
    }
});
</script>

{{- /* 引入图片修复脚本 */ -}}
{{- partial "image-fix.html" . -}}

{{- /* 图片交互增强脚本 */ -}}
<script>
// 普通图片的交互增强
(function() {
    'use strict';
    
    function enhanceRegularImages() {
        // 为所有content区域中的图片添加交互功能
        const contentImages = document.querySelectorAll('.post-content img, .page-content img, article img');
        
        contentImages.forEach(function(img) {
            // 跳过已经处理过的图片
            if (img.classList.contains('image-enhanced')) return;
            img.classList.add('image-enhanced');
            
            // 创建图片容器
            const container = document.createElement('div');
            container.className = 'enhanced-image-container';
            container.style.cssText = `
                position: relative;
                display: inline-block;
                max-width: 100%;
                overflow: hidden;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
                cursor: grab;
                user-select: none;
            `;
            
            // 包装图片
            img.parentNode.insertBefore(container, img);
            container.appendChild(img);
            
            // 创建控制按钮
            const controls = document.createElement('div');
            controls.className = 'image-controls';
            controls.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                display: flex;
                gap: 5px;
                opacity: 0;
                transition: opacity 0.3s ease;
                z-index: 10;
            `;
            
            const zoomInBtn = createControlButton('+', '放大');
            const zoomOutBtn = createControlButton('−', '缩小');
            const resetBtn = createControlButton('⌂', '重置');
            const fullscreenBtn = createControlButton('⛶', '全屏查看');
            
            controls.appendChild(zoomInBtn);
            controls.appendChild(zoomOutBtn);
            controls.appendChild(resetBtn);
            controls.appendChild(fullscreenBtn);
            container.appendChild(controls);
            
            // 显示/隐藏控制按钮
            container.addEventListener('mouseenter', () => {
                controls.style.opacity = '1';
            });
            container.addEventListener('mouseleave', () => {
                controls.style.opacity = '0';
            });
            
            // 图片交互功能
            let currentScale = 1;
            let translateX = 0, translateY = 0;
            let isDragging = false;
            let startX, startY;
            
            const minScale = 0.5;
            const maxScale = 4;
            const scaleStep = 0.25; // 降低缩放步长，减少敏感度
            
            function updateTransform() {
                img.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
                img.style.transformOrigin = 'center center';
                img.style.transition = isDragging ? 'none' : 'transform 0.3s ease';
            }
            
            function updateScale(scale) {
                currentScale = Math.max(minScale, Math.min(maxScale, scale));
                updateTransform();
            }
            
            // 缩放控制
            zoomInBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                updateScale(currentScale + scaleStep);
            });
            
            zoomOutBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                updateScale(currentScale - scaleStep);
            });
            
            resetBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                currentScale = 1;
                translateX = translateY = 0;
                updateTransform();
            });
            
            // 全屏查看
            fullscreenBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showFullscreen(img.src, img.alt);
            });
            
            // 滚轮缩放 - 降低敏感度
            let wheelTimeout;
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                // 防抖处理，降低敏感度
                if (wheelTimeout) return;
                wheelTimeout = setTimeout(() => wheelTimeout = null, 100);
                
                const delta = e.deltaY > 0 ? -scaleStep * 0.3 : scaleStep * 0.3; // 进一步降低敏感度
                updateScale(currentScale + delta);
            });
            
            // 拖拽功能
            container.addEventListener('mousedown', (e) => {
                if (e.target !== img && !e.target.closest('.image-controls')) {
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    container.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                translateX = (e.clientX - startX) / currentScale; // 考虑缩放比例
                translateY = (e.clientY - startY) / currentScale;
                updateTransform();
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    container.style.cursor = 'grab';
                }
            });
            
            // 触摸拖拽支持
            let touchStartX, touchStartY;
            
            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    touchStartX = touch.clientX - translateX;
                    touchStartY = touch.clientY - translateY;
                }
            });
            
            container.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    translateX = (touch.clientX - touchStartX) / currentScale;
                    translateY = (touch.clientY - touchStartY) / currentScale;
                    updateTransform();
                }
            });
            
            // 双击重置
            container.addEventListener('dblclick', () => {
                currentScale = 1;
                translateX = translateY = 0;
                updateTransform();
            });
        });
    }
    
    function createControlButton(text, title) {
        const btn = document.createElement('button');
        btn.innerHTML = text;
        btn.title = title;
        btn.style.cssText = `
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
        `;
        
        btn.addEventListener('mouseenter', () => {
            btn.style.background = 'rgba(0, 0, 0, 0.9)';
            btn.style.transform = 'scale(1.1)';
        });
        
        btn.addEventListener('mouseleave', () => {
            btn.style.background = 'rgba(0, 0, 0, 0.7)';
            btn.style.transform = 'scale(1)';
        });
        
        return btn;
    }
    
    function showFullscreen(src, alt) {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            cursor: pointer;
        `;
        
        const img = document.createElement('img');
        img.src = src;
        img.alt = alt;
        img.style.cssText = `
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '✕';
        closeBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            backdrop-filter: blur(5px);
        `;
        
        overlay.appendChild(img);
        overlay.appendChild(closeBtn);
        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';
        
        function closeFullscreen() {
            overlay.remove();
            document.body.style.overflow = '';
        }
        
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeFullscreen();
        });
        
        closeBtn.addEventListener('click', closeFullscreen);
        
        document.addEventListener('keydown', function escHandler(e) {
            if (e.key === 'Escape') {
                closeFullscreen();
                document.removeEventListener('keydown', escHandler);
            }
        });
    }
    
    // 页面加载完成后运行
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', enhanceRegularImages);
    } else {
        enhanceRegularImages();
    }
    
    // 监听动态内容变化
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) {
                        const images = node.tagName === 'IMG' ? [node] : node.querySelectorAll('img');
                        images.forEach(function() {
                            setTimeout(enhanceRegularImages, 100);
                        });
                    }
                });
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
})();
</script>
