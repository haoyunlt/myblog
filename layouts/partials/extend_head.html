{{- /* æ‰©å±•å¤´éƒ¨ - æ·»åŠ Mermaidæ”¯æŒå’Œå…¶ä»–åŠŸèƒ½ */ -}}
{{- /* åˆ©ç”¨PaperModä¸»é¢˜çš„extend_headæœºåˆ¶ */ -}}

{{- /* Mermaidå›¾è¡¨æ”¯æŒ - è‡ªåŠ¨æ£€æµ‹å’Œæ¸²æŸ“ */ -}}
{{- $hasMermaid := false -}}
{{- if .Params.mermaid -}}
  {{- $hasMermaid = true -}}
{{- else if .Site.Params.mermaid -}}
  {{- $hasMermaid = true -}}
{{- else if .RawContent -}}
  {{- if findRE "```mermaid" .RawContent -}}
    {{- $hasMermaid = true -}}
  {{- end -}}
{{- end -}}

{{- if $hasMermaid -}}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
<script>
// ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
window.addEventListener('load', function() {
    // åˆå§‹åŒ–Mermaid
    mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        flowchart: { useMaxWidth: true },
        sequence: { useMaxWidth: true },
        gantt: { useMaxWidth: true },
        pie: { useMaxWidth: true },
        state: { useMaxWidth: true },
        class: { useMaxWidth: true }
    });
    
    // æŸ¥æ‰¾å¹¶è½¬æ¢æ‰€æœ‰mermaidä»£ç å—ï¼ˆåŒ…æ‹¬fallbackç±»å‹å’Œé”™è¯¯è¯†åˆ«çš„ç±»å‹ï¼‰
    const codeBlocks = document.querySelectorAll('pre code.language-mermaid, pre code.language-fallback, pre code.language-gdscript3, pre code');
    
    // è¿‡æ»¤å‡ºçœŸæ­£çš„mermaidä»£ç å—
    const mermaidBlocks = Array.from(codeBlocks).filter(function(codeElement) {
        const content = codeElement.textContent.trim();
        return content.startsWith('graph ') || 
               content.startsWith('sequenceDiagram') || 
               content.startsWith('pie ') ||
               content.startsWith('gantt') ||
               content.startsWith('classDiagram') ||
               content.startsWith('stateDiagram') ||
               content.startsWith('stateDiagram-v2') ||
               content.startsWith('flowchart ') ||
               content.includes('-->') ||
               content.includes('->>') ||
               content.includes('-->>') ||
               content.includes('participant ');
    });
    
    mermaidBlocks.forEach(function(codeElement, index) {
        const pre = codeElement.closest('pre');
        const mermaidCode = codeElement.textContent.trim();
        
        // åˆ›å»ºmermaidå®¹å™¨
        const container = document.createElement('div');
        container.className = 'mermaid-container';
        container.style.textAlign = 'center';
        container.style.margin = '2rem 0';
        container.style.padding = '1rem';
        container.style.border = '1px solid #e5e7eb';
        container.style.borderRadius = '8px';
        
        const mermaidDiv = document.createElement('div');
        mermaidDiv.className = 'mermaid';
        mermaidDiv.textContent = mermaidCode;
        
        container.appendChild(mermaidDiv);
        
        // æ›¿æ¢åŸæ¥çš„preå…ƒç´ 
        pre.parentNode.replaceChild(container, pre);
    });
    
    // æ¸²æŸ“æ‰€æœ‰mermaidå›¾è¡¨
    setTimeout(function() {
        const mermaidElements = document.querySelectorAll('.mermaid');
        
        if (mermaidElements.length > 0) {
            mermaid.run().then(function() {
                // ç¡®ä¿SVGå“åº”å¼
                document.querySelectorAll('.mermaid svg').forEach(function(svg) {
                    svg.style.maxWidth = '100%';
                    svg.style.height = 'auto';
                });
            }).catch(function(error) {
                console.error('Mermaidæ¸²æŸ“å¤±è´¥:', error);
            });
        }
    }, 100);
});
</script>
{{- end -}}

{{- /* æ•°å­¦å…¬å¼æ”¯æŒ (KaTeX) */ -}}
{{- if or .Params.math (and .Site.Params.math (ne .Params.math false)) -}}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError: false
    });
});
</script>
{{- end -}}

{{- /* ä»£ç å¤åˆ¶åŠŸèƒ½å·²ç¦ç”¨ */ -}}

{{- /* ç›®å½•äº¤äº’åŠŸèƒ½ */ -}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toc = document.querySelector('.toc');
    if (!toc) return;

    // è·å–æ‰€æœ‰æ ‡é¢˜å’Œç›®å½•é“¾æ¥
    const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
    const tocLinks = toc.querySelectorAll('a');
    
    // åˆ›å»ºç›®å½•åˆ‡æ¢æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰
    const tocToggle = document.createElement('button');
    tocToggle.className = 'toc-toggle';
    tocToggle.innerHTML = 'ğŸ“‹ ç›®å½•';
    tocToggle.setAttribute('aria-label', 'åˆ‡æ¢ç›®å½•æ˜¾ç¤º');
    
    const tocContent = document.createElement('div');
    tocContent.className = 'toc-content';
    
    // ç§»åŠ¨ç›®å½•å†…å®¹åˆ°æ–°å®¹å™¨
    const tocTitle = toc.querySelector('.toc-title');
    const tocList = toc.querySelector('ul');
    if (tocTitle) tocContent.appendChild(tocTitle);
    if (tocList) tocContent.appendChild(tocList);
    
    toc.appendChild(tocToggle);
    toc.appendChild(tocContent);
    
    // ç›®å½•åˆ‡æ¢åŠŸèƒ½
    tocToggle.addEventListener('click', function() {
        tocToggle.classList.toggle('active');
        tocContent.classList.toggle('show');
    });

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ç« èŠ‚
    tocLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                // è®¡ç®—æ»šåŠ¨ä½ç½®ï¼ˆè€ƒè™‘å›ºå®šå¤´éƒ¨ï¼‰
                const headerHeight = document.querySelector('header')?.offsetHeight || 0;
                const targetPosition = targetElement.offsetTop - headerHeight - 20;
                
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
                
                // ç§»åŠ¨ç«¯å…³é—­ç›®å½•
                if (window.innerWidth < 1200) {
                    tocToggle.classList.remove('active');
                    tocContent.classList.remove('show');
                }
            }
        });
    });

    // æ»šåŠ¨æ—¶é«˜äº®å½“å‰ç« èŠ‚
    let currentActiveLink = null;
    
    function updateActiveLink() {
        let currentHeading = null;
        const scrollPosition = window.scrollY + 100; // åç§»é‡
        
        // æ‰¾åˆ°å½“å‰å¯è§†åŒºåŸŸçš„æ ‡é¢˜
        for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            if (heading.offsetTop <= scrollPosition) {
                currentHeading = heading;
                break;
            }
        }
        
        // æ›´æ–°ç›®å½•é“¾æ¥çš„æ´»åŠ¨çŠ¶æ€
        tocLinks.forEach(function(link) {
            link.classList.remove('active');
        });
        
        if (currentHeading) {
            const targetLink = toc.querySelector(`a[href="#${currentHeading.id}"]`);
            if (targetLink && targetLink !== currentActiveLink) {
                targetLink.classList.add('active');
                currentActiveLink = targetLink;
                
                // ç¡®ä¿æ´»åŠ¨é“¾æ¥åœ¨å¯è§†åŒºåŸŸå†…
                if (toc.classList.contains('toc-fixed')) {
                    const tocRect = toc.getBoundingClientRect();
                    const linkRect = targetLink.getBoundingClientRect();
                    
                    if (linkRect.top < tocRect.top || linkRect.bottom > tocRect.bottom) {
                        targetLink.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
            }
        }
    }
    
    // èŠ‚æµå‡½æ•°
    function throttle(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', throttle(updateActiveLink, 100));
    
    // åˆå§‹åŒ–
    updateActiveLink();
    
    // å“åº”å¼å¤„ç†
    function handleResize() {
        if (window.innerWidth >= 1200) {
            // æ¡Œé¢ç«¯ï¼šæ˜¾ç¤ºå›ºå®šç›®å½•
            toc.classList.add('toc-fixed');
            tocContent.classList.add('show');
            tocToggle.style.display = 'none';
        } else {
            // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
            toc.classList.remove('toc-fixed');
            tocToggle.style.display = 'flex';
            if (!tocToggle.classList.contains('active')) {
                tocContent.classList.remove('show');
            }
        }
    }
    
    window.addEventListener('resize', throttle(handleResize, 250));
    handleResize(); // åˆå§‹åŒ–
    
    // é”®ç›˜å¯¼èˆªæ”¯æŒ
    document.addEventListener('keydown', function(e) {
        if (e.altKey && e.key === 't') {
            e.preventDefault();
            tocToggle.click();
        }
    });
    
    // ç›®å½•ç¼–å·åŠŸèƒ½
    const tocNumbered = toc.querySelector('.toc-numbered');
    if (tocNumbered) {
        // ä¸ºæ ‡é¢˜æ·»åŠ ç¼–å·
        let h2Counter = 0;
        let h3Counter = 0;
        
        headings.forEach(function(heading) {
            if (heading.tagName === 'H2') {
                h2Counter++;
                h3Counter = 0;
                const number = document.createElement('span');
                number.className = 'heading-number';
                number.textContent = h2Counter + '. ';
                heading.insertBefore(number, heading.firstChild);
            } else if (heading.tagName === 'H3') {
                h3Counter++;
                const number = document.createElement('span');
                number.className = 'heading-number';
                number.textContent = h2Counter + '.' + h3Counter + ' ';
                heading.insertBefore(number, heading.firstChild);
            }
        });
    }

    // ===== ç‚«é…·ç‰¹æ•ˆå¢å¼º =====
    
    // æ»šåŠ¨åŠ¨ç”»è§‚å¯Ÿå™¨
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('revealed');
            }
        });
    }, observerOptions);

    // ä¸ºå…ƒç´ æ·»åŠ æ»šåŠ¨åŠ¨ç”»
    const elementsToAnimate = document.querySelectorAll('h2, h3, .post-entry, blockquote, pre, table, .toc');
    elementsToAnimate.forEach(el => {
        el.classList.add('scroll-reveal');
        observer.observe(el);
    });

    // é¡µé¢åŠ è½½è¿›åº¦æ¡
    function createLoadingBar() {
        const loadingBar = document.createElement('div');
        loadingBar.className = 'loading-bar';
        document.body.appendChild(loadingBar);
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                setTimeout(() => {
                    loadingBar.style.opacity = '0';
                    setTimeout(() => loadingBar.remove(), 300);
                }, 200);
            }
            loadingBar.style.width = progress + '%';
        }, 100);
    }

    // å¦‚æœé¡µé¢è¿˜åœ¨åŠ è½½ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
    if (document.readyState === 'loading') {
        createLoadingBar();
    }

    // ä¸ºç‰¹å®šå…ƒç´ æ·»åŠ é¼ æ ‡æ‚¬åœå…‰æ•ˆ
    const glowElements = document.querySelectorAll('.post-entry, .toc, pre');
    glowElements.forEach(el => {
        el.classList.add('hover-glow');
    });

    // å¹³æ»‘æ»šåŠ¨å¢å¼º
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // ä¸»é¢˜åˆ‡æ¢åŠ¨ç”»å¢å¼º
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            document.body.style.transition = 'all 0.3s ease';
            setTimeout(() => {
                document.body.style.transition = '';
            }, 300);
        });
    }

    // ä¸ºä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®åŠ¨ç”»
    const codeBlocks = document.querySelectorAll('pre');
    codeBlocks.forEach(block => {
        const copyBtn = block.querySelector('.copy-button');
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                this.style.animation = 'pulse 0.3s ease';
                setTimeout(() => {
                    this.style.animation = '';
                }, 300);
            });
        }
    });

    // æ‰“å­—æœºæ•ˆæœï¼ˆä¸ºç‰¹å®šæ ‡é¢˜æ·»åŠ ï¼‰
    const heroTitle = document.querySelector('.post-title');
    if (heroTitle && heroTitle.textContent.length < 50) {
        heroTitle.classList.add('typewriter');
    }

    // æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŠ¨ç”»åœ¨ä½æ€§èƒ½è®¾å¤‡ä¸Šçš„å½±å“
    if (navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4) {
        document.documentElement.style.setProperty('--animation-duration', '0.1s');
    }
});
</script>
