{{- /* æ‰©å±•å¤´éƒ¨ - æ·»åŠ Mermaidæ”¯æŒå’Œå…¶ä»–åŠŸèƒ½ */ -}}
{{- /* åˆ©ç”¨PaperModä¸»é¢˜çš„extend_headæœºåˆ¶ */ -}}

{{- /* é˜²æ­¢HTMLè¢«ç¼“å­˜ - ç¡®ä¿ç”¨æˆ·å§‹ç»ˆè·å–æœ€æ–°ç‰ˆæœ¬ */ -}}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

{{- /* å†…å­˜æ³„æ¼ç´§æ€¥ä¿®å¤è¡¥ä¸ - å¿…é¡»æœ€å…ˆåŠ è½½ */ -}}
<script src="{{ "js/memory-leak-fix.js" | relURL }}"></script>

{{- /* ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–CSS - å…³é”®æ¸²æŸ“è·¯å¾„ */ -}}
<link rel="stylesheet" href="/css/extended/mobile-performance.css" media="screen and (max-width: 768px)">

{{- /* ç§»åŠ¨ç«¯è°ƒè¯•ç³»ç»Ÿ - å¢å¼ºç‰ˆ */ -}}
<script>
(function() {
    'use strict';
    
    // å¢å¼ºçš„ç§»åŠ¨ç«¯è°ƒè¯•å·¥å…·
    window.MobileDebug = {
        logs: [],
        errors: [],
        warnings: [],
        performance: [],
        maxLogs: 200,
        maxErrors: 100,
        
        // æ—¥å¿—çº§åˆ«
        levels: {
            DEBUG: 'DEBUG',
            INFO: 'INFO',
            WARN: 'WARN',
            ERROR: 'ERROR',
            FATAL: 'FATAL'
        },
        
        // é€šç”¨æ—¥å¿—æ–¹æ³•
        _log: function(level, message, data, error) {
            try {
                const entry = {
                    time: new Date().toISOString(),
                    timestamp: Date.now(),
                    level: level,
                    message: message,
                    data: data || null,
                    error: error ? {
                        message: error.message || error.toString(),
                        stack: error.stack || '',
                        name: error.name || 'Error'
                    } : null,
                    context: {
                        userAgent: navigator.userAgent,
                        viewport: window.innerWidth + 'x' + window.innerHeight,
                        url: window.location.href,
                        pathname: window.location.pathname,
                        referrer: document.referrer || 'direct',
                        online: navigator.onLine,
                        cookieEnabled: navigator.cookieEnabled,
                        language: navigator.language,
                        platform: navigator.platform,
                        memory: performance.memory ? {
                            used: Math.round(performance.memory.usedJSHeapSize / 1048576) + 'MB',
                            total: Math.round(performance.memory.totalJSHeapSize / 1048576) + 'MB',
                            limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576) + 'MB'
                        } : 'N/A'
                    }
                };
                
                // æ ¹æ®çº§åˆ«å­˜å‚¨
                if (level === this.levels.ERROR || level === this.levels.FATAL) {
                    this.errors.push(entry);
                    console.error(`[${level}]`, message, data || '', error || '');
                } else if (level === this.levels.WARN) {
                    this.warnings.push(entry);
                    console.warn(`[${level}]`, message, data || '');
                } else {
                    this.logs.push(entry);
                    console.log(`[${level}]`, message, data || '');
                }
                
                // é™åˆ¶æ•°ç»„å¤§å°
                if (this.logs.length > this.maxLogs) {
                    this.logs.splice(0, this.logs.length - this.maxLogs);
                }
                if (this.errors.length > this.maxErrors) {
                    this.errors.splice(0, this.errors.length - this.maxErrors);
                }
                if (this.warnings.length > this.maxErrors) {
                    this.warnings.splice(0, this.warnings.length - this.maxErrors);
                }
                
                // æŒä¹…åŒ–å­˜å‚¨
                this._persistToStorage(level, entry);
                
                return entry;
            } catch (e) {
                // æœ€åçš„å®‰å…¨ç½‘ï¼šå³ä½¿æ—¥å¿—ç³»ç»Ÿå¤±è´¥ä¹Ÿä¸èƒ½è®©é¡µé¢å´©æºƒ
                console.error('è°ƒè¯•ç³»ç»Ÿå†…éƒ¨é”™è¯¯:', e);
            }
        },
        
        // æŒä¹…åŒ–åˆ°localStorage
        _persistToStorage: function(level, entry) {
            try {
                const key = level === this.levels.ERROR || level === this.levels.FATAL 
                    ? 'mobile_debug_errors' 
                    : level === this.levels.WARN
                    ? 'mobile_debug_warnings'
                    : 'mobile_debug_logs';
                
                const stored = JSON.parse(localStorage.getItem(key) || '[]');
                stored.push(entry);
                
                const limit = key === 'mobile_debug_errors' ? 100 : 200;
                if (stored.length > limit) {
                    stored.splice(0, stored.length - limit);
                }
                
                localStorage.setItem(key, JSON.stringify(stored));
            } catch (e) {
                // localStorageå¯èƒ½è¢«ç¦ç”¨æˆ–å·²æ»¡
                console.warn('æ— æ³•æŒä¹…åŒ–æ—¥å¿—:', e.message);
            }
        },
        
        // å…¬å¼€çš„æ—¥å¿—æ–¹æ³•
        debug: function(message, data) {
            return this._log(this.levels.DEBUG, message, data);
        },
        
        log: function(message, data) {
            return this._log(this.levels.INFO, message, data);
        },
        
        info: function(message, data) {
            return this._log(this.levels.INFO, message, data);
        },
        
        warn: function(message, data) {
            return this._log(this.levels.WARN, message, data);
        },
        
        error: function(message, errorOrData, additionalData) {
            const error = errorOrData instanceof Error ? errorOrData : null;
            const data = error ? additionalData : errorOrData;
            return this._log(this.levels.ERROR, message, data, error);
        },
        
        fatal: function(message, errorOrData, additionalData) {
            const error = errorOrData instanceof Error ? errorOrData : null;
            const data = error ? additionalData : errorOrData;
            return this._log(this.levels.FATAL, message, data, error);
        },
        
        // æ€§èƒ½ç›‘æ§
        perf: function(name, duration, details) {
            try {
                const entry = {
                    time: new Date().toISOString(),
                    name: name,
                    duration: duration,
                    details: details || null
                };
                
                this.performance.push(entry);
                console.log(`[PERF] ${name}: ${duration.toFixed(2)}ms`, details || '');
                
                if (this.performance.length > 100) {
                    this.performance.splice(0, this.performance.length - 100);
                }
            } catch (e) {
                console.error('æ€§èƒ½æ—¥å¿—å¤±è´¥:', e);
            }
        },
        
        // æ€§èƒ½è®¡æ—¶å™¨
        startTimer: function(name) {
            try {
                const key = `_timer_${name}`;
                this[key] = performance.now();
                this.debug(`è®¡æ—¶å™¨å¯åŠ¨: ${name}`);
            } catch (e) {
                this.error('å¯åŠ¨è®¡æ—¶å™¨å¤±è´¥', e);
            }
        },
        
        endTimer: function(name, details) {
            try {
                const key = `_timer_${name}`;
                if (this[key]) {
                    const duration = performance.now() - this[key];
                    this.perf(name, duration, details);
                    delete this[key];
                    return duration;
                } else {
                    this.warn(`è®¡æ—¶å™¨ä¸å­˜åœ¨: ${name}`);
                }
            } catch (e) {
                this.error('ç»“æŸè®¡æ—¶å™¨å¤±è´¥', e);
            }
        },
        
        // ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
        getReport: function() {
            try {
                return {
                    timestamp: new Date().toISOString(),
                    summary: {
                        totalLogs: this.logs.length,
                        totalWarnings: this.warnings.length,
                        totalErrors: this.errors.length,
                        totalPerf: this.performance.length
                    },
                    context: {
                        userAgent: navigator.userAgent,
                        url: window.location.href,
                        viewport: window.innerWidth + 'x' + window.innerHeight,
                        online: navigator.onLine,
                        connection: navigator.connection ? {
                            effectiveType: navigator.connection.effectiveType,
                            downlink: navigator.connection.downlink,
                            rtt: navigator.connection.rtt
                        } : 'N/A',
                        memory: performance.memory ? {
                            used: Math.round(performance.memory.usedJSHeapSize / 1048576) + 'MB',
                            total: Math.round(performance.memory.totalJSHeapSize / 1048576) + 'MB'
                        } : 'N/A'
                    },
                    logs: this.logs.slice(-50),
                    warnings: this.warnings.slice(-20),
                    errors: this.errors,
                    performance: this.performance.slice(-20),
                    stored: {
                        logs: JSON.parse(localStorage.getItem('mobile_debug_logs') || '[]'),
                        warnings: JSON.parse(localStorage.getItem('mobile_debug_warnings') || '[]'),
                        errors: JSON.parse(localStorage.getItem('mobile_debug_errors') || '[]')
                    }
                };
            } catch (e) {
                console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', e);
                return { error: e.message };
            }
        },
        
        // æ¸…ç©ºæ—¥å¿—
        clear: function() {
            try {
                this.logs = [];
                this.warnings = [];
                this.errors = [];
                this.performance = [];
                localStorage.removeItem('mobile_debug_logs');
                localStorage.removeItem('mobile_debug_warnings');
                localStorage.removeItem('mobile_debug_errors');
                console.log('è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º');
            } catch (e) {
                console.error('æ¸…ç©ºæ—¥å¿—å¤±è´¥:', e);
            }
        }
    };
    
    const debug = window.MobileDebug;
    
    try {
        debug.log('ğŸš€ ç§»åŠ¨ç«¯è°ƒè¯•ç³»ç»Ÿå¯åŠ¨ v2.0');
        debug.info('è®¾å¤‡ä¿¡æ¯', {
            mobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            userAgent: navigator.userAgent,
            viewport: window.innerWidth + 'x' + window.innerHeight,
            pixelRatio: window.devicePixelRatio,
            colorDepth: screen.colorDepth,
            platform: navigator.platform
        });
        
        // å…¨å±€é”™è¯¯æ•è·
        window.addEventListener('error', function(e) {
            try {
                debug.error('å…¨å±€JavaScripté”™è¯¯', {
                    message: e.message,
                    filename: e.filename,
                    lineno: e.lineno,
                    colno: e.colno,
                    error: e.error
                });
            } catch (err) {
                console.error('é”™è¯¯å¤„ç†å™¨å¤±è´¥:', err);
            }
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            try {
                debug.error('æœªæ•è·çš„Promiseæ‹’ç»', e.reason);
            } catch (err) {
                console.error('Promiseé”™è¯¯å¤„ç†å™¨å¤±è´¥:', err);
            }
        });
        
        // é¡µé¢åŠ è½½ç›‘æ§
        window.addEventListener('load', function() {
            try {
                debug.log('é¡µé¢åŠ è½½å®Œæˆ');
                
                // æ€§èƒ½æŒ‡æ ‡
                if (window.performance && window.performance.timing) {
                    const timing = window.performance.timing;
                    const metrics = {
                        DNSæŸ¥è¯¢: timing.domainLookupEnd - timing.domainLookupStart,
                        TCPè¿æ¥: timing.connectEnd - timing.connectStart,
                        è¯·æ±‚å“åº”: timing.responseEnd - timing.requestStart,
                        DOMè§£æ: timing.domInteractive - timing.domLoading,
                        DOMå®Œæˆ: timing.domComplete - timing.domLoading,
                        é¡µé¢åŠ è½½: timing.loadEventEnd - timing.navigationStart
                    };
                    debug.info('é¡µé¢æ€§èƒ½æŒ‡æ ‡', metrics);
                }
            } catch (e) {
                debug.error('é¡µé¢åŠ è½½ç›‘æ§å¤±è´¥', e);
            }
        });
        
        // èµ„æºåŠ è½½é”™è¯¯ç›‘æ§
        window.addEventListener('error', function(e) {
            try {
                if (e.target !== window) {
                    debug.warn('èµ„æºåŠ è½½å¤±è´¥', {
                        tagName: e.target.tagName,
                        src: e.target.src || e.target.href,
                        currentSrc: e.target.currentSrc
                    });
                }
            } catch (err) {
                console.error('èµ„æºé”™è¯¯ç›‘æ§å¤±è´¥:', err);
            }
        }, true);
        
        // æ·»åŠ å…¨å±€è°ƒè¯•å‡½æ•°
        window.getDebugReport = function() {
            try {
                const report = debug.getReport();
                console.group('ğŸ“± ç§»åŠ¨ç«¯è°ƒè¯•æŠ¥å‘Š');
                console.log(JSON.stringify(report, null, 2));
                console.groupEnd();
                return report;
            } catch (e) {
                console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', e);
                return null;
            }
        };
        
        window.clearDebugLogs = function() {
            debug.clear();
        };
        
        // å¯¼å‡ºæ—¥å¿—åˆ°æ–‡ä»¶
        window.exportDebugReport = function() {
            try {
                const report = debug.getReport();
                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `debug-report-${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                debug.log('è°ƒè¯•æŠ¥å‘Šå·²å¯¼å‡º');
            } catch (e) {
                debug.error('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥', e);
            }
        };
        
        debug.log('è°ƒè¯•ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', {
            functions: ['getDebugReport()', 'clearDebugLogs()', 'exportDebugReport()']
        });
        
    } catch (e) {
        console.error('è°ƒè¯•ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', e);
    }
})();
</script>

{{- /* Mermaidå›¾è¡¨æ”¯æŒ - è‡ªåŠ¨æ£€æµ‹å’Œæ¸²æŸ“ */ -}}
{{- $hasMermaid := false -}}
{{- if .Params.mermaid -}}
  {{- $hasMermaid = true -}}
{{- else if .Site.Params.mermaid -}}
  {{- $hasMermaid = true -}}
{{- else if .RawContent -}}
  {{- if findRE "```mermaid" .RawContent -}}
    {{- $hasMermaid = true -}}
  {{- end -}}
{{- end -}}

{{- if $hasMermaid -}}
{{- /* ä½¿ç”¨å›½å†…CDNåŠ è½½Mermaid.jsï¼ˆå¤šçº§å¤‡ç”¨ï¼Œç¡®ä¿åŠ è½½æˆåŠŸï¼‰ */ -}}
<script src="https://cdn.bootcdn.net/ajax/libs/mermaid/10.9.0/mermaid.min.js" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://unpkg.com/mermaid@10.9.0/dist/mermaid.min.js';this.onerror=function(){this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js';}"></script>
<script>
// ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
window.addEventListener('load', function() {
    const debug = window.MobileDebug;
    
    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                     window.innerWidth <= 768;
    
    try {
        debug.startTimer('mermaid-initialization');
        debug.log('å¼€å§‹åˆå§‹åŒ–Mermaidå›¾è¡¨ç³»ç»Ÿ');
        
        // æ£€æŸ¥Mermaidæ˜¯å¦åŠ è½½
        if (typeof mermaid === 'undefined') {
            debug.error('Mermaidåº“æœªåŠ è½½');
            console.error('âŒ Mermaidåº“æœªåŠ è½½ï¼è¯·æ£€æŸ¥CDNæ˜¯å¦å¯è®¿é—®');
            return;
        }
        debug.log('âœ… Mermaidåº“å·²æˆåŠŸåŠ è½½', { version: mermaid.version || 'unknown' });
        
        // åˆå§‹åŒ–Mermaid - ç§»åŠ¨ç«¯ä½¿ç”¨ç®€åŒ–é…ç½®
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            flowchart: { useMaxWidth: true, htmlLabels: !isMobile }, // ç§»åŠ¨ç«¯ç¦ç”¨HTMLæ ‡ç­¾
            sequence: { useMaxWidth: true, mirrorActors: !isMobile },
            gantt: { useMaxWidth: true },
            pie: { useMaxWidth: true },
            state: { useMaxWidth: true },
            class: { useMaxWidth: true },
            securityLevel: 'loose',
            maxTextSize: isMobile ? 50000 : 100000 // ç§»åŠ¨ç«¯é™åˆ¶æ–‡æœ¬å¤§å°
        });
        
        debug.log('Mermaidé…ç½®åˆå§‹åŒ–æˆåŠŸï¼ˆç§»åŠ¨ç«¯: ' + isMobile + 'ï¼‰');
    } catch (e) {
        debug.error('Mermaidåˆå§‹åŒ–å¤±è´¥', e);
        return;
    }
    
    // æŸ¥æ‰¾å¹¶è½¬æ¢æ‰€æœ‰mermaidä»£ç å—ï¼ˆåŒ…æ‹¬fallbackç±»å‹å’Œé”™è¯¯è¯†åˆ«çš„ç±»å‹ï¼‰
    let codeBlocks, mermaidBlocks;
    
    try {
        debug.debug('å¼€å§‹æŸ¥æ‰¾Mermaidä»£ç å—');
        codeBlocks = document.querySelectorAll('pre code');
        debug.log(`æ‰¾åˆ°${codeBlocks.length}ä¸ªä»£ç å—`);
    } catch (e) {
        debug.error('æŸ¥æ‰¾ä»£ç å—å¤±è´¥', e);
        return;
    }
    
    // è¿‡æ»¤å‡ºçœŸæ­£çš„mermaidä»£ç å— - å¢å¼ºæ£€æµ‹é€»è¾‘
    try {
        mermaidBlocks = Array.from(codeBlocks).filter(function(codeElement) {
            try {
                const content = codeElement.textContent.trim();
                const classList = codeElement.classList;
                const classNames = Array.from(classList).join(', ');
                
                // æ£€æŸ¥ç±»åæˆ–å†…å®¹ç‰¹å¾
                const hasMermaidClass = classList.contains('language-mermaid');
                
                // å¢å¼ºçš„å†…å®¹ç‰¹å¾æ£€æµ‹
                const mermaidPatterns = [
                    /^graph\s+(TB|TD|BT|RL|LR)/,  // flowchart patterns
                    /^sequenceDiagram/,
                    /^classDiagram/,
                    /^stateDiagram/,
                    /^pie\s+title/,
                    /^gantt/,
                    /^flowchart\s+(TB|TD|BT|RL|LR)/,
                    /participant\s+\w+/,  // sequence diagram participants
                    /class\s+\w+\s*\{/,   // class definitions
                    /\w+\s*-->\s*\w+/,    // flowchart arrows
                    /\w+\s*->>\s*\w+/,    // sequence arrows
                    /\w+\s*<\|\-\-\s*\w+/, // inheritance arrows
                    /subgraph\s+/,        // subgraphs
                    /%%.*classDef/,       // mermaid comments with styles
                    /fill:#[0-9a-fA-F]{6}/, // color definitions
                ];
                
                const hasValidMermaidContent = mermaidPatterns.some(pattern => pattern.test(content));
                
                // æ‰©å±•fallbackæ£€æµ‹ï¼ŒåŒ…å«æ›´å¤šå¯èƒ½çš„é”™è¯¯ç±»å
                const isFallbackWithMermaid = (
                    classList.contains('language-fallback') || 
                    classList.contains('language-gdscript3') || 
                    classList.contains('language-gdscript') ||
                    classList.contains('language-text') ||
                    classList.contains('language-plaintext') ||
                    !classNames.includes('language-')  // æ²¡æœ‰language-å‰ç¼€çš„ä»£ç å—
                ) && hasValidMermaidContent;
                
                const shouldProcess = hasMermaidClass || isFallbackWithMermaid;
                
                // å¢å¼ºè°ƒè¯•æ—¥å¿—
                if (shouldProcess || hasValidMermaidContent) {
                    debug.log(`${shouldProcess ? 'âœ…' : 'âš ï¸'} ä»£ç å—æ£€æµ‹`, {
                        shouldProcess,
                        classes: classNames || '(æ— ç±»å)',
                        hasMermaidClass,
                        hasValidMermaidContent,
                        contentPreview: content.substring(0, 80).replace(/\n/g, ' ')
                    });
                }
                
                return shouldProcess;
            } catch (e) {
                debug.warn('è¿‡æ»¤ä»£ç å—æ—¶å‡ºé”™', e);
                return false;
            }
        });
        
        debug.log(`è¯†åˆ«åˆ°${mermaidBlocks.length}ä¸ªMermaidä»£ç å—`);
        mermaidBlocks.forEach((block, index) => {
            try {
                debug.debug(`Mermaidå— ${index + 1}`, {
                    contentPreview: block.textContent.substring(0, 100)
                });
            } catch (e) {
                debug.warn(`è®°å½•Mermaidå— ${index + 1} ä¿¡æ¯å¤±è´¥`, e);
            }
        });
    } catch (e) {
        debug.error('è¿‡æ»¤Mermaidä»£ç å—å¤±è´¥', e);
        return;
    }
    
    // ç§»åŠ¨ç«¯é™åˆ¶Mermaidå›¾è¡¨æ•°é‡
    const maxMermaidBlocks = isMobile ? 10 : mermaidBlocks.length;
    const blocksToProcess = Array.from(mermaidBlocks).slice(0, maxMermaidBlocks);
    
    if (isMobile && mermaidBlocks.length > maxMermaidBlocks) {
        debug.warn(`ç§»åŠ¨ç«¯é™åˆ¶ï¼šä»…æ¸²æŸ“å‰ ${maxMermaidBlocks} ä¸ªå›¾è¡¨ï¼ˆå…± ${mermaidBlocks.length} ä¸ªï¼‰`);
    }
    
    blocksToProcess.forEach(function(codeElement, index) {
        try {
            debug.startTimer(`mermaid-block-${index}`);
            debug.debug(`å¤„ç†Mermaidå— ${index + 1}/${blocksToProcess.length}`);
            
            const pre = codeElement.closest('pre');
            if (!pre) {
                debug.warn(`Mermaidå— ${index + 1}: æ‰¾ä¸åˆ°çˆ¶çº§preå…ƒç´ `);
                return;
            }
            
            const mermaidCode = codeElement.textContent.trim();
            if (!mermaidCode) {
                debug.warn(`Mermaidå— ${index + 1}: ä»£ç å†…å®¹ä¸ºç©º`);
                return;
            }
            
            // ç§»åŠ¨ç«¯ï¼šé™åˆ¶ä»£ç é•¿åº¦
            if (isMobile && mermaidCode.length > 5000) {
                debug.warn(`Mermaidå— ${index + 1}: ä»£ç è¿‡é•¿ (${mermaidCode.length}å­—ç¬¦)ï¼Œè·³è¿‡`);
                return;
            }
            
            debug.debug(`Mermaidå— ${index + 1}: ä»£ç é•¿åº¦ ${mermaidCode.length}`);
            
            // åˆ›å»ºmermaidå®¹å™¨
            const container = document.createElement('div');
            container.className = 'mermaid-container';
            container.style.textAlign = 'center';
            container.style.margin = '2rem 0';
            container.style.padding = '1rem';
            container.style.border = '1px solid #e5e7eb';
            container.style.borderRadius = '8px';
        
        // ç§»åŠ¨ç«¯ï¼šç®€åŒ–æ§åˆ¶æŒ‰é’®ï¼Œä»…ä¿ç•™å…¨å±
        const zoomControls = document.createElement('div');
        zoomControls.className = 'mermaid-zoom-controls';
        
        let zoomInBtn, zoomOutBtn, resetBtn;
        
        if (!isMobile) {
            // æ¡Œé¢ç«¯ï¼šå®Œæ•´çš„ç¼©æ”¾æ§åˆ¶
            zoomInBtn = document.createElement('button');
            zoomInBtn.className = 'mermaid-zoom-btn';
            zoomInBtn.innerHTML = '+';
            zoomInBtn.title = 'æ”¾å¤§';
            
            zoomOutBtn = document.createElement('button');
            zoomOutBtn.className = 'mermaid-zoom-btn';
            zoomOutBtn.innerHTML = 'âˆ’';
            zoomOutBtn.title = 'ç¼©å°';
            
            resetBtn = document.createElement('button');
            resetBtn.className = 'mermaid-zoom-btn';
            resetBtn.innerHTML = 'âŒ‚';
            resetBtn.title = 'é‡ç½®';
            
            zoomControls.appendChild(zoomInBtn);
            zoomControls.appendChild(zoomOutBtn);
            zoomControls.appendChild(resetBtn);
        }
        
        // å…¨å±æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯éƒ½æœ‰ï¼‰
        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-zoom-btn';
        fullscreenBtn.innerHTML = 'â›¶';
        fullscreenBtn.title = 'å…¨å±';
        
        zoomControls.appendChild(fullscreenBtn);
        
        // åˆ›å»ºç¼©æ”¾åŒ…è£…å™¨
        const zoomWrapper = document.createElement('div');
        zoomWrapper.className = 'mermaid-zoom-wrapper';
        
        const mermaidDiv = document.createElement('div');
        mermaidDiv.className = 'mermaid';
        mermaidDiv.textContent = mermaidCode;
        
        zoomWrapper.appendChild(mermaidDiv);
        container.appendChild(zoomControls);
        container.appendChild(zoomWrapper);
        
        // æ·»åŠ ç¼©æ”¾åŠŸèƒ½ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰
        let currentScale = 1;
        const minScale = 0.5;
        const maxScale = 3;
        const scaleStep = 0.2;
        
        function updateScale(scale) {
            currentScale = Math.max(minScale, Math.min(maxScale, scale));
            zoomWrapper.style.transform = `scale(${currentScale})`;
        }
        
        // æ¡Œé¢ç«¯ï¼šæ·»åŠ ç¼©æ”¾æŒ‰é’®äº‹ä»¶
        if (!isMobile) {
            zoomInBtn.addEventListener('click', () => updateScale(currentScale + scaleStep));
            zoomOutBtn.addEventListener('click', () => updateScale(currentScale - scaleStep));
            resetBtn.addEventListener('click', () => updateScale(1));
        }
        
        // å…¨å±åŠŸèƒ½
        fullscreenBtn.addEventListener('click', () => {
            if (container.classList.contains('mermaid-fullscreen')) {
                container.classList.remove('mermaid-fullscreen');
                document.body.style.overflow = '';
                fullscreenBtn.innerHTML = 'â›¶';
                fullscreenBtn.title = 'å…¨å±';
            } else {
                container.classList.add('mermaid-fullscreen');
                document.body.style.overflow = 'hidden';
                fullscreenBtn.innerHTML = 'âœ•';
                fullscreenBtn.title = 'é€€å‡ºå…¨å±';
            }
        });
        
        // æ¡Œé¢ç«¯ï¼šé¼ æ ‡æ»šè½®ç¼©æ”¾å’Œæ‹–æ‹½åŠŸèƒ½
        if (!isMobile) {
            // é¼ æ ‡æ»šè½®ç¼©æ”¾ - é™ä½æ•æ„Ÿåº¦
            let wheelTimeout;
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                // é™ä½ç¼©æ”¾æ•æ„Ÿåº¦
                if (wheelTimeout) return;
                wheelTimeout = setTimeout(() => wheelTimeout = null, 150);
                
                const delta = e.deltaY > 0 ? -scaleStep * 0.5 : scaleStep * 0.5;
                updateScale(currentScale + delta);
            }, { passive: false });
            
            // åŒå‡»é‡ç½®
            container.addEventListener('dblclick', () => updateScale(1));
            
            // æ‹–æ‹½åŠŸèƒ½
            let isDragging = false;
            let startX, startY, translateX = 0, translateY = 0;
            
            container.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('mermaid-zoom-btn')) return;
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                container.style.cursor = 'grabbing';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                zoomWrapper.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    container.style.cursor = 'grab';
                }
            });
            
            // é‡ç½®æ—¶ä¹Ÿé‡ç½®ä½ç½®
            resetBtn.addEventListener('click', () => {
                updateScale(1);
                translateX = translateY = 0;
                zoomWrapper.style.transform = `scale(1)`;
            });
        }
        // ç§»åŠ¨ç«¯ï¼šä»…æ”¯æŒè§¦æ‘¸ç¼©æ”¾ï¼ˆä½¿ç”¨åŸç”Ÿç¼©æ”¾ï¼‰
        else {
            container.style.touchAction = 'pinch-zoom';
        }
        
        // ESCé”®é€€å‡ºå…¨å±
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && container.classList.contains('mermaid-fullscreen')) {
                container.classList.remove('mermaid-fullscreen');
                document.body.style.overflow = '';
                fullscreenBtn.innerHTML = 'â›¶';
                fullscreenBtn.title = 'å…¨å±';
            }
        });
        
            // æ›¿æ¢åŸæ¥çš„preå…ƒç´ 
            try {
                pre.parentNode.replaceChild(container, pre);
                debug.debug(`Mermaidå— ${index + 1}: DOMæ›¿æ¢æˆåŠŸ`);
            } catch (e) {
                debug.error(`Mermaidå— ${index + 1}: DOMæ›¿æ¢å¤±è´¥`, e);
            }
            
        } catch (e) {
            debug.error(`å¤„ç†Mermaidå— ${index + 1} å¤±è´¥`, e, {
                blockIndex: index,
                totalBlocks: mermaidBlocks.length
            });
        } finally {
            try {
                debug.endTimer(`mermaid-block-${index}`);
            } catch (e) {
                // å¿½ç•¥è®¡æ—¶å™¨é”™è¯¯
            }
        }
    });
    
    // æ¸²æŸ“æ‰€æœ‰mermaidå›¾è¡¨
    setTimeout(function() {
        try {
            debug.startTimer('mermaid-rendering');
            debug.log('å¼€å§‹æ¸²æŸ“Mermaidå›¾è¡¨');
            
            const mermaidElements = document.querySelectorAll('.mermaid');
            debug.log(`æ‰¾åˆ°${mermaidElements.length}ä¸ªå¾…æ¸²æŸ“çš„Mermaidå…ƒç´ `);
            
            if (mermaidElements.length > 0) {
                mermaid.run().then(function() {
                    try {
                        debug.log('Mermaidæ¸²æŸ“å®Œæˆï¼Œå¼€å§‹ä¼˜åŒ–SVG');
                        
                        // ç¡®ä¿SVGå“åº”å¼
                        const svgElements = document.querySelectorAll('.mermaid svg');
                        debug.log(`ä¼˜åŒ–${svgElements.length}ä¸ªSVGå…ƒç´ `);
                        
                        svgElements.forEach(function(svg, idx) {
                            try {
                                svg.style.maxWidth = '100%';
                                svg.style.height = 'auto';
                                // ä¿®å¤ç§»åŠ¨ç«¯Chrome SVGæ˜¾ç¤ºé—®é¢˜
                                svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                                svg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
                                svg.style.display = 'block';
                                svg.style.margin = '0 auto';
                                
                                debug.debug(`SVG ${idx + 1}/${svgElements.length} ä¼˜åŒ–å®Œæˆ`);
                            } catch (e) {
                                debug.warn(`ä¼˜åŒ–SVG ${idx + 1} å¤±è´¥`, e);
                            }
                        });
                        
                        debug.log('æ‰€æœ‰SVGä¼˜åŒ–å®Œæˆ');
                        debug.endTimer('mermaid-rendering', { svgCount: svgElements.length });
                    } catch (e) {
                        debug.error('SVGä¼˜åŒ–è¿‡ç¨‹å¤±è´¥', e);
                    }
                }).catch(function(error) {
                    debug.error('Mermaidæ¸²æŸ“å¤±è´¥', error);
                    debug.endTimer('mermaid-rendering');
                });
            } else {
                debug.warn('æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¸²æŸ“çš„Mermaidå…ƒç´ ');
            }
        } catch (e) {
            debug.error('Mermaidæ¸²æŸ“å¯åŠ¨å¤±è´¥', e);
        }
    }, 100);
    
    try {
        debug.endTimer('mermaid-initialization');
        debug.log('Mermaidå›¾è¡¨ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    } catch (e) {
        // å¿½ç•¥
    }
});
</script>
{{- end -}}

{{- /* æ•°å­¦å…¬å¼æ”¯æŒ (KaTeX) */ -}}
{{- if or .Params.math (and .Site.Params.math (ne .Params.math false)) -}}
<link rel="stylesheet" href="{{ "css/katex.min.css" | relURL }}">
<script defer src="{{ "js/katex.min.js" | relURL }}"></script>
<script defer src="{{ "js/katex-auto-render.min.js" | relURL }}"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError: false
    });
});
</script>
{{- end -}}

{{- /* ä»£ç å¤åˆ¶åŠŸèƒ½å·²ç¦ç”¨ */ -}}

{{- /* ç›®å½•äº¤äº’åŠŸèƒ½ */ -}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const debug = window.MobileDebug;
    
    try {
        debug.startTimer('toc-initialization');
        debug.log('å¼€å§‹åˆå§‹åŒ–ç›®å½•äº¤äº’åŠŸèƒ½');
        
        const toc = document.querySelector('.toc');
        if (!toc) {
            debug.debug('é¡µé¢æ²¡æœ‰ç›®å½•å…ƒç´ ');
            return;
        }
        
        debug.log('æ‰¾åˆ°ç›®å½•å…ƒç´ ');

        // è·å–æ‰€æœ‰æ ‡é¢˜å’Œç›®å½•é“¾æ¥
        const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const tocLinks = toc.querySelectorAll('a');
        
        debug.log(`æ‰¾åˆ°${headings.length}ä¸ªæ ‡é¢˜ï¼Œ${tocLinks.length}ä¸ªç›®å½•é“¾æ¥`);
    
    // åˆ›å»ºç›®å½•åˆ‡æ¢æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰
    const tocToggle = document.createElement('button');
    tocToggle.className = 'toc-toggle';
    tocToggle.innerHTML = 'ğŸ“‹ ç›®å½•';
    tocToggle.setAttribute('aria-label', 'åˆ‡æ¢ç›®å½•æ˜¾ç¤º');
    
    const tocContent = document.createElement('div');
    tocContent.className = 'toc-content';
    
    // ç§»åŠ¨ç›®å½•å†…å®¹åˆ°æ–°å®¹å™¨
    const tocTitle = toc.querySelector('.toc-title');
    const tocList = toc.querySelector('ul');
    if (tocTitle) tocContent.appendChild(tocTitle);
    if (tocList) tocContent.appendChild(tocList);
    
    toc.appendChild(tocToggle);
    toc.appendChild(tocContent);
    
     // ç›®å½•åˆ‡æ¢åŠŸèƒ½ - é»˜è®¤å±•å¼€
     tocToggle.addEventListener('click', function() {
         tocToggle.classList.toggle('collapsed');
         tocContent.classList.toggle('hidden');
     });

    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ç« èŠ‚
    tocLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                // è®¡ç®—æ»šåŠ¨ä½ç½®ï¼ˆè€ƒè™‘å›ºå®šå¤´éƒ¨ï¼‰
                const headerHeight = document.querySelector('header')?.offsetHeight || 0;
                const targetPosition = targetElement.offsetTop - headerHeight - 20;
                
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
                
                 // ç§»åŠ¨ç«¯ä¿æŒç›®å½•å±•å¼€çŠ¶æ€
                 // é¡¶éƒ¨TOCä¸éœ€è¦è‡ªåŠ¨å…³é—­
            }
        });
    });

    // æ»šåŠ¨æ—¶é«˜äº®å½“å‰ç« èŠ‚
    let currentActiveLink = null;
    
    function updateActiveLink() {
        let currentHeading = null;
        const scrollPosition = window.scrollY + 100; // åç§»é‡
        
        // æ‰¾åˆ°å½“å‰å¯è§†åŒºåŸŸçš„æ ‡é¢˜
        for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            if (heading.offsetTop <= scrollPosition) {
                currentHeading = heading;
                break;
            }
        }
        
        // æ›´æ–°ç›®å½•é“¾æ¥çš„æ´»åŠ¨çŠ¶æ€
        tocLinks.forEach(function(link) {
            link.classList.remove('active');
        });
        
        if (currentHeading) {
            const targetLink = toc.querySelector(`a[href="#${currentHeading.id}"]`);
            if (targetLink && targetLink !== currentActiveLink) {
                targetLink.classList.add('active');
                currentActiveLink = targetLink;
                
                // ç¡®ä¿æ´»åŠ¨é“¾æ¥åœ¨å¯è§†åŒºåŸŸå†…
                if (toc.classList.contains('toc-fixed')) {
                    const tocRect = toc.getBoundingClientRect();
                    const linkRect = targetLink.getBoundingClientRect();
                    
                    if (linkRect.top < tocRect.top || linkRect.bottom > tocRect.bottom) {
                        targetLink.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
            }
        }
    }
    
    // èŠ‚æµå‡½æ•°
    function throttle(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', throttle(updateActiveLink, 100));
    
    // åˆå§‹åŒ–
    updateActiveLink();
    
     // å“åº”å¼å¤„ç† - é¡¶éƒ¨TOCå¸ƒå±€
     function handleResize() {
         if (window.innerWidth >= 1200) {
             // æ¡Œé¢ç«¯ï¼šéšè—åˆ‡æ¢æŒ‰é’®ï¼Œæ˜¾ç¤ºç›®å½•
             tocToggle.style.display = 'none';
             tocContent.classList.remove('hidden');
         } else {
             // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®ï¼Œé»˜è®¤å±•å¼€
             tocToggle.style.display = 'flex';
             // ä¿æŒé»˜è®¤å±•å¼€çŠ¶æ€ï¼Œä¸è‡ªåŠ¨éšè—
         }
     }
    
    window.addEventListener('resize', throttle(handleResize, 250));
    handleResize(); // åˆå§‹åŒ–
    
    // é”®ç›˜å¯¼èˆªæ”¯æŒ
    document.addEventListener('keydown', function(e) {
        if (e.altKey && e.key === 't') {
            e.preventDefault();
            tocToggle.click();
        }
    });
    
    // ç›®å½•ç¼–å·åŠŸèƒ½
    const tocNumbered = toc.querySelector('.toc-numbered');
    if (tocNumbered) {
        // ä¸ºæ ‡é¢˜æ·»åŠ ç¼–å·
        let h2Counter = 0;
        let h3Counter = 0;
        
        headings.forEach(function(heading) {
            if (heading.tagName === 'H2') {
                h2Counter++;
                h3Counter = 0;
                const number = document.createElement('span');
                number.className = 'heading-number';
                number.textContent = h2Counter + '. ';
                heading.insertBefore(number, heading.firstChild);
            } else if (heading.tagName === 'H3') {
                h3Counter++;
                const number = document.createElement('span');
                number.className = 'heading-number';
                number.textContent = h2Counter + '.' + h3Counter + ' ';
                heading.insertBefore(number, heading.firstChild);
            }
        });
    }

     // ===== PaperMod ä¸“ç”¨ç‚«é…·ç‰¹æ•ˆå¢å¼º =====
     
     // PaperMod å¯¼èˆªæ æ™ºèƒ½éšè—/æ˜¾ç¤º
     let lastScrollTop = 0;
     const header = document.querySelector('.header');
     
     if (header) {
         window.addEventListener('scroll', throttle(function() {
             const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
             
             if (scrollTop > lastScrollTop && scrollTop > 100) {
                 // å‘ä¸‹æ»šåŠ¨ - éšè—å¯¼èˆªæ 
                 header.style.transform = 'translateY(-100%)';
                 header.style.opacity = '0.9';
             } else {
                 // å‘ä¸Šæ»šåŠ¨ - æ˜¾ç¤ºå¯¼èˆªæ 
                 header.style.transform = 'translateY(0)';
                 header.style.opacity = '1';
             }
             
             lastScrollTop = scrollTop;
         }, 100));
     }
     
     // PaperMod æ–‡ç« æ¡ç›®è§†å·®æ•ˆæœ
     const papermodPostEntries = document.querySelectorAll('.post-entry');
     papermodPostEntries.forEach((entry, index) => {
         entry.addEventListener('mouseenter', function() {
             this.style.transform = 'translateY(-8px) rotateX(5deg) rotateY(2deg)';
             this.style.zIndex = '10';
         });
         
         entry.addEventListener('mouseleave', function() {
             this.style.transform = 'translateY(0) rotateX(0) rotateY(0)';
             this.style.zIndex = '1';
         });
     });
     
     // PaperMod Logo äº¤äº’åŠ¨ç”»
     const logo = document.querySelector('.logo');
     if (logo) {
         let clickCount = 0;
         logo.addEventListener('click', function(e) {
             clickCount++;
             if (clickCount >= 5) {
                 // å½©è›‹ï¼šè¿ç»­ç‚¹å‡»5æ¬¡è§¦å‘ç‰¹æ®ŠåŠ¨ç”»
                 document.body.style.animation = 'papermod-wobble 2s ease-in-out';
                 setTimeout(() => {
                     document.body.style.animation = '';
                     clickCount = 0;
                 }, 2000);
             }
         });
     }
     
     // PaperMod ç¤¾äº¤å›¾æ ‡åŠ¨ç”»å¢å¼º
     const papermodSocialIcons = document.querySelectorAll('.social-icons a');
     papermodSocialIcons.forEach((icon, index) => {
         icon.addEventListener('mouseenter', function() {
             // ä¸ºå…¶ä»–å›¾æ ‡æ·»åŠ è½»å¾®åŠ¨ç”»
             papermodSocialIcons.forEach((otherIcon, otherIndex) => {
                 if (otherIndex !== index) {
                     otherIcon.style.transform = 'scale(0.9) translateY(2px)';
                     otherIcon.style.opacity = '0.7';
                 }
             });
         });
         
         icon.addEventListener('mouseleave', function() {
             papermodSocialIcons.forEach(otherIcon => {
                 otherIcon.style.transform = '';
                 otherIcon.style.opacity = '';
             });
         });
     });
     
     // PaperMod åˆ†ç±»å¡ç‰‡3Dæ•ˆæœ
     const papermodCategoryCards = document.querySelectorAll('.category-card');
     papermodCategoryCards.forEach(card => {
         card.addEventListener('mousemove', function(e) {
             const rect = this.getBoundingClientRect();
             const x = e.clientX - rect.left;
             const y = e.clientY - rect.top;
             
             const centerX = rect.width / 2;
             const centerY = rect.height / 2;
             
             const rotateX = (y - centerY) / 10;
             const rotateY = (centerX - x) / 10;
             
             this.style.transform = `translateY(-10px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
         });
         
         card.addEventListener('mouseleave', function() {
             this.style.transform = 'translateY(0) rotateX(0) rotateY(0)';
         });
     });
     
     // PaperMod æœç´¢æ¡†åŠ¨ç”»å¢å¼º
     const papermodSearchBox = document.querySelector('#searchbox input, .search-input');
     if (papermodSearchBox) {
         let searchTimeout;
         
         papermodSearchBox.addEventListener('input', function() {
             clearTimeout(searchTimeout);
             this.style.borderColor = 'var(--accent-color)';
             this.style.boxShadow = '0 0 15px rgba(245, 158, 11, 0.3)';
             
             searchTimeout = setTimeout(() => {
                 this.style.borderColor = '';
                 this.style.boxShadow = '';
             }, 1000);
         });
         
         papermodSearchBox.addEventListener('focus', function() {
             this.parentElement.style.transform = 'scale(1.05)';
             this.parentElement.style.transition = 'transform 0.3s ease';
         });
         
         papermodSearchBox.addEventListener('blur', function() {
             this.parentElement.style.transform = '';
         });
     }
     
     // PaperMod æ ‡ç­¾äº‘åŠ¨ç”»
     const papermodTags = document.querySelectorAll('.terms-tags a, .post-tags a');
     papermodTags.forEach((tag, index) => {
         // éšæœºå»¶è¿ŸåŠ¨ç”»
         tag.style.animationDelay = `${Math.random() * 0.5}s`;
         
         tag.addEventListener('mouseenter', function() {
             // ä¸ºç›¸é‚»æ ‡ç­¾æ·»åŠ è½»å¾®åŠ¨ç”»
             const siblings = Array.from(this.parentElement.children);
             const currentIndex = siblings.indexOf(this);
             
             siblings.forEach((sibling, siblingIndex) => {
                 if (Math.abs(siblingIndex - currentIndex) <= 2 && sibling !== this) {
                     sibling.style.transform = 'scale(0.95) translateY(2px)';
                     sibling.style.opacity = '0.8';
                 }
             });
         });
         
         tag.addEventListener('mouseleave', function() {
             const siblings = Array.from(this.parentElement.children);
             siblings.forEach(sibling => {
                 sibling.style.transform = '';
                 sibling.style.opacity = '';
             });
         });
     });
     
     // PaperMod åˆ†é¡µæŒ‰é’®å¢å¼º
     const papermodPaginationLinks = document.querySelectorAll('.pagi a');
     papermodPaginationLinks.forEach(link => {
         link.addEventListener('click', function(e) {
             // æ·»åŠ ç‚¹å‡»æ³¢çº¹æ•ˆæœ
             const ripple = document.createElement('span');
             ripple.style.cssText = `
                 position: absolute;
                 border-radius: 50%;
                 background: rgba(255, 255, 255, 0.6);
                 transform: scale(0);
                 animation: ripple 0.6s linear;
                 pointer-events: none;
             `;
             
             const rect = this.getBoundingClientRect();
             const size = Math.max(rect.width, rect.height);
             ripple.style.width = ripple.style.height = size + 'px';
             ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
             ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
             
             this.appendChild(ripple);
             
             setTimeout(() => {
                 ripple.remove();
             }, 600);
         });
     });
     
     // PaperMod ä¸»é¢˜åˆ‡æ¢åŠ¨ç”»å¢å¼º
     const papermodThemeToggle = document.querySelector('.theme-toggle, #theme-toggle');
     if (papermodThemeToggle) {
         papermodThemeToggle.addEventListener('click', function() {
             // æ·»åŠ ä¸»é¢˜åˆ‡æ¢è¿‡æ¸¡åŠ¨ç”»
             document.body.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
             
             // åˆ›å»ºåˆ‡æ¢æ•ˆæœ
             const overlay = document.createElement('div');
             overlay.style.cssText = `
                 position: fixed;
                 top: 0;
                 left: 0;
                 width: 100%;
                 height: 100%;
                 background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.1) 100%);
                 z-index: 9999;
                 pointer-events: none;
                 opacity: 0;
                 transition: opacity 0.3s ease;
             `;
             
             document.body.appendChild(overlay);
             
             setTimeout(() => {
                 overlay.style.opacity = '1';
             }, 10);
             
             setTimeout(() => {
                 overlay.style.opacity = '0';
                 setTimeout(() => {
                     overlay.remove();
                     document.body.style.transition = '';
                 }, 300);
             }, 200);
         });
     }
     
     // PaperMod ä»£ç å—å¢å¼ºåŠ¨ç”»
     const papermodCodeBlocks = document.querySelectorAll('pre, .highlight');
     papermodCodeBlocks.forEach(block => {
         block.addEventListener('mouseenter', function() {
             this.style.transform = 'translateY(-2px) scale(1.01)';
             this.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.2)';
         });
         
         block.addEventListener('mouseleave', function() {
             this.style.transform = '';
             this.style.boxShadow = '';
         });
     });
     
     // ===== ç‚«é…·ç‰¹æ•ˆå¢å¼º =====
    
    // æ»šåŠ¨åŠ¨ç”»è§‚å¯Ÿå™¨
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('revealed');
            }
        });
    }, observerOptions);

    // ä¸ºå…ƒç´ æ·»åŠ æ»šåŠ¨åŠ¨ç”»
    const elementsToAnimate = document.querySelectorAll('h2, h3, .post-entry, blockquote, pre, table, .toc');
    elementsToAnimate.forEach(el => {
        el.classList.add('scroll-reveal');
        observer.observe(el);
    });

    // é¡µé¢åŠ è½½è¿›åº¦æ¡
    function createLoadingBar() {
        const loadingBar = document.createElement('div');
        loadingBar.className = 'loading-bar';
        document.body.appendChild(loadingBar);
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                setTimeout(() => {
                    loadingBar.style.opacity = '0';
                    setTimeout(() => loadingBar.remove(), 300);
                }, 200);
            }
            loadingBar.style.width = progress + '%';
        }, 100);
    }

    // å¦‚æœé¡µé¢è¿˜åœ¨åŠ è½½ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
    if (document.readyState === 'loading') {
        createLoadingBar();
    }

    // ä¸ºç‰¹å®šå…ƒç´ æ·»åŠ é¼ æ ‡æ‚¬åœå…‰æ•ˆ
    const glowElements = document.querySelectorAll('.post-entry, .toc, pre');
    glowElements.forEach(el => {
        el.classList.add('hover-glow');
    });

    // å¹³æ»‘æ»šåŠ¨å¢å¼º - ä¿®å¤URLç¼–ç é€‰æ‹©å™¨é—®é¢˜
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            try {
                const href = this.getAttribute('href');
                if (!href || href === '#') return;
                
                // æå–IDï¼ˆå»æ‰#å·ï¼‰
                const id = href.substring(1);
                
                // å…ˆå°è¯•è§£ç URLï¼ˆå¤„ç†ä¸­æ–‡ç­‰ç¼–ç å­—ç¬¦ï¼‰
                let decodedId = id;
                try {
                    decodedId = decodeURIComponent(id);
                } catch (decodeError) {
                    // è§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ID
                }
                
                // ä¼˜å…ˆä½¿ç”¨getElementByIdï¼ˆä¸å—URLç¼–ç å½±å“ï¼‰
                let target = document.getElementById(decodedId);
                
                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•ä½¿ç”¨åŸå§‹ID
                if (!target && id !== decodedId) {
                    target = document.getElementById(id);
                }
                
                // æœ€åä½¿ç”¨querySelector with CSS.escapeï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (!target && typeof CSS !== 'undefined' && CSS.escape) {
                    try {
                        target = document.querySelector('#' + CSS.escape(decodedId));
                    } catch (e) {
                        // å¿½ç•¥é€‰æ‹©å™¨é”™è¯¯
                    }
                }
                
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            } catch (e) {
                console.error('[ScrollEnhance] å¹³æ»‘æ»šåŠ¨å¤±è´¥', e);
            }
        });
    });

    // ä¸»é¢˜åˆ‡æ¢åŠ¨ç”»å¢å¼º
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            document.body.style.transition = 'all 0.3s ease';
            setTimeout(() => {
                document.body.style.transition = '';
            }, 300);
        });
    }

    // ä¸ºä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®åŠ¨ç”»
    const codeBlocks = document.querySelectorAll('pre');
    codeBlocks.forEach(block => {
        const copyBtn = block.querySelector('.copy-button');
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                this.style.animation = 'pulse 0.3s ease';
                setTimeout(() => {
                    this.style.animation = '';
                }, 300);
            });
        }
    });

    // æ‰“å­—æœºæ•ˆæœï¼ˆä¸ºç‰¹å®šæ ‡é¢˜æ·»åŠ ï¼‰
    const heroTitle = document.querySelector('.post-title');
    if (heroTitle && heroTitle.textContent.length < 50) {
        heroTitle.classList.add('typewriter');
    }

    // æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŠ¨ç”»åœ¨ä½æ€§èƒ½è®¾å¤‡ä¸Šçš„å½±å“
    try {
        if (navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4) {
            document.documentElement.style.setProperty('--animation-duration', '0.1s');
            debug.log(`æ£€æµ‹åˆ°ä½æ€§èƒ½è®¾å¤‡(${navigator.hardwareConcurrency}æ ¸å¿ƒ)ï¼Œå·²é™ä½åŠ¨ç”»å¤æ‚åº¦`);
        }
    } catch (e) {
        debug.warn('æ€§èƒ½ä¼˜åŒ–è®¾ç½®å¤±è´¥', e);
    }
    
    debug.endTimer('toc-initialization');
    debug.log('ç›®å½•å’Œé¡µé¢å¢å¼ºåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    
    } catch (e) {
        debug.error('DOMContentLoadedå¤„ç†å¤±è´¥', e);
    }
});
</script>

{{- /* å¼•å…¥å›¾ç‰‡ä¿®å¤è„šæœ¬ */ -}}
{{- partial "image-fix.html" . -}}

{{- /* å›¾ç‰‡äº¤äº’å¢å¼ºè„šæœ¬ - ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆ */ -}}
<script>
// æ™®é€šå›¾ç‰‡çš„äº¤äº’å¢å¼º - ç§»åŠ¨ç«¯ä»…å¯ç”¨ç®€å•é¢„è§ˆ
(function() {
    'use strict';
    
    const debug = window.MobileDebug;
    
    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                     window.innerWidth <= 768;
    
    function enhanceRegularImages() {
        try {
            debug.startTimer('image-enhancement');
            debug.log('å¼€å§‹å¢å¼ºå›¾ç‰‡äº¤äº’åŠŸèƒ½');
            
            // ç§»åŠ¨ç«¯ä¸æ·»åŠ å¤æ‚çš„äº¤äº’åŠŸèƒ½ï¼Œä»…æ·»åŠ ç‚¹å‡»å…¨å±æŸ¥çœ‹
            const contentImages = document.querySelectorAll('.post-content img, .page-content img, article img');
            debug.log(`æ‰¾åˆ°${contentImages.length}ä¸ªå†…å®¹å›¾ç‰‡`);
            
            let enhancedCount = 0;
            const maxEnhance = isMobile ? 20 : 50; // ç§»åŠ¨ç«¯é™åˆ¶å¢å¼ºæ•°é‡
            
            contentImages.forEach(function(img, index) {
                try {
                    // è·³è¿‡å·²ç»å¤„ç†è¿‡çš„å›¾ç‰‡
                    if (img.classList.contains('image-enhanced')) {
                        debug.debug(`å›¾ç‰‡ ${index + 1} å·²å¤„ç†ï¼Œè·³è¿‡`);
                        return;
                    }
                    
                    // è¶…è¿‡é™åˆ¶åˆ™è·³è¿‡
                    if (enhancedCount >= maxEnhance) {
                        debug.debug(`å·²è¾¾åˆ°å¢å¼ºé™åˆ¶ ${maxEnhance}ï¼Œè·³è¿‡å‰©ä½™å›¾ç‰‡`);
                        return;
                    }
                    
                    img.classList.add('image-enhanced');
                    enhancedCount++;
                    
                    // ç§»åŠ¨ç«¯ï¼šä»…æ·»åŠ ç‚¹å‡»å…¨å±åŠŸèƒ½
                    if (isMobile) {
                        img.style.cursor = 'pointer';
                        img.addEventListener('click', function() {
                            showFullscreen(this.src, this.alt);
                        }, { passive: true, once: false });
                        return;
                    }
            
            // åˆ›å»ºå›¾ç‰‡å®¹å™¨
            const container = document.createElement('div');
            container.className = 'enhanced-image-container';
            container.style.cssText = `
                position: relative;
                display: inline-block;
                max-width: 100%;
                overflow: hidden;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
                cursor: grab;
                user-select: none;
            `;
            
            // åŒ…è£…å›¾ç‰‡
            img.parentNode.insertBefore(container, img);
            container.appendChild(img);
            
            // åˆ›å»ºæ§åˆ¶æŒ‰é’®
            const controls = document.createElement('div');
            controls.className = 'image-controls';
            controls.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                display: flex;
                gap: 5px;
                opacity: 0;
                transition: opacity 0.3s ease;
                z-index: 10;
            `;
            
            const zoomInBtn = createControlButton('+', 'æ”¾å¤§');
            const zoomOutBtn = createControlButton('âˆ’', 'ç¼©å°');
            const resetBtn = createControlButton('âŒ‚', 'é‡ç½®');
            const fullscreenBtn = createControlButton('â›¶', 'å…¨å±æŸ¥çœ‹');
            
            controls.appendChild(zoomInBtn);
            controls.appendChild(zoomOutBtn);
            controls.appendChild(resetBtn);
            controls.appendChild(fullscreenBtn);
            container.appendChild(controls);
            
            // æ˜¾ç¤º/éšè—æ§åˆ¶æŒ‰é’®
            container.addEventListener('mouseenter', () => {
                controls.style.opacity = '1';
            });
            container.addEventListener('mouseleave', () => {
                controls.style.opacity = '0';
            });
            
            // å›¾ç‰‡äº¤äº’åŠŸèƒ½
            let currentScale = 1;
            let translateX = 0, translateY = 0;
            let isDragging = false;
            let startX, startY;
            
            const minScale = 0.5;
            const maxScale = 4;
            const scaleStep = 0.25; // é™ä½ç¼©æ”¾æ­¥é•¿ï¼Œå‡å°‘æ•æ„Ÿåº¦
            
            function updateTransform() {
                img.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
                img.style.transformOrigin = 'center center';
                img.style.transition = isDragging ? 'none' : 'transform 0.3s ease';
            }
            
            function updateScale(scale) {
                currentScale = Math.max(minScale, Math.min(maxScale, scale));
                updateTransform();
            }
            
            // ç¼©æ”¾æ§åˆ¶
            zoomInBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                updateScale(currentScale + scaleStep);
            });
            
            zoomOutBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                updateScale(currentScale - scaleStep);
            });
            
            resetBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                currentScale = 1;
                translateX = translateY = 0;
                updateTransform();
            });
            
            // å…¨å±æŸ¥çœ‹
            fullscreenBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showFullscreen(img.src, img.alt);
            });
            
            // æ»šè½®ç¼©æ”¾ - é™ä½æ•æ„Ÿåº¦
            let wheelTimeout;
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                // é˜²æŠ–å¤„ç†ï¼Œé™ä½æ•æ„Ÿåº¦
                if (wheelTimeout) return;
                wheelTimeout = setTimeout(() => wheelTimeout = null, 100);
                
                const delta = e.deltaY > 0 ? -scaleStep * 0.3 : scaleStep * 0.3; // è¿›ä¸€æ­¥é™ä½æ•æ„Ÿåº¦
                updateScale(currentScale + delta);
            });
            
            // æ‹–æ‹½åŠŸèƒ½
            container.addEventListener('mousedown', (e) => {
                if (e.target !== img && !e.target.closest('.image-controls')) {
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    container.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                translateX = (e.clientX - startX) / currentScale; // è€ƒè™‘ç¼©æ”¾æ¯”ä¾‹
                translateY = (e.clientY - startY) / currentScale;
                updateTransform();
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    container.style.cursor = 'grab';
                }
            });
            
            // è§¦æ‘¸æ‹–æ‹½æ”¯æŒ
            let touchStartX, touchStartY;
            
            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    touchStartX = touch.clientX - translateX;
                    touchStartY = touch.clientY - translateY;
                }
            });
            
            container.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    translateX = (touch.clientX - touchStartX) / currentScale;
                    translateY = (touch.clientY - touchStartY) / currentScale;
                    updateTransform();
                }
            });
            
            // åŒå‡»é‡ç½®
            container.addEventListener('dblclick', () => {
                currentScale = 1;
                translateX = translateY = 0;
                updateTransform();
            });
            
                } catch (e) {
                    debug.warn(`å¢å¼ºå›¾ç‰‡ ${index + 1} å¤±è´¥`, e, {
                        src: img.src,
                        alt: img.alt
                    });
                }
            });
            
            debug.log(`å›¾ç‰‡å¢å¼ºå®Œæˆï¼ŒæˆåŠŸ: ${enhancedCount}/${contentImages.length}`);
            debug.endTimer('image-enhancement', { enhanced: enhancedCount, total: contentImages.length });
            
        } catch (e) {
            debug.error('å›¾ç‰‡å¢å¼ºåŠŸèƒ½å¤±è´¥', e);
        }
    }
    
    function createControlButton(text, title) {
        const btn = document.createElement('button');
        btn.innerHTML = text;
        btn.title = title;
        btn.style.cssText = `
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
        `;
        
        btn.addEventListener('mouseenter', () => {
            btn.style.background = 'rgba(0, 0, 0, 0.9)';
            btn.style.transform = 'scale(1.1)';
        });
        
        btn.addEventListener('mouseleave', () => {
            btn.style.background = 'rgba(0, 0, 0, 0.7)';
            btn.style.transform = 'scale(1)';
        });
        
        return btn;
    }
    
    function showFullscreen(src, alt) {
        try {
            debug.debug('æ˜¾ç¤ºå…¨å±å›¾ç‰‡', { src, alt });
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = src;
            img.alt = alt;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            `;
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            backdrop-filter: blur(5px);
        `;
        
        overlay.appendChild(img);
        overlay.appendChild(closeBtn);
        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';
        
        function closeFullscreen() {
            overlay.remove();
            document.body.style.overflow = '';
        }
        
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeFullscreen();
        });
        
        closeBtn.addEventListener('click', closeFullscreen);
        
        document.addEventListener('keydown', function escHandler(e) {
            if (e.key === 'Escape') {
                closeFullscreen();
                document.removeEventListener('keydown', escHandler);
            }
        });
        
        debug.debug('å…¨å±å›¾ç‰‡æ˜¾ç¤ºæˆåŠŸ');
        
        } catch (e) {
            debug.error('æ˜¾ç¤ºå…¨å±å›¾ç‰‡å¤±è´¥', e);
        }
    }
    
    // åˆå§‹åŒ–å‡½æ•°ï¼šåŒ…å«å›¾ç‰‡å¢å¼ºå’ŒMutationObserverè®¾ç½®
    function initImageEnhancements() {
        try {
            // é¦–å…ˆå¢å¼ºç°æœ‰å›¾ç‰‡
            enhanceRegularImages();
            
            // æ¡Œé¢ç«¯ï¼šè®¾ç½®MutationObserverç›‘å¬æ–°å¢å›¾ç‰‡
            if (!isMobile) {
                try {
                    // ç¡®ä¿document.bodyå­˜åœ¨
                    if (!document.body) {
                        debug.warn('document.bodyä¸å­˜åœ¨ï¼Œè·³è¿‡MutationObserver');
                        return;
                    }
                    
                    let observerTimeout;
                    const observer = new MutationObserver(function(mutations) {
                        try {
                            // ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹è§¦å‘
                            clearTimeout(observerTimeout);
                            observerTimeout = setTimeout(function() {
                                const hasNewImages = mutations.some(function(mutation) {
                                    return mutation.type === 'childList' && 
                                           Array.from(mutation.addedNodes).some(function(node) {
                                               return node.nodeType === 1 && 
                                                      (node.tagName === 'IMG' || node.querySelector('img'));
                                           });
                                });
                                
                                if (hasNewImages) {
                                    debug.debug('æ£€æµ‹åˆ°æ–°å›¾ç‰‡ï¼Œå‡†å¤‡å¢å¼º');
                                    enhanceRegularImages();
                                }
                            }, 500);
                        } catch (e) {
                            debug.error('MutationObserverå›è°ƒå¤±è´¥', e);
                        }
                    });
                    
                    // å†æ¬¡ç¡®è®¤document.bodyå­˜åœ¨
                    if (document.body) {
                        observer.observe(document.body, {
                            childList: true,
                            subtree: true
                        });
                        debug.log('å›¾ç‰‡åŠ¨æ€ç›‘æ§å·²å¯åŠ¨ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰');
                    } else {
                        debug.warn('document.bodyåœ¨è§‚å¯Ÿæ—¶ä¸å­˜åœ¨');
                    }
                } catch (e) {
                    debug.error('å¯åŠ¨å›¾ç‰‡åŠ¨æ€ç›‘æ§å¤±è´¥', e);
                }
            } else {
                debug.log('ç§»åŠ¨ç«¯è·³è¿‡MutationObserverï¼Œé¿å…æ€§èƒ½é—®é¢˜');
            }
        } catch (e) {
            debug.error('åˆå§‹åŒ–å›¾ç‰‡å¢å¼ºåŠŸèƒ½å¤±è´¥', e);
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œ
    try {
        if (document.readyState === 'loading') {
            debug.debug('ç­‰å¾…DOMContentLoadedåå¯åŠ¨å›¾ç‰‡å¢å¼º');
            document.addEventListener('DOMContentLoaded', initImageEnhancements);
        } else {
            debug.debug('DOMå·²å°±ç»ªï¼Œç«‹å³å¯åŠ¨å›¾ç‰‡å¢å¼º');
            initImageEnhancements();
        }
    } catch (e) {
        debug.error('å¯åŠ¨å›¾ç‰‡å¢å¼ºå¤±è´¥', e);
    }
})();
</script>
