{{- define "main" }}

{{- if (and site.Params.profileMode.enabled .IsHome) }}
{{- partial "index_profile.html" . }}
{{- else }} {{/* if not profileMode */}}

{{- if and .IsHome site.Params.homeInfoParams }}
{{- partial "home_info.html" . }}
{{- end }}

{{/* 文章类目展示 */}}
{{- if .IsHome }}
<div class="categories-section">
  <header class="categories-header">
    <h2>📚 文章类目</h2>
    <p>按技术领域分类的文章集合</p>
  </header>
  
  {{- $categories := dict }}
  {{- $categoryDisplayNames := dict }}
  {{- range site.RegularPages }}
    {{- if eq .Type "posts" }}
      {{- $filename := path.BaseName .File.Path }}
      {{- $parts := split $filename "-" }}
      {{- if gt (len $parts) 1 }}
        {{- $categoryRaw := index $parts 0 }}
        {{- $category := lower $categoryRaw }}
        {{- $posts := index $categories $category | default slice }}
        {{- $posts = $posts | append . }}
        {{- $categories = merge $categories (dict $category $posts) }}
        {{- $categoryDisplayNames = merge $categoryDisplayNames (dict $category $categoryRaw) }}
      {{- end }}
    {{- end }}
  {{- end }}
  
  <div class="categories-grid">
    {{- $categoryOrder := slice "ai应用" "voicehelper" "dify" "langchain" "langgraph"  "autogpt" "autogen" "openaiagent"  "eino" "githubmcpserver" "metagpt" "pgvector" "milvus" "vllm" "tensorrt" "pytorch" "tensorflow" "python" "golang"  "kubernetes" "docker" "mongodb" "mysql" "elasticsearch"  "kafka" "kitex" "kratos" "fastapi" "grpc"  "nginx" "flink" "pulsar"  "etcd" "istio" "envoy"  "clickhouse" "rocksdb"  "ceph"  "leveldb" "netpoll" "ray" "qwenagent" "minio" "voicehelper"}}
    {{- range $categoryOrder }}
      {{- $category := . }}
      {{- $posts := index $categories $category }}
      {{- if $posts }}
        {{- $postCount := len $posts }}
    <div class="category-card">
      <div class="category-header">
        <h3 class="category-title">
          <a href="/categories/{{ $category | urlize }}/">{{ index $categoryDisplayNames $category | default $category }}</a>
        </h3>
        <span class="category-count">{{ $postCount }} 篇文章</span>
      </div>
      <div class="category-description">
        {{- if eq $category "ai应用" }}
        <p>🎤 智能语音助手系统 - Home Assistant、LiveKit、fastchat实时语音处理技术栈</p>
        {{- else if eq $category "dify" }}
          <p>🤖 Dify低代码LLM应用开发平台 - 工作流引擎架构与核心模块源码深度剖析</p>
        {{- else if eq $category "autogpt" }}
          <p>🚀 AutoGPT自主智能体 - Block系统架构与Plugin生态源码分析</p>
        {{- else if eq $category "autogen" }}
          <p>🔄 Microsoft AutoGen - 多智能体协作框架与对话编排机制深度解析</p>
        {{- else if eq $category "openaiagent" }}
          <p>🧠 OpenAI Agent开发实战 - Function Calling与Tool Use最佳实践</p>
        {{- else if eq $category "qwenagent" }}
          <p>🤖 阿里通义千问智能体 - ReAct推理与工具调用框架技术实现</p>
        {{- else if eq $category "eino" }}
          <p>⚡ 字节跳动Eino框架 - 企业级大模型应用开发与部署实践</p>
        {{- else if eq $category "githubmcpserver" }}
          <p>🔧 GitHub MCP服务器 - Model Context Protocol协议实现与集成方案</p>
        {{- else if eq $category "langgraph" }}
          <p>📊 LangGraph状态图引擎 - 复杂AI工作流编排与执行控制机制</p>
        {{- else if eq $category "langchain" }}
          <p>🔗 LangChain应用框架 - Chain组合模式与Memory管理核心架构</p>
        {{- else if eq $category "metagpt" }}
          <p>🎯 MetaGPT软件开发框架 - 多角色协作与代码生成流水线设计</p>
        {{- else if eq $category "vllm" }}
          <p>⚡ vLLM推理加速引擎 - PagedAttention与连续批处理优化技术</p>
        {{- else if eq $category "tensorrt" }}
          <p>🚄 NVIDIA TensorRT-LLM - GPU推理优化与模型量化部署实践</p>
        {{- else if eq $category "python" }}
          <p>🐍 Python深度解析 - CPython解释器内核、GIL机制与内存管理源码剖析</p>
        {{- else if eq $category "golang" }}
          <p>🐹 Go语言内核技术 - Runtime调度器、垃圾回收器与并发原语实现机制</p>
        {{- else if eq $category "tensorflow" }}
          <p>🧮 TensorFlow深度学习 - 计算图执行引擎与分布式训练架构源码分析</p>
        {{- else if eq $category "ray" }}
          <p>☀️ Ray分布式计算 - 任务调度系统与Actor模型核心架构设计</p>
        {{- else if eq $category "fastapi" }}
          <p>🚀 FastAPI高性能框架 - ASGI异步架构与依赖注入系统源码深度解析</p>
        {{- else if eq $category "grpc" }}
          <p>📡 gRPC通信框架 - Protobuf序列化与HTTP/2双向流传输机制剖析</p>
        {{- else if eq $category "kitex" }}
          <p>🛠️ 字节跳动Kitex - 微服务治理与高性能RPC框架设计实践</p>
        {{- else if eq $category "nginx" }}
          <p>🌐 Nginx高性能服务器 - 事件驱动架构与反向代理核心模块源码分析</p>
        {{- else if eq $category "kafka" }}
          <p>🔄 Apache Kafka消息系统 - 分区存储引擎与Raft一致性协议实现机制</p>
        {{- else if eq $category "flink" }}
          <p>🌊 Apache Flink流计算 - JobManager调度与TaskManager执行引擎架构</p>
        {{- else if eq $category "pulsar" }}
          <p>📨 Apache Pulsar消息平台 - BookKeeper存储层与Broker架构深度分析</p>
        {{- else if eq $category "kubernetes" }}
          <p>☸️ Kubernetes容器编排 - APIServer、调度器与控制器模式源码解析</p>
        {{- else if eq $category "docker" }}
          <p>🐳 Docker容器技术 - 容器运行时、镜像存储与网络模型底层实现</p>
        {{- else if eq $category "etcd" }}
          <p>🗄️ etcd分布式存储 - Raft共识算法与MVCC并发控制机制深度剖析</p>
        {{- else if eq $category "istio" }}
          <p>🕸️ Istio服务网格 - Envoy数据平面与Pilot控制平面交互机制</p>
        {{- else if eq $category "envoy" }}
          <p>🔀 Envoy代理服务器 - 过滤器链架构与L7负载均衡算法实现</p>
        {{- else if eq $category "mongodb" }}
          <p>🍃 MongoDB文档数据库 - WiredTiger存储引擎与分片集群架构原理</p>
        {{- else if eq $category "mysql" }}
          <p>🐬 MySQL数据库内核 - InnoDB存储引擎与查询优化器源码深度解析</p>
        {{- else if eq $category "clickhouse" }}
          <p>⚡ ClickHouse列式数据库 - MergeTree引擎与分布式查询执行机制</p>
        {{- else if eq $category "rocksdb" }}
          <p>🗿 RocksDB存储引擎 - LSM-Tree架构与压缩合并策略核心算法剖析</p>
        {{- else if eq $category "leveldb" }}
          <p>📚 LevelDB键值存储 - SSTable结构设计与Bloom Filter优化技术</p>
        {{- else if eq $category "pgvector" }}
          <p>🔍 pgvector向量扩展 - PostgreSQL向量检索与HNSW索引算法实现</p>
        {{- else if eq $category "milvus" }}
          <p>🧭 Milvus向量数据库 - 分布式向量检索与AI原生存储架构设计</p>
        {{- else if eq $category "ceph" }}
          <p>🗂️ Ceph分布式存储 - CRUSH算法与OSD存储节点管理机制深度解析</p>
        {{- else if eq $category "minio" }}
          <p>📦 MinIO对象存储 - S3兼容API与纠删码数据保护技术实现</p>
        {{- else if eq $category "elasticsearch" }}
          <p>🔎 Elasticsearch搜索引擎 - Lucene倒排索引与分布式查询协调机制</p>
        {{- else if eq $category "netpoll" }}
          <p>🌐 字节跳动NetPoll - 高性能网络库与epoll事件驱动架构优化</p>
        {{- else if eq $category "kratos" }}
          <p>🤖 Kratos微服务框架 - 微服务治理与分布式系统架构设计</p>
        {{- else if eq $category "voicehelper" }}
          <p>🤖 VoiceHelper - 语音助手框架与实时语音处理技术栈</p>
        {{- else }}
          <p>📖 {{ $category }} 相关技术文档和源码分析</p>
        {{- end }}
      </div>
      <div class="category-posts">
        <div class="recent-posts">
          <h4>最新文章</h4>
          <ul>
            {{- range first 3 (sort $posts "Date" "desc") }}
            <li>
              <a href="{{ .Permalink }}" title="{{ .Title }}">
                {{ .Title | truncate 50 }}
              </a>
              <time>{{ .Date.Format "01-02" }}</time>
            </li>
            {{- end }}
          </ul>
          {{- if gt $postCount 3 }}
          <a href="/categories/{{ $category | urlize }}/" class="view-all">查看全部 {{ $postCount }} 篇 →</a>
          {{- end }}
        </div>
      </div>
    </div>
      {{- end }}
    {{- end }}
    
    {{/* 显示其他未在优先级列表中的分类 */}}
    {{- range $category, $posts := $categories }}
      {{- $isInOrder := false }}
      {{- range $categoryOrder }}
        {{- if eq . $category }}
          {{- $isInOrder = true }}
        {{- end }}
      {{- end }}
      {{- if not $isInOrder }}
        {{- $postCount := len $posts }}
    <div class="category-card">
      <div class="category-header">
        <h3 class="category-title">
          <a href="/categories/{{ $category | urlize }}/">{{ index $categoryDisplayNames $category | default $category }}</a>
        </h3>
        <span class="category-count">{{ $postCount }} 篇文章</span>
      </div>
      <div class="category-description">
        <p>{{ if eq $category "语音助手" }}AI应用{{ else if eq $category "聊天助手" }}AI聊天助手{{ else }}{{ $category }}{{ end }} 相关技术文档和源码分析</p>
      </div>
      <div class="category-posts">
        <div class="recent-posts">
          <h4>最新文章</h4>
          <ul>
            {{- range first 3 (sort $posts "Date" "desc") }}
            <li>
              <a href="{{ .Permalink }}" title="{{ .Title }}">
                {{ .Title | truncate 50 }}
              </a>
              <time>{{ .Date.Format "01-02" }}</time>
            </li>
            {{- end }}
          </ul>
          {{- if gt $postCount 3 }}
          <a href="/categories/{{ $category | urlize }}/" class="view-all">查看全部 {{ $postCount }} 篇 →</a>
          {{- end }}
        </div>
      </div>
    </div>
      {{- end }}
    {{- end }}
  </div>
</div>
{{- end }}

{{/* 最新文章列表 */}}
{{- $pages := where site.RegularPages "Type" "in" site.Params.mainSections }}
{{- $pages = where $pages "Params.hiddenInHomeList" "!=" "true"  }}
{{- $paginator := .Paginate (first 10 $pages) }}

<div class="recent-posts-section">
  <header class="section-header">
    <h2>📝 最新文章</h2>
  </header>
  
  {{- range $index, $page := $paginator.Pages }}
  <article class="post-entry">
    {{- $isHidden := (.Param "cover.hiddenInList") | default (.Param "cover.hidden") | default false }}
    {{- partial "cover.html" (dict "cxt" . "IsSingle" false "isHidden" $isHidden) }}
    <header class="entry-header">
      <h2 class="entry-hint-parent">
        {{- .Title }}
        {{- if .Draft }}
        <span class="entry-hint" title="Draft">
          <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" fill="currentColor">
            <path d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
          </svg>
        </span>
        {{- end }}
      </h2>
    </header>
    {{- if (ne (.Param "hideSummary") true) }}
    <div class="entry-content">
      <p>{{ .Summary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}</p>
    </div>
    {{- end }}
    {{- if not (.Param "hideMeta") }}
    <footer class="entry-footer">
      {{- partial "post_meta.html" . -}}
    </footer>
    {{- end }}
    <a class="entry-link" aria-label="post link to {{ .Title | plainify }}" href="{{ .Permalink }}"></a>
  </article>
  {{- end }}
  
  <div class="view-more">
    <a href="/archives/" class="view-all-posts">查看所有文章 →</a>
  </div>
</div>

{{- end }}{{/* end profileMode */}}

{{- end }}{{- /* end main */ -}}
